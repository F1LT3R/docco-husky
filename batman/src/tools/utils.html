 <!DOCTYPE html>  <html> <head>   <title>utils.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="../../docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">             <a class="source" href="../../readme.html">               <span class="file_name">README</span>             </a>                                           <a class="source " href="../../src/batman.html">                 <span class="base_path">src / </span><span class="file_name">batman.coffee</span>               </a>                                           <a class="source " href="../../src/batman.jquery.html">                 <span class="base_path">src / </span><span class="file_name">batman.jquery.coffee</span>               </a>                                           <a class="source " href="../../src/batman.node.html">                 <span class="base_path">src / </span><span class="file_name">batman.node.coffee</span>               </a>                                           <a class="source " href="../../src/batman.solo.html">                 <span class="base_path">src / </span><span class="file_name">batman.solo.coffee</span>               </a>                                           <a class="source " href="../../src/extras/batman.i18n.html">                 <span class="base_path">src / extras / </span><span class="file_name">batman.i18n.coffee</span>               </a>                                           <a class="source " href="../../src/extras/batman.rails.html">                 <span class="base_path">src / extras / </span><span class="file_name">batman.rails.coffee</span>               </a>                                           <a class="source " href="../../src/tools/batman.html">                 <span class="base_path">src / tools / </span><span class="file_name">batman.coffee</span>               </a>                                           <a class="source " href="../../src/tools/build/remove_development_transform.html">                 <span class="base_path">src / tools / build / </span><span class="file_name">remove_development_transform.coffee</span>               </a>                                           <a class="source " href="../../src/tools/generator.html">                 <span class="base_path">src / tools / </span><span class="file_name">generator.coffee</span>               </a>                                           <a class="source " href="../../src/tools/server.html">                 <span class="base_path">src / tools / </span><span class="file_name">server.coffee</span>               </a>                                           <a class="source selected" href="../../src/tools/utils.html">                 <span class="base_path">src / tools / </span><span class="file_name">utils.coffee</span>               </a>                                           <a class="source " href="../../tools/build/remove_development_transform.html">                 <span class="base_path">tools / build / </span><span class="file_name">remove_development_transform.js</span>               </a>                                           <a class="source " href="../../tools/cli.html">                 <span class="base_path">tools / </span><span class="file_name">cli.js</span>               </a>                                           <a class="source " href="../../tools/framework.html">                 <span class="base_path">tools / </span><span class="file_name">framework.js</span>               </a>                                           <a class="source " href="../../tools/generator.html">                 <span class="base_path">tools / </span><span class="file_name">generator.js</span>               </a>                                           <a class="source " href="../../tools/server.html">                 <span class="base_path">tools / </span><span class="file_name">server.js</span>               </a>                                           <a class="source " href="../../tools/server_utils.html">                 <span class="base_path">tools / </span><span class="file_name">server_utils.js</span>               </a>                                           <a class="source " href="../../tools/templates/app/$app$.html">                 <span class="base_path">tools / templates / app / </span><span class="file_name">$app$.coffee</span>               </a>                                           <a class="source " href="../../tools/templates/app/controllers/app_controller.html">                 <span class="base_path">tools / templates / app / controllers / </span><span class="file_name">app_controller.coffee</span>               </a>                                           <a class="source " href="../../tools/templates/controller/controllers/$name$_controller.html">                 <span class="base_path">tools / templates / controller / controllers / </span><span class="file_name">$name$_controller.coffee</span>               </a>                                           <a class="source " href="../../tools/templates/model/models/$name$.html">                 <span class="base_path">tools / templates / model / models / </span><span class="file_name">$name$.coffee</span>               </a>                                           <a class="source " href="../../tools/utils.html">                 <span class="base_path">tools / </span><span class="file_name">utils.js</span>               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               utils.coffee             </h1>             <div class="filepath">src/tools/</div>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>utils.coffee
batman.js</p>

<p>Created by Nick Small
Copyright 2011, Shopify</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">connect = </span><span class="nx">require</span> <span class="s1">&#39;connect&#39;</span>
<span class="nv">path    = </span><span class="nx">require</span> <span class="s1">&#39;path&#39;</span>
<span class="nv">fs      = </span><span class="nx">require</span> <span class="s1">&#39;fs&#39;</span>
<span class="nv">cli     = </span><span class="nx">require</span> <span class="s1">&#39;./cli&#39;</span>
<span class="nv">parse = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">).</span><span class="nx">parse</span>
<span class="nv">cache = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Recursive mkdir (creates all nonexistent path segments)
Lifted from https://github.com/bpedro/node-fs
Copyright 2010 Bruno Pedro
MIT Licensed</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.mkdir_p = mkdir_p = </span><span class="nf">(path, mode, callback, position) -&gt;</span>
  <span class="nv">mode = </span><span class="nx">mode</span> <span class="o">or</span> <span class="nx">process</span><span class="p">.</span><span class="nx">umask</span><span class="p">()</span>
  <span class="nv">position = </span><span class="nx">position</span> <span class="o">or</span> <span class="mi">0</span>
  <span class="nv">parts = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">).</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">path</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">position</span> <span class="o">&gt;=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">if</span> <span class="nx">callback</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="kc">true</span>
  <span class="nv">directory = </span><span class="nx">parts</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">position</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="s2">&quot;/&quot;</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">directory</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">null</span>
      <span class="nx">mkdir_p</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">position</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdir</span> <span class="nx">directory</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">and</span> <span class="nx">err</span><span class="p">.</span><span class="nx">errno</span> <span class="o">!=</span> <span class="mi">17</span>
          <span class="k">if</span> <span class="nx">callback</span>
            <span class="nx">callback</span> <span class="nx">err</span>
          <span class="k">else</span>
            <span class="k">throw</span> <span class="nx">err</span>
        <span class="k">else</span>
          <span class="nx">mkdir_p</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">position</span> <span class="o">+</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>CoffeeScript on the fly compiler
Heavily based on connect/lib/middlewares/compiler.js
Copyright(c) 2010 Sencha Inc.
Copyright(c) 2011 TJ Holowaychuk
MIT Licensed
Modified to compile to a tertiary location, but still serve from the s/js/coffee path
Example: /models/user.js is requested.
 * Compiler will check /build/models/user.js to see if it exists
 * If so, check the mtime, serve it if its up to date
 * If not, recompile from /models/user.coffee, and serve it.
Note that /build/modules/user.js is never requested.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.CoffeeCompiler = </span><span class="nf">(options) -&gt;</span>
  <span class="nv">options = </span><span class="nx">options</span> <span class="o">or</span> <span class="p">{}</span>
  <span class="nv">srcDir = </span><span class="nx">options</span><span class="p">.</span><span class="nx">src</span> <span class="o">or</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span>
  <span class="nv">destDir = </span><span class="nx">options</span><span class="p">.</span><span class="nx">dest</span> <span class="o">or</span> <span class="nx">srcDir</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Return a connect middleware</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">return</span> <span class="nf">(req, res, next) -&gt;</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>  <span class="nx">unless</span> <span class="s2">&quot;GET&quot;</span> <span class="o">==</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span>
    <span class="nv">pathname = </span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">pathname</span>

    <span class="nv">compiler =</span>
      <span class="nv">match: </span><span class="sr">/\.js$/</span>
      <span class="nv">ext: </span><span class="s2">&quot;.coffee&quot;</span>
      <span class="nv">compile: </span><span class="nf">(str, fn) -&gt;</span>
        <span class="nv">coffee = </span><span class="nx">cache</span><span class="p">.</span><span class="nx">coffee</span> <span class="o">or</span> <span class="p">(</span><span class="nv">cache.coffee = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;coffee-script&quot;</span><span class="p">))</span>
        <span class="k">try</span>
          <span class="nx">fn</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">coffee</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
        <span class="k">catch</span> <span class="nx">err</span>
          <span class="nx">fn</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Function to compile src to dest, no questions asked. Fills in missing directories with <code>mkdir_p</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">compile = </span><span class="nf">(src, dest, next) -&gt;</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">src</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">,</span> <span class="nf">(err, str) -&gt;</span>
        <span class="k">if</span> <span class="nx">err</span>
          <span class="nx">next</span> <span class="nx">err</span>
        <span class="k">else</span>
          <span class="nx">compiler</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">str</span><span class="p">,</span> <span class="nf">(err, str) -&gt;</span>
            <span class="k">if</span> <span class="nx">err</span>
              <span class="nx">next</span> <span class="nx">err</span>
            <span class="k">else</span>
              <span class="nx">mkdir_p</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">dest</span><span class="p">),</span> <span class="mi">0755</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
                <span class="k">if</span> <span class="nx">err</span>
                  <span class="nx">next</span> <span class="nx">err</span>
                <span class="k">else</span>
                  <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span> <span class="nx">dest</span><span class="p">,</span> <span class="nx">str</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
                    <span class="nx">next</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Test the path to see if it can be compiled</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">compiler</span><span class="p">.</span><span class="nx">match</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">pathname</span><span class="p">)</span>
      <span class="nv">src = </span><span class="p">(</span><span class="nx">srcDir</span> <span class="o">+</span> <span class="nx">pathname</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">compiler</span><span class="p">.</span><span class="nx">match</span><span class="p">,</span> <span class="nx">compiler</span><span class="p">.</span><span class="nx">ext</span><span class="p">)</span>
      <span class="nv">dest = </span><span class="nx">destDir</span> <span class="o">+</span> <span class="nx">pathname</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Get a handy function for piping the compiled file out using connect's static middleware. We use this
so we get handy things like range support, proper mimetyping, and all the other goodness baked in there.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">send = </span><span class="nf">(err) -&gt;</span>
        <span class="k">if</span> <span class="nx">err</span><span class="o">?</span>
          <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">connect</span><span class="p">.</span><span class="nx">static</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="p">{</span><span class="nv">path: </span><span class="nx">dest</span><span class="p">})</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>See if the source exists. If it doesn't, we aren't going to compile, so just move on to the next middleware
in the stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">src</span><span class="p">,</span> <span class="nf">(err, srcStats) -&gt;</span>
        <span class="k">if</span> <span class="nx">err</span>
          <span class="k">if</span> <span class="s2">&quot;ENOENT&quot;</span> <span class="o">==</span> <span class="nx">err</span><span class="p">.</span><span class="nx">code</span>
            <span class="nx">next</span><span class="p">()</span>
          <span class="k">else</span>
            <span class="nx">next</span> <span class="nx">err</span>
        <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>If the source does exist, check to see if we've compiled it before. If we have, ensure its up to date
by checking the modified times of the source and destination. Compile if the source is newer, and then
send.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">dest</span><span class="p">,</span> <span class="nf">(err, destStats) -&gt;</span>
            <span class="k">if</span> <span class="nx">err</span>
              <span class="k">if</span> <span class="s2">&quot;ENOENT&quot;</span> <span class="o">==</span> <span class="nx">err</span><span class="p">.</span><span class="nx">code</span>
                <span class="nx">compile</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">dest</span><span class="p">,</span> <span class="nx">send</span>
              <span class="k">else</span>
                <span class="nx">next</span> <span class="nx">err</span>
            <span class="k">else</span>
              <span class="k">if</span> <span class="nx">srcStats</span><span class="p">.</span><span class="nx">mtime</span> <span class="o">&gt;</span> <span class="nx">destStats</span><span class="p">.</span><span class="nx">mtime</span>
                <span class="nx">compile</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">dest</span><span class="p">,</span> <span class="nx">send</span>
              <span class="k">else</span>
                <span class="nx">send</span><span class="p">()</span>
      <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Move on to the next middleware if we can't deal with this request.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">next</span><span class="p">()</span>

<span class="nv">exports.getConfig = </span><span class="p">(</span><span class="o">-&gt;</span>
  <span class="k">try</span>
    <span class="nv">json = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">(),</span> <span class="s1">&#39;package.json&#39;</span><span class="p">)).</span><span class="nx">toString</span><span class="p">().</span><span class="nx">trim</span><span class="p">()</span>
    <span class="nv">jsonOptions = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">jsonOptions</span><span class="p">.</span><span class="nx">batman</span>
  <span class="k">catch</span> <span class="nx">e</span>
    <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">is</span> <span class="s1">&#39;EBADF&#39;</span>
      <span class="nx">@fatal</span> <span class="s1">&#39;Couldn\&#39;t find your Batman project configuration! Please put it in your package.json under the batman key.&#39;</span>
    <span class="k">else</span>
      <span class="k">throw</span> <span class="nx">e</span>
<span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="nx">cli</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>          <div id="projectname"><a href="../../readme.html">batman.js</a></div>        </div> </body> </html>  