 <!DOCTYPE html>  <html> <head>   <title>batman.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="../docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">             <a class="source" href="../readme.html">               <span class="file_name">README</span>             </a>                                           <a class="source selected" href="../src/batman.html">                 <span class="base_path">src / </span><span class="file_name">batman.coffee</span>               </a>                                           <a class="source " href="../src/batman.jquery.html">                 <span class="base_path">src / </span><span class="file_name">batman.jquery.coffee</span>               </a>                                           <a class="source " href="../src/batman.node.html">                 <span class="base_path">src / </span><span class="file_name">batman.node.coffee</span>               </a>                                           <a class="source " href="../src/batman.solo.html">                 <span class="base_path">src / </span><span class="file_name">batman.solo.coffee</span>               </a>                                           <a class="source " href="../src/extras/batman.i18n.html">                 <span class="base_path">src / extras / </span><span class="file_name">batman.i18n.coffee</span>               </a>                                           <a class="source " href="../src/extras/batman.rails.html">                 <span class="base_path">src / extras / </span><span class="file_name">batman.rails.coffee</span>               </a>                                           <a class="source " href="../src/tools/batman.html">                 <span class="base_path">src / tools / </span><span class="file_name">batman.coffee</span>               </a>                                           <a class="source " href="../src/tools/build/remove_development_transform.html">                 <span class="base_path">src / tools / build / </span><span class="file_name">remove_development_transform.coffee</span>               </a>                                           <a class="source " href="../src/tools/generator.html">                 <span class="base_path">src / tools / </span><span class="file_name">generator.coffee</span>               </a>                                           <a class="source " href="../src/tools/server.html">                 <span class="base_path">src / tools / </span><span class="file_name">server.coffee</span>               </a>                                           <a class="source " href="../src/tools/utils.html">                 <span class="base_path">src / tools / </span><span class="file_name">utils.coffee</span>               </a>                                           <a class="source " href="../tools/build/remove_development_transform.html">                 <span class="base_path">tools / build / </span><span class="file_name">remove_development_transform.js</span>               </a>                                           <a class="source " href="../tools/cli.html">                 <span class="base_path">tools / </span><span class="file_name">cli.js</span>               </a>                                           <a class="source " href="../tools/framework.html">                 <span class="base_path">tools / </span><span class="file_name">framework.js</span>               </a>                                           <a class="source " href="../tools/generator.html">                 <span class="base_path">tools / </span><span class="file_name">generator.js</span>               </a>                                           <a class="source " href="../tools/server.html">                 <span class="base_path">tools / </span><span class="file_name">server.js</span>               </a>                                           <a class="source " href="../tools/server_utils.html">                 <span class="base_path">tools / </span><span class="file_name">server_utils.js</span>               </a>                                           <a class="source " href="../tools/templates/app/$app$.html">                 <span class="base_path">tools / templates / app / </span><span class="file_name">$app$.coffee</span>               </a>                                           <a class="source " href="../tools/templates/app/controllers/app_controller.html">                 <span class="base_path">tools / templates / app / controllers / </span><span class="file_name">app_controller.coffee</span>               </a>                                           <a class="source " href="../tools/templates/controller/controllers/$name$_controller.html">                 <span class="base_path">tools / templates / controller / controllers / </span><span class="file_name">$name$_controller.coffee</span>               </a>                                           <a class="source " href="../tools/templates/model/models/$name$.html">                 <span class="base_path">tools / templates / model / models / </span><span class="file_name">$name$.coffee</span>               </a>                                           <a class="source " href="../tools/utils.html">                 <span class="base_path">tools / </span><span class="file_name">utils.js</span>               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               batman.coffee             </h1>             <div class="filepath">src/</div>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>batman.js</p>

<p>Created by Nick Small
Copyright 2011, Shopify</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The global namespace, the <code>Batman</code> function will also create also create a new
instance of Batman.Object and mixin all arguments to it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman = </span><span class="nf">(mixins...) -&gt;</span>
  <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span> <span class="nx">mixins</span><span class="p">...</span>

<span class="nv">Batman.config =</span>
  <span class="nv">pathPrefix: </span><span class="s1">&#39;/&#39;</span>
  <span class="nv">usePushState: </span><span class="kc">no</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Global Helpers</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><code>$typeOf</code> returns a string that contains the built-in class of an object
like <code>String</code>, <code>Array</code>, or <code>Object</code>. Note that only <code>Object</code> will be returned for
the entire prototype chain.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.typeOf = $typeOf = </span><span class="nf">(object) -&gt;</span>
  <span class="k">return</span> <span class="s2">&quot;Undefined&quot;</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">object</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span>
  <span class="nx">_objectToString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Cache this function to skip property lookups.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_objectToString = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p><code>$mixin</code> applies every key from every argument after the first to the
first argument. If a mixin has an <code>initialize</code> method, it will be called in
the context of the <code>to</code> object, and it's key/values won't be applied.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.mixin = $mixin = </span><span class="nf">(to, mixins...) -&gt;</span>
  <span class="nv">hasSet = </span><span class="k">typeof</span> <span class="nx">to</span><span class="p">.</span><span class="nx">set</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>

  <span class="k">for</span> <span class="nx">mixin</span> <span class="k">in</span> <span class="nx">mixins</span>
    <span class="k">continue</span> <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">mixin</span><span class="p">)</span> <span class="o">isnt</span> <span class="s1">&#39;Object&#39;</span>

    <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">mixin</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="nx">key</span> <span class="k">in</span>  <span class="p">[</span><span class="s1">&#39;initialize&#39;</span><span class="p">,</span> <span class="s1">&#39;uninitialize&#39;</span><span class="p">,</span> <span class="s1">&#39;prototype&#39;</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">hasSet</span>
        <span class="nx">to</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">to</span><span class="p">.</span><span class="nx">nodeName</span><span class="o">?</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">data</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span>
      <span class="k">else</span>
        <span class="nx">to</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">mixin</span><span class="p">.</span><span class="nx">initialize</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nx">mixin</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="nx">to</span>

  <span class="nx">to</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><code>$unmixin</code> removes every key/value from every argument after the first
from the first argument. If a mixin has a <code>deinitialize</code> method, it will be
called in the context of the <code>from</code> object and won't be removed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.unmixin = $unmixin = </span><span class="nf">(from, mixins...) -&gt;</span>
  <span class="k">for</span> <span class="nx">mixin</span> <span class="k">in</span> <span class="nx">mixins</span>
    <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">mixin</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="nx">key</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;initialize&#39;</span><span class="p">,</span> <span class="s1">&#39;uninitialize&#39;</span><span class="p">]</span>

      <span class="k">delete</span> <span class="nx">from</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>

    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">mixin</span><span class="p">.</span><span class="nx">uninitialize</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nx">mixin</span><span class="p">.</span><span class="nx">uninitialize</span><span class="p">.</span><span class="nx">call</span> <span class="nx">from</span>

  <span class="nx">from</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><code>$block</code> takes in a function and returns a function which can either
  A) take a callback as its last argument as it would normally, or
  B) accept a callback as a second function application.
This is useful so that multiline functions can be passed as callbacks
without the need for wrapping brackets (which a CoffeeScript bug
requires them to have). <code>$block</code> also takes an optional function airity
argument as the first argument. If a <code>length</code> argument is given, and <code>length</code>
or more arguments are passed, <code>$block</code> will call the second argument
(the function) with the passed arguments, regardless of their type.
Example:
 With a function that accepts a callback as its last argument</p>

<pre><code>f = (a, b, callback) -&gt; callback(a + b)
ex = $block f
</code></pre>

<p>We can use $block to make it accept the callback in both ways:</p>

<pre><code>ex(2, 3, (x) -&gt; alert(x))  # alerts 5
</code></pre>

<p>or</p>

<pre><code>ex(2, 3) (x) -&gt; alert(x)
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman._block = $block = </span><span class="nf">(lengthOrFunction, fn) -&gt;</span>
  <span class="k">if</span> <span class="nx">fn</span><span class="o">?</span>
    <span class="nv">argsLength = </span><span class="nx">lengthOrFunction</span>
  <span class="k">else</span>
    <span class="nv">fn = </span><span class="nx">lengthOrFunction</span>

  <span class="nv">callbackEater = </span><span class="nf">(args...) -&gt;</span>
    <span class="nv">ctx = </span><span class="err">@</span>
    <span class="nv">f = </span><span class="nf">(callback) -&gt;</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">push</span> <span class="nx">callback</span>
      <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Call the function right now if we've been passed the callback already or if we've reached the argument count threshold</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">argsLength</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">argsLength</span><span class="p">))</span>
      <span class="nx">f</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">pop</span><span class="p">())</span>
    <span class="k">else</span>
      <span class="nx">f</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><code>findName</code> allows an anonymous function to find out what key it resides
in within a context.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman._findName = $findName = </span><span class="nf">(f, context) -&gt;</span>
  <span class="nx">unless</span> <span class="nx">f</span><span class="p">.</span><span class="nx">displayName</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">context</span>
      <span class="k">if</span> <span class="nx">value</span> <span class="o">is</span> <span class="nx">f</span>
        <span class="nv">f.displayName = </span><span class="nx">key</span>
        <span class="k">break</span>

  <span class="nx">f</span><span class="p">.</span><span class="nx">displayName</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p><code>$functionName</code> returns the name of a given function, if any
Used to deal with functions not having the <code>name</code> property in IE</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman._functionName = $functionName = </span><span class="nf">(f) -&gt;</span>
  <span class="k">return</span> <span class="nx">f</span><span class="p">.</span><span class="nx">__name__</span> <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">__name__</span>
  <span class="k">return</span> <span class="nx">f</span><span class="p">.</span><span class="nx">name</span> <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">f</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\W*function\s+([\w\$]+)\(/</span><span class="p">)</span><span class="o">?</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p><code>$preventDefault</code> checks for preventDefault, since it's not
always available across all browsers</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman._preventDefault = $preventDefault = </span><span class="nf">(e) -&gt;</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span> <span class="o">is</span> <span class="s2">&quot;function&quot;</span> <span class="k">then</span> <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span> <span class="k">else</span> <span class="nv">e.returnValue = </span><span class="kc">false</span>

<span class="nv">Batman._isChildOf = $isChildOf = </span><span class="nf">(parentNode, childNode) -&gt;</span>
  <span class="nv">node = </span><span class="nx">childNode</span><span class="p">.</span><span class="nx">parentNode</span>
  <span class="k">while</span> <span class="nx">node</span>
    <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">node</span> <span class="o">==</span> <span class="nx">parentNode</span>
    <span class="nv">node = </span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span>
  <span class="kc">false</span>

<span class="nv">$setImmediate = $clearImmediate = </span><span class="kc">null</span>
<span class="nv">_implementImmediates = </span><span class="o">-&gt;</span>
  <span class="nv">canUsePostMessage = </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">container</span><span class="p">.</span><span class="nx">postMessage</span>
    <span class="nv">async = </span><span class="kc">true</span>
    <span class="nv">oldMessage = </span><span class="nx">container</span><span class="p">.</span><span class="nx">onmessage</span>
    <span class="nv">container.onmessage = </span><span class="o">-&gt;</span> <span class="nv">async = </span><span class="kc">false</span>
    <span class="nx">container</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
    <span class="nv">container.onmessage = </span><span class="nx">oldMessage</span>
    <span class="nx">async</span>

  <span class="nv">tasks = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
  <span class="nv">count = </span><span class="mi">0</span>
  <span class="nv">getHandle = </span><span class="o">-&gt;</span> <span class="s2">&quot;go#{++count}&quot;</span>

  <span class="k">if</span> <span class="nx">container</span><span class="p">.</span><span class="nx">setImmediate</span>
    <span class="nv">$setImmediate = </span><span class="nx">container</span><span class="p">.</span><span class="nx">setImmediate</span>
    <span class="nv">$clearImmediate = </span><span class="nx">container</span><span class="p">.</span><span class="nx">clearImmediate</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">container</span><span class="p">.</span><span class="nx">msSetImmediate</span>
    <span class="nv">$setImmediate = </span><span class="nx">msSetImmediate</span>
    <span class="nv">$clearImmediate = </span><span class="nx">msClearImmediate</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">canUsePostMessage</span><span class="p">()</span>
    <span class="nv">prefix = </span><span class="s1">&#39;com.batman.&#39;</span>
    <span class="nv">functions = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="nv">handler = </span><span class="nf">(e) -&gt;</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="o">~</span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span>
      <span class="nv">handle = </span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">prefix</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span><span class="nx">handle</span><span class="p">)</span><span class="o">?</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">container</span><span class="p">.</span><span class="nx">addEventListener</span>
      <span class="nx">container</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">container</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s1">&#39;onmessage&#39;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>

    <span class="nv">$setImmediate = </span><span class="nf">(f) -&gt;</span>
      <span class="nx">tasks</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nv">handle = </span><span class="nx">getHandle</span><span class="p">(),</span> <span class="nx">f</span><span class="p">)</span>
      <span class="nx">container</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">prefix</span><span class="o">+</span><span class="nx">handle</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
      <span class="nx">handle</span>
    <span class="nv">$clearImmediate = </span><span class="nf">(handle) -&gt;</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span><span class="nx">handle</span><span class="p">)</span>
  <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nb">document</span> <span class="o">isnt</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;onreadystatechange&quot;</span> <span class="k">in</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">)</span>
    <span class="nv">$setImmediate = </span><span class="nf">(f) -&gt;</span>
      <span class="nv">handle = </span><span class="nx">getHandle</span><span class="p">()</span>
      <span class="nv">script = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">)</span>
      <span class="nv">script.onreadystatechange = </span><span class="o">-&gt;</span>
        <span class="nx">tasks</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">handle</span><span class="p">)</span><span class="o">?</span><span class="p">()</span>
        <span class="nv">script.onreadystatechange = </span><span class="kc">null</span>
        <span class="nx">script</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">script</span><span class="p">)</span>
        <span class="nv">script = </span><span class="kc">null</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">script</span><span class="p">)</span>
      <span class="nx">handle</span>
    <span class="nv">$clearImmediate = </span><span class="nf">(handle) -&gt;</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span><span class="nx">handle</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nv">$setImmediate = </span><span class="nf">(f) -&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nv">$clearImmediate = </span><span class="nf">(handle) -&gt;</span> <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">handle</span><span class="p">)</span>

  <span class="nv">Batman.setImmediate = </span><span class="nx">$setImmediate</span>
  <span class="nv">Batman.clearImmediate = </span><span class="nx">$clearImmediate</span>

<span class="nv">Batman.setImmediate = $setImmediate = </span><span class="o">-&gt;</span>
  <span class="nx">_implementImmediates</span><span class="p">()</span>
  <span class="nx">Batman</span><span class="p">.</span><span class="nx">setImmediate</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>

<span class="nv">Batman.clearImmediate = $clearImmediate = </span><span class="o">-&gt;</span>
  <span class="nx">_implementImmediates</span><span class="p">()</span>
  <span class="nx">Batman</span><span class="p">.</span><span class="nx">clearImmediate</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p><code>translate</code> is hook for the i18n extra to override and implemnent. All strings which might
be shown to the user pass through this method. <code>translate</code> is aliased to <code>t</code> internally.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.translate = </span><span class="nf">(x, values = {}) -&gt;</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="nx">$get</span><span class="p">(</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">translate</span><span class="p">.</span><span class="nx">messages</span><span class="p">,</span> <span class="nx">x</span><span class="p">),</span> <span class="nx">values</span><span class="p">)</span>
<span class="nv">Batman.translate.messages = </span><span class="p">{}</span>
<span class="nv">t = </span><span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">arguments</span><span class="p">...)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h2>Developer Tooling</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">developer =</span>
  <span class="nv">suppressed: </span><span class="kc">false</span>
  <span class="nv">DevelopmentError: </span><span class="p">(</span><span class="o">-&gt;</span>
    <span class="nv">DevelopmentError = </span><span class="nf">(@message) -&gt;</span>
      <span class="vi">@name = </span><span class="s2">&quot;DevelopmentError&quot;</span>
    <span class="nv">DevelopmentError:: = </span><span class="nb">Error</span><span class="o">::</span>
    <span class="nx">DevelopmentError</span>
  <span class="p">)()</span>
  <span class="nv">_ie_console: </span><span class="nf">(f, args) -&gt;</span>
    <span class="nx">console</span><span class="o">?</span><span class="p">[</span><span class="nx">f</span><span class="p">]</span> <span class="s2">&quot;...#{f} of #{args.length} items...&quot;</span> <span class="nx">unless</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="nx">console</span><span class="o">?</span><span class="p">[</span><span class="nx">f</span><span class="p">]</span> <span class="nx">arg</span> <span class="k">for</span> <span class="nx">arg</span> <span class="k">in</span> <span class="nx">args</span>
  <span class="nv">suppress: </span><span class="nf">(f) -&gt;</span>
    <span class="nv">developer.suppressed = </span><span class="kc">true</span>
    <span class="k">if</span> <span class="nx">f</span>
      <span class="nx">f</span><span class="p">()</span>
      <span class="nv">developer.suppressed = </span><span class="kc">false</span>
  <span class="nv">unsuppress: </span><span class="o">-&gt;</span>
    <span class="nv">developer.suppressed = </span><span class="kc">false</span>
  <span class="nv">log: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">developer</span><span class="p">.</span><span class="nx">suppressed</span> <span class="o">or</span> <span class="o">!</span><span class="p">(</span><span class="nx">console</span><span class="o">?</span><span class="p">.</span><span class="nx">log</span><span class="o">?</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">apply</span> <span class="k">then</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arguments</span><span class="p">...)</span> <span class="k">else</span> <span class="nx">developer</span><span class="p">.</span><span class="nx">_ie_console</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="nx">arguments</span>
  <span class="nv">warn: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">developer</span><span class="p">.</span><span class="nx">suppressed</span> <span class="o">or</span> <span class="o">!</span><span class="p">(</span><span class="nx">console</span><span class="o">?</span><span class="p">.</span><span class="nx">warn</span><span class="o">?</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">.</span><span class="nx">apply</span> <span class="k">then</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="nx">arguments</span><span class="p">...)</span> <span class="k">else</span> <span class="nx">developer</span><span class="p">.</span><span class="nx">_ie_console</span> <span class="s2">&quot;warn&quot;</span><span class="p">,</span> <span class="nx">arguments</span>
  <span class="nv">error: </span><span class="nf">(message) -&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">developer</span><span class="p">.</span><span class="nx">DevelopmentError</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
  <span class="nv">assert: </span><span class="nf">(result, message) -&gt;</span> <span class="nx">developer</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">result</span>
  <span class="nv">do: </span><span class="nf">(f) -&gt;</span> <span class="nx">f</span><span class="p">()</span>
  <span class="nv">addFilters: </span><span class="o">-&gt;</span>
    <span class="nx">$mixin</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Filters</span><span class="p">,</span>
      <span class="nv">log: </span><span class="nf">(value, key) -&gt;</span>
        <span class="nx">console</span><span class="o">?</span><span class="p">.</span><span class="nx">log</span><span class="o">?</span> <span class="nx">arguments</span>
        <span class="nx">value</span>

      <span class="nv">logStack: </span><span class="nf">(value) -&gt;</span>
        <span class="nx">console</span><span class="o">?</span><span class="p">.</span><span class="nx">log</span><span class="o">?</span> <span class="nx">developer</span><span class="p">.</span><span class="nx">currentFilterStack</span>
        <span class="nx">value</span>

<span class="nv">Batman.developer = </span><span class="nx">developer</span>

<span class="nx">developer</span><span class="p">.</span><span class="nx">assert</span> <span class="p">(</span><span class="o">-&gt;</span><span class="p">).</span><span class="nx">bind</span><span class="p">,</span> <span class="s2">&quot;Error! Batman needs Function.bind to work! Please shim it using something like es5-shim or augmentjs!&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h2>Helpers</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">camelize_rx = </span><span class="sr">/(?:^|_|\-)(.)/g</span>
<span class="nv">capitalize_rx = </span><span class="sr">/(^|\s)([a-z])/g</span>
<span class="nv">underscore_rx1 = </span><span class="sr">/([A-Z]+)([A-Z][a-z])/g</span>
<span class="nv">underscore_rx2 = </span><span class="sr">/([a-z\d])([A-Z])/g</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Just a few random Rails-style string helpers. You can add more
to the Batman.helpers object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">helpers = Batman.helpers = </span><span class="p">{</span>
  <span class="nv">camelize: </span><span class="nf">(string, firstLetterLower) -&gt;</span>
    <span class="nv">string = </span><span class="nx">string</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">camelize_rx</span><span class="p">,</span> <span class="nf">(str, p1) -&gt;</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">firstLetterLower</span> <span class="k">then</span> <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="nx">string</span>

  <span class="nv">underscore: </span><span class="nf">(string) -&gt;</span>
    <span class="nx">string</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">underscore_rx1</span><span class="p">,</span> <span class="s1">&#39;$1_$2&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">underscore_rx2</span><span class="p">,</span> <span class="s1">&#39;$1_$2&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span>

  <span class="nv">singularize: </span><span class="nf">(string) -&gt;</span>
    <span class="nv">len = </span><span class="nx">string</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">if</span> <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;ies&#39;</span>
      <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;y&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;s&#39;</span>
      <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">string</span>

  <span class="nv">pluralize: </span><span class="nf">(count, string) -&gt;</span>
    <span class="k">if</span> <span class="nx">string</span>
      <span class="k">return</span> <span class="nx">string</span> <span class="k">if</span> <span class="nx">count</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="k">else</span>
      <span class="nv">string = </span><span class="nx">count</span>

    <span class="nv">len = </span><span class="nx">string</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">lastLetter = </span><span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">lastLetter</span> <span class="o">is</span> <span class="s1">&#39;y&#39;</span>
      <span class="s2">&quot;#{string.substr(0, len - 1)}ies&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">lastLetter</span> <span class="o">is</span> <span class="s1">&#39;s&#39;</span>
      <span class="nx">string</span>
    <span class="k">else</span>
      <span class="s2">&quot;#{string}s&quot;</span>

  <span class="nv">capitalize: </span><span class="nf">(string) -&gt;</span> <span class="nx">string</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">capitalize_rx</span><span class="p">,</span> <span class="nf">(m,p1,p2) -&gt;</span> <span class="nx">p1</span><span class="o">+</span><span class="nx">p2</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>

  <span class="nv">trim: </span><span class="nf">(string) -&gt;</span> <span class="k">if</span> <span class="nx">string</span> <span class="k">then</span> <span class="nx">string</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

  <span class="nv">interpolate: </span><span class="nf">(stringOrObject, keys) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">stringOrObject</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span>
      <span class="nv">string = </span><span class="nx">stringOrObject</span><span class="p">[</span><span class="nx">keys</span><span class="p">.</span><span class="nx">count</span><span class="p">]</span>
      <span class="nx">unless</span> <span class="nx">string</span>
        <span class="nv">string = </span><span class="nx">stringOrObject</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="nv">string = </span><span class="nx">stringOrObject</span>

    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">keys</span>
      <span class="nv">string = </span><span class="nx">string</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;%\\{#{key}\\}&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">),</span> <span class="nx">value</span><span class="p">)</span>
    <span class="nx">string</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Event</span>
  <span class="vi">@forBaseAndKey: </span><span class="nf">(base, key) -&gt;</span>
    <span class="k">if</span> <span class="nx">base</span><span class="p">.</span><span class="nx">isEventEmitter</span>
      <span class="nx">base</span><span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="nv">constructor: </span><span class="nf">(@base, @key) -&gt;</span>
    <span class="vi">@handlers = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>
    <span class="vi">@_preventCount = </span><span class="mi">0</span>
  <span class="nv">isEvent: </span><span class="kc">true</span>
  <span class="nv">isEqual: </span><span class="nf">(other) -&gt;</span>
    <span class="nx">@constructor</span> <span class="o">is</span> <span class="nx">other</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">and</span> <span class="nx">@base</span> <span class="o">is</span> <span class="nx">other</span><span class="p">.</span><span class="nx">base</span> <span class="o">and</span> <span class="nx">@key</span> <span class="o">is</span> <span class="nx">other</span><span class="p">.</span><span class="nx">key</span>
  <span class="nv">hashKey: </span><span class="o">-&gt;</span>
    <span class="vi">@hashKey = </span><span class="o">-&gt;</span> <span class="nx">key</span>
    <span class="nv">key = </span><span class="s2">&quot;&lt;Batman.Event base: #{Batman.Hash::hashKeyFor(@base)}, key: \&quot;#{Batman.Hash::hashKeyFor(@key)}\&quot;&gt;&quot;</span>

  <span class="nv">addHandler: </span><span class="nf">(handler) -&gt;</span>
    <span class="nx">@handlers</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
    <span class="nx">@autofireHandler</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@oneShot</span>
    <span class="k">this</span>
  <span class="nv">removeHandler: </span><span class="nf">(handler) -&gt;</span>
    <span class="nx">@handlers</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
    <span class="k">this</span>

  <span class="nv">eachHandler: </span><span class="nf">(iterator) -&gt;</span>
    <span class="nx">@handlers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">iterator</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">@base</span><span class="o">?</span><span class="p">.</span><span class="nx">isEventEmitter</span>
      <span class="nv">key = </span><span class="nx">@key</span>
      <span class="nx">@base</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">ancestors</span> <span class="nf">(ancestor) -&gt;</span>
        <span class="k">if</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">isEventEmitter</span> <span class="o">and</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">hasEvent</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
          <span class="nv">handlers = </span><span class="nx">ancestor</span><span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">handlers</span>
          <span class="nx">handlers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">iterator</span><span class="p">)</span>

  <span class="nv">handlerContext: </span><span class="o">-&gt;</span> <span class="nx">@base</span>

  <span class="nv">prevent: </span><span class="o">-&gt;</span> <span class="o">++</span><span class="nx">@_preventCount</span>
  <span class="nv">allow: </span><span class="o">-&gt;</span>
    <span class="o">--</span><span class="nx">@_preventCount</span> <span class="k">if</span> <span class="nx">@_preventCount</span>
    <span class="nx">@_preventCount</span>
  <span class="nv">isPrevented: </span><span class="o">-&gt;</span> <span class="nx">@_preventCount</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="nv">autofireHandler: </span><span class="nf">(handler) -&gt;</span>
    <span class="k">if</span> <span class="nx">@_oneShotFired</span> <span class="o">and</span> <span class="nx">@_oneShotArgs</span><span class="o">?</span>
      <span class="nx">handler</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@handlerContext</span><span class="p">(),</span> <span class="nx">@_oneShotArgs</span><span class="p">)</span>
  <span class="nv">resetOneShot: </span><span class="o">-&gt;</span>
    <span class="vi">@_oneShotFired = </span><span class="kc">false</span>
    <span class="vi">@_oneShotArgs = </span><span class="kc">null</span>
  <span class="nv">fire: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">@isPrevented</span><span class="p">()</span> <span class="o">or</span> <span class="nx">@_oneShotFired</span>
    <span class="nv">context = </span><span class="nx">@handlerContext</span><span class="p">()</span>
    <span class="nv">args = </span><span class="nx">arguments</span>
    <span class="k">if</span> <span class="nx">@oneShot</span>
      <span class="vi">@_oneShotFired = </span><span class="kc">true</span>
      <span class="vi">@_oneShotArgs = </span><span class="nx">arguments</span>
    <span class="nx">@eachHandler</span> <span class="nf">(handler) -&gt;</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
  <span class="nv">allowAndFire: </span><span class="o">-&gt;</span>
    <span class="nx">@allow</span><span class="p">()</span>
    <span class="nx">@fire</span><span class="p">(</span><span class="nx">arguments</span><span class="p">...)</span>

<span class="nv">Batman.EventEmitter =</span>
  <span class="nv">isEventEmitter: </span><span class="kc">true</span>
  <span class="nv">hasEvent: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="o">?</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">hasKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="nv">event: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
    <span class="nv">eventClass = </span><span class="nx">@eventClass</span> <span class="o">or</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Event</span>
    <span class="nv">events = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">events</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="k">if</span> <span class="nx">events</span><span class="p">.</span><span class="nx">hasKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
      <span class="nv">existingEvent = </span><span class="nx">events</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">existingEvents = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">)</span>
      <span class="nv">newEvent = </span><span class="nx">events</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="k">new</span> <span class="nx">eventClass</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span>
      <span class="nv">newEvent.oneShot = </span><span class="nx">existingEvents</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">oneShot</span>
      <span class="nx">newEvent</span>
  <span class="kc">on</span><span class="o">:</span> <span class="nf">(key, handler) -&gt;</span>
    <span class="nx">@event</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">addHandler</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
  <span class="nv">registerAsMutableSource: </span><span class="o">-&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">registerSource</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
  <span class="nv">mutation: </span><span class="nf">(wrappedFunction) -&gt;</span>
    <span class="o">-&gt;</span>
      <span class="nv">result = </span><span class="nx">wrappedFunction</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
      <span class="nx">@event</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">).</span><span class="nx">fire</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
      <span class="nx">result</span>
  <span class="nv">prevent: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@event</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">prevent</span><span class="p">()</span>
    <span class="err">@</span>
  <span class="nv">allow: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@event</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">allow</span><span class="p">()</span>
    <span class="err">@</span>
  <span class="nv">isPrevented: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@event</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">isPrevented</span><span class="p">()</span>
  <span class="nv">fire: </span><span class="nf">(key, args...) -&gt;</span>
    <span class="nx">@event</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">fire</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span>
  <span class="nv">allowAndFire: </span><span class="nf">(key, args...) -&gt;</span>
    <span class="nx">@event</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">allowAndFire</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">PropertyEvent</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Event</span>
  <span class="nv">eachHandler: </span><span class="nf">(iterator) -&gt;</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">eachObserver</span><span class="p">(</span><span class="nx">iterator</span><span class="p">)</span>
  <span class="nv">handlerContext: </span><span class="o">-&gt;</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">base</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span>
  <span class="nx">$mixin</span> <span class="nx">@prototype</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">EventEmitter</span>

  <span class="vi">@_sourceTrackerStack: </span><span class="p">[]</span>
  <span class="vi">@sourceTracker: </span><span class="o">-&gt;</span> <span class="p">(</span><span class="nv">stack = </span><span class="nx">@_sourceTrackerStack</span><span class="p">)[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
  <span class="vi">@defaultAccessor:</span>
    <span class="nv">get: </span><span class="nf">(key) -&gt;</span> <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="nv">set: </span><span class="nf">(key, val) -&gt;</span> <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
    <span class="nv">unset: </span><span class="nf">(key) -&gt;</span> <span class="nv">x = </span><span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="k">delete</span> <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="nx">x</span>
    <span class="nv">cachable: </span><span class="kc">no</span>
  <span class="vi">@forBaseAndKey: </span><span class="nf">(base, key) -&gt;</span>
    <span class="k">if</span> <span class="nx">base</span><span class="p">.</span><span class="nx">isObservable</span>
      <span class="nx">base</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Keypath</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>

  <span class="vi">@registerSource: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">isEventEmitter</span>
    <span class="nx">@sourceTracker</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>

  <span class="nv">constructor: </span><span class="nf">(@base, @key) -&gt;</span>

  <span class="nv">_isolationCount: </span><span class="mi">0</span>
  <span class="nv">cached: </span><span class="kc">no</span>
  <span class="nv">value: </span><span class="kc">null</span>
  <span class="nv">sources: </span><span class="kc">null</span>
  <span class="nv">isProperty: </span><span class="kc">true</span>
  <span class="nv">isDead: </span><span class="kc">false</span>
  <span class="nv">eventClass: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">PropertyEvent</span>

  <span class="nv">isEqual: </span><span class="nf">(other) -&gt;</span>
    <span class="nx">@constructor</span> <span class="o">is</span> <span class="nx">other</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">and</span> <span class="nx">@base</span> <span class="o">is</span> <span class="nx">other</span><span class="p">.</span><span class="nx">base</span> <span class="o">and</span> <span class="nx">@key</span> <span class="o">is</span> <span class="nx">other</span><span class="p">.</span><span class="nx">key</span>
  <span class="nv">hashKey: </span><span class="o">-&gt;</span>
    <span class="vi">@hashKey = </span><span class="o">-&gt;</span> <span class="nx">key</span>
    <span class="nv">key = </span><span class="s2">&quot;&lt;Batman.Property base: #{Batman.Hash::hashKeyFor(@base)}, key: \&quot;#{Batman.Hash::hashKeyFor(@key)}\&quot;&gt;&quot;</span>

  <span class="nv">changeEvent: </span><span class="o">-&gt;</span>
    <span class="nv">event = </span><span class="nx">@event</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">)</span>
    <span class="vi">@changeEvent = </span><span class="o">-&gt;</span> <span class="nx">event</span>
    <span class="nx">event</span>
  <span class="nv">accessor: </span><span class="o">-&gt;</span>
    <span class="nv">keyAccessors = </span><span class="nx">@base</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;keyAccessors&#39;</span><span class="p">)</span>
    <span class="nv">accessor = </span><span class="k">if</span> <span class="nx">keyAccessors</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">val = </span><span class="nx">keyAccessors</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">@key</span><span class="p">))</span>
      <span class="nx">val</span>
    <span class="k">else</span>
      <span class="nx">@base</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">getFirst</span><span class="p">(</span><span class="s1">&#39;defaultAccessor&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">defaultAccessor</span>
    <span class="vi">@accessor = </span><span class="o">-&gt;</span> <span class="nx">accessor</span>
    <span class="nx">accessor</span>
  <span class="nv">eachObserver: </span><span class="nf">(iterator) -&gt;</span>
    <span class="nv">key = </span><span class="nx">@key</span>
    <span class="nx">@changeEvent</span><span class="p">().</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">iterator</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">isObservable</span>
      <span class="nx">@base</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">ancestors</span> <span class="nf">(ancestor) -&gt;</span>
        <span class="k">if</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">isObservable</span> <span class="o">and</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">hasProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
          <span class="nv">property = </span><span class="nx">ancestor</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
          <span class="nv">handlers = </span><span class="nx">property</span><span class="p">.</span><span class="nx">changeEvent</span><span class="p">().</span><span class="nx">handlers</span>
          <span class="nx">handlers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">iterator</span><span class="p">)</span>
  <span class="nv">observers: </span><span class="o">-&gt;</span>
    <span class="nv">results = </span><span class="p">[]</span>
    <span class="nx">@eachObserver</span> <span class="nf">(observer) -&gt;</span> <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">observer</span><span class="p">)</span>
    <span class="nx">results</span>
  <span class="nv">hasObservers: </span><span class="o">-&gt;</span> <span class="nx">@observers</span><span class="p">().</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>

  <span class="nv">pushSourceTracker: </span><span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">_sourceTrackerStack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span><span class="p">)</span>
  <span class="nv">pushDummySourceTracker: </span><span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">_sourceTrackerStack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
  <span class="nv">popSourceTracker: </span><span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">_sourceTrackerStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
  <span class="nv">updateSourcesFromTracker: </span><span class="o">-&gt;</span>
    <span class="nv">newSources = </span><span class="nx">@popSourceTracker</span><span class="p">()</span>
    <span class="nv">handler = </span><span class="nx">@sourceChangeHandler</span><span class="p">()</span>
    <span class="nx">@_eachSourceChangeEvent</span> <span class="nf">(e) -&gt;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">removeHandler</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
    <span class="vi">@sources = </span><span class="nx">newSources</span>
    <span class="nx">@_eachSourceChangeEvent</span> <span class="nf">(e) -&gt;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">addHandler</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>

  <span class="nv">_eachSourceChangeEvent: </span><span class="nf">(iterator) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@sources</span><span class="o">?</span>
    <span class="nx">@sources</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(source) -&gt;</span> <span class="nx">iterator</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">))</span>

  <span class="nv">getValue: </span><span class="o">-&gt;</span>
    <span class="nx">@registerAsMutableSource</span><span class="p">()</span>
    <span class="nx">unless</span> <span class="nx">@isCached</span><span class="p">()</span>
      <span class="nx">@pushSourceTracker</span><span class="p">()</span>
      <span class="k">try</span>
        <span class="vi">@value = </span><span class="nx">@valueFromAccessor</span><span class="p">()</span>
        <span class="vi">@cached = </span><span class="kc">yes</span>
      <span class="k">finally</span>
        <span class="nx">@updateSourcesFromTracker</span><span class="p">()</span>
    <span class="nx">@lockValue</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@value</span> <span class="o">isnt</span> <span class="kc">undefined</span> <span class="o">and</span> <span class="nx">@isFinal</span><span class="p">()</span>
    <span class="nx">@value</span>

  <span class="nv">isCachable: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">@isFinal</span><span class="p">()</span>
    <span class="nv">cachable = </span><span class="nx">@accessor</span><span class="p">().</span><span class="nx">cachable</span>
    <span class="k">if</span> <span class="nx">cachable</span><span class="o">?</span> <span class="k">then</span> <span class="o">!!</span><span class="nx">cachable</span> <span class="k">else</span> <span class="kc">true</span>

  <span class="nv">isCached: </span><span class="o">-&gt;</span> <span class="nx">@isCachable</span><span class="p">()</span> <span class="o">and</span> <span class="nx">@cached</span>

  <span class="nv">isFinal: </span><span class="o">-&gt;</span> <span class="o">!!</span><span class="nx">@accessor</span><span class="p">().</span><span class="nx">final</span>

  <span class="nv">refresh: </span><span class="o">-&gt;</span>
    <span class="vi">@cached = </span><span class="kc">no</span>
    <span class="nv">previousValue = </span><span class="nx">@value</span>
    <span class="nv">value = </span><span class="nx">@getValue</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">value</span> <span class="o">isnt</span> <span class="nx">previousValue</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@isIsolated</span><span class="p">()</span>
      <span class="nx">@fire</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">previousValue</span><span class="p">)</span>

  <span class="nv">sourceChangeHandler: </span><span class="o">-&gt;</span>
    <span class="nv">handler = </span><span class="o">=&gt;</span> <span class="nx">@_handleSourceChange</span><span class="p">()</span>
    <span class="vi">@sourceChangeHandler = </span><span class="o">-&gt;</span> <span class="nx">handler</span>
    <span class="nx">handler</span>

  <span class="nv">_handleSourceChange: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@isIsolated</span><span class="p">()</span>
      <span class="vi">@_needsRefresh = </span><span class="kc">yes</span>
    <span class="k">else</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@hasObservers</span><span class="p">()</span>
      <span class="vi">@cached = </span><span class="kc">no</span>
    <span class="k">else</span>
      <span class="nx">@refresh</span><span class="p">()</span>

  <span class="nv">valueFromAccessor: </span><span class="o">-&gt;</span> <span class="nx">@accessor</span><span class="p">().</span><span class="nx">get</span><span class="o">?</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@base</span><span class="p">,</span> <span class="nx">@key</span><span class="p">)</span>

  <span class="nv">setValue: </span><span class="nf">(val) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nv">set = </span><span class="nx">@accessor</span><span class="p">().</span><span class="nx">set</span>
    <span class="nx">@_changeValue</span> <span class="o">-&gt;</span> <span class="nx">set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@base</span><span class="p">,</span> <span class="nx">@key</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span>
  <span class="nv">unsetValue: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nv">unset = </span><span class="nx">@accessor</span><span class="p">().</span><span class="nx">unset</span>
    <span class="nx">@_changeValue</span> <span class="o">-&gt;</span> <span class="nx">unset</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@base</span><span class="p">,</span> <span class="nx">@key</span><span class="p">)</span>

  <span class="nv">_changeValue: </span><span class="nf">(block) -&gt;</span>
    <span class="vi">@cached = </span><span class="kc">no</span>
    <span class="nx">@pushDummySourceTracker</span><span class="p">()</span>
    <span class="k">try</span>
      <span class="nv">result = </span><span class="nx">block</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="nx">@refresh</span><span class="p">()</span>
    <span class="k">finally</span>
      <span class="nx">@popSourceTracker</span><span class="p">()</span>
    <span class="nx">@die</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">@isCached</span><span class="p">()</span> <span class="o">or</span> <span class="nx">@hasObservers</span><span class="p">()</span>
    <span class="nx">result</span>

  <span class="nv">forget: </span><span class="nf">(handler) -&gt;</span>
    <span class="k">if</span> <span class="nx">handler</span><span class="o">?</span>
      <span class="nx">@changeEvent</span><span class="p">().</span><span class="nx">removeHandler</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@changeEvent</span><span class="p">().</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
  <span class="nv">observeAndFire: </span><span class="nf">(handler) -&gt;</span>
    <span class="nx">@observe</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
    <span class="nx">handler</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@base</span><span class="p">,</span> <span class="nx">@value</span><span class="p">,</span> <span class="nx">@value</span><span class="p">)</span>
  <span class="nv">observe: </span><span class="nf">(handler) -&gt;</span>
    <span class="nx">@changeEvent</span><span class="p">().</span><span class="nx">addHandler</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
    <span class="nx">@getValue</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">@sources</span><span class="o">?</span>
    <span class="k">this</span>
    
  <span class="nv">_removeHandlers: </span><span class="o">-&gt;</span>
    <span class="nv">handler = </span><span class="nx">@sourceChangeHandler</span><span class="p">()</span>
    <span class="nx">@_eachSourceChangeEvent</span> <span class="nf">(e) -&gt;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">removeHandler</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
    <span class="k">delete</span> <span class="nx">@sources</span>
    <span class="nx">@changeEvent</span><span class="p">().</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>

  <span class="nv">lockValue: </span><span class="o">-&gt;</span>
    <span class="nx">@_removeHandlers</span><span class="p">()</span>
    <span class="vi">@getValue = </span><span class="o">-&gt;</span> <span class="nx">@value</span>
    <span class="vi">@setValue = @unsetValue = @refresh = @observe = </span><span class="o">-&gt;</span>

  <span class="nv">die: </span><span class="o">-&gt;</span>
    <span class="nx">@_removeHandlers</span><span class="p">()</span>
    <span class="nx">@base</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">properties</span><span class="o">?</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span><span class="nx">@key</span><span class="p">)</span>
    <span class="vi">@isDead = </span><span class="kc">true</span>

  <span class="nv">fire: </span><span class="o">-&gt;</span> <span class="nx">@changeEvent</span><span class="p">().</span><span class="nx">fire</span><span class="p">(</span><span class="nx">arguments</span><span class="p">...)</span>

  <span class="nv">isolate: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@_isolationCount</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="vi">@_preIsolationValue = </span><span class="nx">@getValue</span><span class="p">()</span>
    <span class="nx">@_isolationCount</span><span class="o">++</span>
  <span class="nv">expose: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@_isolationCount</span> <span class="o">is</span> <span class="mi">1</span>
      <span class="nx">@_isolationCount</span><span class="o">--</span>
      <span class="k">if</span> <span class="nx">@_needsRefresh</span>
        <span class="vi">@value = </span><span class="nx">@_preIsolationValue</span>
        <span class="nx">@refresh</span><span class="p">()</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">@value</span> <span class="o">isnt</span> <span class="nx">@_preIsolationValue</span>
        <span class="nx">@fire</span><span class="p">(</span><span class="nx">@value</span><span class="p">,</span> <span class="nx">@_preIsolationValue</span><span class="p">)</span>
      <span class="vi">@_preIsolationValue = </span><span class="kc">null</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@_isolationCount</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">@_isolationCount</span><span class="o">--</span>
  <span class="nv">isIsolated: </span><span class="o">-&gt;</span> <span class="nx">@_isolationCount</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h2>Keypaths</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Keypath</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span>
  <span class="nv">constructor: </span><span class="nf">(base, key) -&gt;</span>
    <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;String&#39;</span>
      <span class="vi">@segments = </span><span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
      <span class="vi">@depth = </span><span class="nx">@segments</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">else</span>
      <span class="vi">@segments = </span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="vi">@depth = </span><span class="mi">1</span>
    <span class="k">super</span>
  <span class="nv">slice: </span><span class="nf">(begin, end=@depth) -&gt;</span>
    <span class="nv">base = </span><span class="nx">@base</span>
    <span class="k">for</span> <span class="nx">segment</span> <span class="k">in</span> <span class="nx">@segments</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">begin</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">base</span><span class="o">?</span> <span class="o">and</span> <span class="nv">base = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">forBaseAndKey</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">segment</span><span class="p">).</span><span class="nx">getValue</span><span class="p">()</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">forBaseAndKey</span> <span class="nx">base</span><span class="p">,</span> <span class="nx">@segments</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">begin</span><span class="p">,</span> <span class="nx">end</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
  <span class="nv">terminalProperty: </span><span class="o">-&gt;</span> <span class="nx">@slice</span> <span class="o">-</span><span class="mi">1</span>
  <span class="nv">valueFromAccessor: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@depth</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">super</span> <span class="k">else</span> <span class="nx">@terminalProperty</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">getValue</span><span class="p">()</span>
  <span class="nv">setValue: </span><span class="nf">(val) -&gt;</span> <span class="k">if</span> <span class="nx">@depth</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">super</span> <span class="k">else</span> <span class="nx">@terminalProperty</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
  <span class="nv">unsetValue: </span><span class="o">-&gt;</span> <span class="k">if</span> <span class="nx">@depth</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">super</span> <span class="k">else</span> <span class="nx">@terminalProperty</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">unsetValue</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h2>Observable</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Batman.Observable is a generic mixin that can be applied to any object to allow it to be bound to.
It is applied by default to every instance of <code>Batman.Object</code> and subclasses.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.Observable =</span>
  <span class="nv">isObservable: </span><span class="kc">true</span>
  <span class="nv">hasProperty: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">properties</span><span class="o">?</span><span class="p">.</span><span class="nx">hasKey</span><span class="o">?</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="nv">property: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
    <span class="nv">propertyClass = </span><span class="nx">@propertyClass</span> <span class="o">or</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Keypath</span>
    <span class="nv">properties = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">properties</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="nx">properties</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">or</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="k">new</span> <span class="nx">propertyClass</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span>
  <span class="nv">get: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">getValue</span><span class="p">()</span>
  <span class="nv">set: </span><span class="nf">(key, val) -&gt;</span>
    <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
  <span class="nv">unset: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">unsetValue</span><span class="p">()</span>

  <span class="nv">getOrSet: </span><span class="nf">(key, valueFunction) -&gt;</span>
    <span class="nv">currentValue = </span><span class="nx">@get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="nx">unless</span> <span class="nx">currentValue</span>
      <span class="nv">currentValue = </span><span class="nx">valueFunction</span><span class="p">()</span>
      <span class="nx">@set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">currentValue</span><span class="p">)</span>
    <span class="nx">currentValue</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p><code>forget</code> removes an observer from an object. If the callback is passed in,
its removed. If no callback but a key is passed in, all the observers on
that key are removed. If no key is passed in, all observers are removed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">forget: </span><span class="nf">(key, observer) -&gt;</span>
    <span class="k">if</span> <span class="nx">key</span>
      <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">forget</span><span class="p">(</span><span class="nx">observer</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@_batman</span><span class="p">.</span><span class="nx">properties</span><span class="o">?</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(key, property) -&gt;</span> <span class="nx">property</span><span class="p">.</span><span class="nx">forget</span><span class="p">()</span>
    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p><code>fire</code> tells any observers attached to a key to fire, manually.
<code>prevent</code> stops of a given binding from firing. <code>prevent</code> calls can be repeated such that
the same number of calls to allow are needed before observers can be fired.
<code>allow</code> unblocks a property for firing observers. Every call to prevent
must have a matching call to allow later if observers are to be fired.
<code>observe</code> takes a key and a callback. Whenever the value for that key changes, your
callback will be called in the context of the original object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">observe: </span><span class="nf">(key, args...) -&gt;</span>
    <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">observe</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span>
    <span class="err">@</span>

  <span class="nv">observeAndFire: </span><span class="nf">(key, args...) -&gt;</span>
    <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">observeAndFire</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span>
    <span class="err">@</span>

<span class="nv">$get = Batman.get = </span><span class="nf">(base, key) -&gt;</span>
  <span class="k">if</span> <span class="nx">base</span><span class="p">.</span><span class="nx">get</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">base</span><span class="p">.</span><span class="nx">get</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="nx">base</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">forBaseAndKey</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">key</span><span class="p">).</span><span class="nx">getValue</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h2>Objects</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p><code>Batman.initializeObject</code> is called by all the methods in Batman.Object to ensure that the
object's <code>_batman</code> property is initialized and it's own. Classes extending Batman.Object inherit
methods like <code>get</code>, <code>set</code>, and <code>observe</code> by default on the class and prototype levels, such that
both instances and the class respond to them and can be bound to. However, CoffeeScript's static
class inheritance copies over all class level properties indiscriminately, so a parent class'
<code>_batman</code> object will get copied to its subclasses, transferring all the information stored there and
allowing subclasses to mutate parent state. This method prevents this undesirable behaviour by tracking
which object the <code>_batman_</code> object was initialized upon, and reinitializing if that has changed since
initialization.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.initializeObject = </span><span class="nf">(object) -&gt;</span>
  <span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span>
    <span class="nx">object</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nv">object._batman = </span><span class="k">new</span> <span class="nx">_Batman</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>_Batman provides a convienient, parent class and prototype aware place to store hidden
object state. Things like observers, accessors, and states belong in the <code>_batman</code> object
attached to every Batman.Object subclass and subclass instance.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman._Batman = </span><span class="k">class</span> <span class="nx">_Batman</span>
  <span class="nv">constructor: </span><span class="nf">(@object, mixins...) -&gt;</span>
    <span class="nx">$mixin</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">mixins</span><span class="p">...)</span> <span class="k">if</span> <span class="nx">mixins</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Used by <code>Batman.initializeObject</code> to ensure that this <code>_batman</code> was created referencing
the object it is pointing to.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">check: </span><span class="nf">(object) -&gt;</span>
    <span class="k">if</span> <span class="nx">object</span> <span class="o">!=</span> <span class="nx">@object</span>
      <span class="nv">object._batman = </span><span class="k">new</span> <span class="nx">_Batman</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="k">return</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p><code>get</code> is a prototype and class aware property access method. <code>get</code> will traverse the prototype chain, asking
for the passed key at each step, and then attempting to merge the results into one object.
It can only do this if at each level an <code>Array</code>, <code>Hash</code>, or <code>Set</code> is found, so try to use
those if you need <code>_batman</code> inhertiance.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get: </span><span class="nf">(key) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Get all the keys from the ancestor chain</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">results = </span><span class="nx">@getAll</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">switch</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">when</span> <span class="mi">0</span>
        <span class="kc">undefined</span>
      <span class="k">when</span> <span class="mi">1</span>
        <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>And then try to merge them if there is more than one. Use <code>concat</code> on arrays, and <code>merge</code> on
sets and hashes.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">concat</span><span class="o">?</span>
          <span class="nv">results = </span><span class="nx">results</span><span class="p">.</span><span class="nx">reduceRight</span> <span class="nf">(a, b) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">merge</span><span class="o">?</span>
          <span class="nv">results = </span><span class="nx">results</span><span class="p">.</span><span class="nx">reduceRight</span> <span class="nf">(a, b) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
        <span class="nx">results</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p><code>getFirst</code> is a prototype and class aware property access method. <code>getFirst</code> traverses the prototype chain,
and returns the value of the first <code>_batman</code> object which defines the passed key. Useful for
times when the merged value doesn't make sense or the value is a primitive.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getFirst: </span><span class="nf">(key) -&gt;</span>
    <span class="nv">results = </span><span class="nx">@getAll</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p><code>getAll</code> is a prototype and class chain iterator. When passed a key or function, it applies it to each
parent class or parent prototype, and returns the undefined values, closest ancestor first.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getAll: </span><span class="nf">(keyOrGetter) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Get a function which pulls out the key from the ancestor's <code>_batman</code> or use the passed function.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">keyOrGetter</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nv">getter = </span><span class="nx">keyOrGetter</span>
    <span class="k">else</span>
      <span class="nv">getter = </span><span class="nf">(ancestor) -&gt;</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">[</span><span class="nx">keyOrGetter</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Apply it to all the ancestors, and then this <code>_batman</code>'s object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">results = </span><span class="nx">@ancestors</span><span class="p">(</span><span class="nx">getter</span><span class="p">)</span>
    <span class="k">if</span> <span class="nv">val = </span><span class="nx">getter</span><span class="p">(</span><span class="nx">@object</span><span class="p">)</span>
      <span class="nx">results</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">val</span>
    <span class="nx">results</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p><code>ancestors</code> traverses the prototype or class chain and returns the application of a function to each
object in the chain. <code>ancestors</code> does this <em>only</em> to the <code>@object</code>'s ancestors, and not the <code>@object</code>
itsself.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ancestors: </span><span class="p">(</span><span class="nv">getter = </span><span class="nf">(x) -&gt;</span> <span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">results = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Decide if the object is a class or not, and pull out the first ancestor</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">isClass = </span><span class="o">!!</span><span class="nx">@object</span><span class="p">.</span><span class="nx">prototype</span>
    <span class="nv">parent = </span><span class="k">if</span> <span class="nx">isClass</span>
      <span class="nx">@object</span><span class="p">.</span><span class="nx">__super__</span><span class="o">?</span><span class="p">.</span><span class="nx">constructor</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">proto = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">getPrototypeOf</span><span class="p">(</span><span class="nx">@object</span><span class="p">))</span> <span class="o">==</span> <span class="nx">@object</span>
        <span class="nx">@object</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">__super__</span>
      <span class="k">else</span>
        <span class="nx">proto</span>

    <span class="k">if</span> <span class="nx">parent</span><span class="o">?</span>
      <span class="nx">parent</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Apply the function and store the result if it isn't undefined.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">val = </span><span class="nx">getter</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span>
      <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="k">if</span> <span class="nx">val</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Use a recursive call to <code>_batman.ancestors</code> on the ancestor, which will take the next step up the chain.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">results = </span><span class="nx">results</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">ancestors</span><span class="p">(</span><span class="nx">getter</span><span class="p">))</span> <span class="k">if</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span>
    <span class="nx">results</span>

  <span class="nv">set: </span><span class="nf">(key, value) -&gt;</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p><code>Batman.Object</code> is the base class for all other Batman objects. It is not abstract.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">BatmanObject</span>
  <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span><span class="p">(</span><span class="nx">@prototype</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Setting <code>isGlobal</code> to true will cause the class name to be defined on the
global object. For example, Batman.Model will be aliased to window.Model.
This should be used sparingly; it's mostly useful for debugging.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@global: </span><span class="nf">(isGlobal) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">isGlobal</span> <span class="o">is</span> <span class="kc">false</span>
    <span class="nx">container</span><span class="p">[</span><span class="nx">$functionName</span><span class="p">(</span><span class="err">@</span><span class="p">)]</span> <span class="o">=</span> <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Apply mixins to this class.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@classMixin: </span><span class="o">-&gt;</span> <span class="nx">$mixin</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Apply mixins to instances of this class.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@mixin: </span><span class="o">-&gt;</span> <span class="nx">@classMixin</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@prototype</span><span class="p">,</span> <span class="nx">arguments</span>
  <span class="nv">mixin: </span><span class="nx">@classMixin</span>

  <span class="nv">counter = </span><span class="mi">0</span>
  <span class="nv">_objectID: </span><span class="o">-&gt;</span>
    <span class="vi">@_objectID = </span><span class="o">-&gt;</span> <span class="nx">c</span>
    <span class="nv">c = </span><span class="nx">counter</span><span class="o">++</span>

  <span class="nv">hashKey: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">@isEqual</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="vi">@hashKey = </span><span class="o">-&gt;</span> <span class="nx">key</span>
    <span class="nv">key = </span><span class="s2">&quot;&lt;Batman.Object #{@_objectID()}&gt;&quot;</span>

  <span class="nv">toJSON: </span><span class="o">-&gt;</span>
    <span class="nv">obj = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="err">@</span> <span class="k">when</span> <span class="nx">key</span> <span class="o">not</span> <span class="k">in</span> <span class="p">[</span><span class="s2">&quot;_batman&quot;</span><span class="p">,</span> <span class="s2">&quot;hashKey&quot;</span><span class="p">,</span> <span class="s2">&quot;_objectID&quot;</span><span class="p">]</span>
      <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span> <span class="k">then</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="k">else</span> <span class="nx">value</span>
    <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Accessor implementation. Accessors are used to create properties on a class or prototype which can be fetched
with get, but are computed instead of just stored. This is a batman and old browser friendly version of
<code>defineProperty</code> without as much goodness.</p>

<p>Accessors track which other properties they rely on for computation, and when those other properties change,
an accessor will recalculate its value and notifiy its observers. This way, when a source value is changed,
any dependent accessors will automatically update any bindings to them with a new value. Accessors accomplish
this feat by tracking <code>get</code> calls, do be sure to use <code>get</code> to retrieve properties inside accessors.</p>

<p><code>@accessor</code> or <code>@classAccessor</code> can be called with zero, one, or many keys to attach the accessor to. This
has the following effects:</p>

<ul>
<li>zero: create a <code>defaultAccessor</code>, which will be called when no other properties or accessors on an object
match a keypath. This is similar to <code>method_missing</code> in Ruby or <code>#doesNotUnderstand</code> in Smalltalk.</li>
<li>one: create a <code>keyAccessor</code> at the given key, which will only be called when that key is <code>get</code>ed.</li>
<li>many: create <code>keyAccessors</code> for each given key, which will then be called whenever each key is <code>get</code>ed.</li>
</ul>

<p>Note: This function gets called in all sorts of different contexts by various
other pointers to it, but it acts the same way on <code>this</code> in all cases.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getAccessorObject = </span><span class="nf">(accessor) -&gt;</span>
    <span class="nv">accessor = </span><span class="p">{</span><span class="nv">get: </span><span class="nx">accessor</span><span class="p">}</span> <span class="k">if</span> <span class="o">!</span><span class="nx">accessor</span><span class="p">.</span><span class="nx">get</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">accessor</span><span class="p">.</span><span class="nx">set</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">accessor</span><span class="p">.</span><span class="nx">unset</span>
    <span class="nx">accessor</span>

  <span class="vi">@classAccessor: </span><span class="nf">(keys..., accessor) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Create a default accessor if no keys have been given.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>The <code>accessor</code> argument is wrapped in <code>getAccessorObject</code> which allows functions to be passed in
as a shortcut to {get: function}</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@_batman.defaultAccessor = </span><span class="nx">getAccessorObject</span><span class="p">(</span><span class="nx">accessor</span><span class="p">)</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Otherwise, add key accessors for each key given.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@_batman</span><span class="p">.</span><span class="nx">keyAccessors</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
      <span class="nx">@_batman</span><span class="p">.</span><span class="nx">keyAccessors</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">getAccessorObject</span><span class="p">(</span><span class="nx">accessor</span><span class="p">))</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">keys</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Support adding accessors to the prototype from within class defintions or after the class has been created
with <code>KlassExtendingBatmanObject.accessor(keys..., accessorObject)</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@accessor: </span><span class="o">-&gt;</span> <span class="nx">@classAccessor</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@prototype</span><span class="p">,</span> <span class="nx">arguments</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Support adding accessors to instances after creation</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">accessor: </span><span class="nx">@classAccessor</span>

  <span class="nv">constructor: </span><span class="nf">(mixins...) -&gt;</span>
    <span class="vi">@_batman = </span><span class="k">new</span> <span class="nx">_Batman</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="nx">@mixin</span> <span class="nx">mixins</span><span class="p">...</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Make every subclass and their instances observable.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@classMixin</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span>
  <span class="nx">@mixin</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Observe this property on every instance of this class.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@observeAll: </span><span class="o">-&gt;</span> <span class="err">@</span><span class="o">::</span><span class="nx">observe</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@prototype</span><span class="p">,</span> <span class="nx">arguments</span>

  <span class="vi">@singleton: </span><span class="nf">(singletonMethodName=&quot;sharedInstance&quot;) -&gt;</span>
    <span class="nx">@classAccessor</span> <span class="nx">singletonMethodName</span><span class="p">,</span>
      <span class="nv">get: </span><span class="o">-&gt;</span> <span class="err">@</span><span class="p">[</span><span class="s2">&quot;_#{singletonMethodName}&quot;</span><span class="p">]</span> <span class="o">||=</span> <span class="k">new</span> <span class="err">@</span>

<span class="nv">Batman.Object = </span><span class="nx">BatmanObject</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Accessible</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span> <span class="nx">@accessor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">TerminalAccessible</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Accessible</span>
  <span class="nv">propertyClass: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Collections</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.Enumerable =</span>
  <span class="nv">isEnumerable: </span><span class="kc">true</span>
  <span class="nv">map: </span>  <span class="nf">(f, ctx = container) -&gt;</span> <span class="nv">r = </span><span class="p">[];</span> <span class="nx">@forEach</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span> <span class="nx">r</span>
  <span class="nv">every: </span><span class="nf">(f, ctx = container) -&gt;</span> <span class="nv">r = </span><span class="kc">true</span><span class="p">;</span> <span class="nx">@forEach</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nv">r = </span><span class="nx">r</span> <span class="o">&amp;&amp;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span> <span class="nx">r</span>
  <span class="nv">some: </span> <span class="nf">(f, ctx = container) -&gt;</span> <span class="nv">r = </span><span class="kc">false</span><span class="p">;</span> <span class="nx">@forEach</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nv">r = </span><span class="nx">r</span> <span class="o">||</span> <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span> <span class="nx">r</span>
  <span class="nv">reduce: </span><span class="nf">(f, r) -&gt;</span>
    <span class="nv">count = </span><span class="mi">0</span>
    <span class="nv">self = </span><span class="err">@</span>
    <span class="nx">@forEach</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="nx">r</span><span class="o">?</span> <span class="k">then</span> <span class="nv">r = </span><span class="nx">f</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">self</span><span class="p">)</span> <span class="k">else</span> <span class="nv">r = </span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">r</span>
  <span class="nv">filter: </span><span class="nf">(f) -&gt;</span>
    <span class="nv">r = </span><span class="k">new</span> <span class="nx">@constructor</span>
    <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">add</span>
      <span class="nv">wrap = </span><span class="nf">(r, e) -&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="k">if</span> <span class="nx">f</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="nx">r</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">set</span>
      <span class="nv">wrap = </span><span class="nf">(r, k, v) -&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="k">if</span> <span class="nx">f</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">);</span> <span class="nx">r</span>
    <span class="k">else</span>
      <span class="nv">r = </span><span class="p">[]</span> <span class="nx">unless</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span>
      <span class="nv">wrap = </span><span class="nf">(r, e) -&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="k">if</span> <span class="nx">f</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="nx">r</span>
    <span class="nx">@reduce</span> <span class="nx">wrap</span><span class="p">,</span> <span class="nx">r</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Provide this simple mixin ability so that during bootstrapping we don't have to use <code>$mixin</code>. <code>$mixin</code>
will correctly attempt to use <code>set</code> on the mixinee, which ends up requiring the definition of
<code>SimpleSet</code> to be complete during its definition.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">$extendsEnumerable = </span><span class="nf">(onto) -&gt;</span> <span class="nx">onto</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Enumerable</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@_storage = </span><span class="p">{}</span>
    <span class="vi">@length = </span><span class="mi">0</span>
  <span class="nx">$extendsEnumerable</span><span class="p">(</span><span class="err">@</span><span class="o">::</span><span class="p">)</span>
  <span class="nv">propertyClass: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span>
  <span class="nv">hasKey: </span><span class="nf">(key) -&gt;</span>
    <span class="k">if</span> <span class="nv">pairs = </span><span class="nx">@_storage</span><span class="p">[</span><span class="nx">@hashKeyFor</span><span class="p">(</span><span class="nx">key</span><span class="p">)]</span>
      <span class="k">for</span> <span class="nx">pair</span> <span class="k">in</span> <span class="nx">pairs</span>
        <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">@equality</span><span class="p">(</span><span class="nx">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">false</span>
  <span class="nv">get: </span><span class="nf">(key) -&gt;</span>
    <span class="k">if</span> <span class="nv">pairs = </span><span class="nx">@_storage</span><span class="p">[</span><span class="nx">@hashKeyFor</span><span class="p">(</span><span class="nx">key</span><span class="p">)]</span>
      <span class="k">for</span> <span class="nx">pair</span> <span class="k">in</span> <span class="nx">pairs</span>
        <span class="k">return</span> <span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@equality</span><span class="p">(</span><span class="nx">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">key</span><span class="p">)</span>
  <span class="nv">set: </span><span class="nf">(key, val) -&gt;</span>
    <span class="nv">pairs = </span><span class="nx">@_storage</span><span class="p">[</span><span class="nx">@hashKeyFor</span><span class="p">(</span><span class="nx">key</span><span class="p">)]</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nx">pair</span> <span class="k">in</span> <span class="nx">pairs</span>
      <span class="k">if</span> <span class="nx">@equality</span><span class="p">(</span><span class="nx">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
    <span class="nx">@length</span><span class="o">++</span>
    <span class="nx">pairs</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">])</span>
    <span class="nx">val</span>
  <span class="nv">unset: </span><span class="nf">(key) -&gt;</span>
    <span class="nv">hashKey = </span><span class="nx">@hashKeyFor</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="nv">pairs = </span><span class="nx">@_storage</span><span class="p">[</span><span class="nx">hashKey</span><span class="p">]</span>
      <span class="k">for</span> <span class="p">[</span><span class="nx">obj</span><span class="p">,</span><span class="nx">value</span><span class="p">],</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">pairs</span>
        <span class="k">if</span> <span class="nx">@equality</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
          <span class="nv">pair = </span><span class="nx">pairs</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="k">delete</span> <span class="nx">@_storage</span><span class="p">[</span><span class="nx">hashKey</span><span class="p">]</span> <span class="nx">unless</span> <span class="nx">pairs</span><span class="p">.</span><span class="nx">length</span>
          <span class="nx">@length</span><span class="o">--</span>
          <span class="k">return</span> <span class="nx">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
  <span class="nv">getOrSet: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">getOrSet</span>
  <span class="nv">hashKeyFor: </span><span class="nf">(obj) -&gt;</span> <span class="nx">obj</span><span class="o">?</span><span class="p">.</span><span class="nx">hashKey</span><span class="o">?</span><span class="p">()</span> <span class="o">or</span> <span class="nx">obj</span>
  <span class="nv">equality: </span><span class="nf">(lhs, rhs) -&gt;</span>
    <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">lhs</span> <span class="o">is</span> <span class="nx">rhs</span>
    <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">lhs</span> <span class="o">isnt</span> <span class="nx">lhs</span> <span class="o">and</span> <span class="nx">rhs</span> <span class="o">isnt</span> <span class="nx">rhs</span> <span class="c1"># when both are NaN</span>
    <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">lhs</span><span class="o">?</span><span class="p">.</span><span class="nx">isEqual</span><span class="o">?</span><span class="p">(</span><span class="nx">rhs</span><span class="p">)</span> <span class="o">and</span> <span class="nx">rhs</span><span class="o">?</span><span class="p">.</span><span class="nx">isEqual</span><span class="o">?</span><span class="p">(</span><span class="nx">lhs</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">false</span>
  <span class="nv">forEach: </span><span class="nf">(iterator) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">values</span> <span class="k">of</span> <span class="nx">@_storage</span>
      <span class="nx">iterator</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="k">for</span> <span class="p">[</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span><span class="p">]</span> <span class="k">in</span> <span class="nx">values</span><span class="p">.</span><span class="nx">slice</span><span class="p">()</span>
  <span class="nv">keys: </span><span class="o">-&gt;</span>
    <span class="nv">result = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Explicitly reference this foreach so that if it's overriden in subclasses the new implementation isn't used.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="nx">forEach</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span><span class="p">,</span> <span class="nf">(key) -&gt;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span> <span class="nx">key</span>
    <span class="nx">result</span>
  <span class="nv">clear: </span><span class="o">-&gt;</span>
    <span class="vi">@_storage = </span><span class="p">{}</span>
    <span class="vi">@length = </span><span class="mi">0</span>
  <span class="nv">isEmpty: </span><span class="o">-&gt;</span>
    <span class="nx">@length</span> <span class="o">is</span> <span class="mi">0</span>
  <span class="nv">merge: </span><span class="nf">(others...) -&gt;</span>
    <span class="nv">merged = </span><span class="k">new</span> <span class="nx">@constructor</span>
    <span class="nx">others</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">hash</span> <span class="k">in</span> <span class="nx">others</span>
      <span class="nx">hash</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(obj, value) -&gt;</span>
        <span class="nx">merged</span><span class="p">.</span><span class="nx">set</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span>
    <span class="nx">merged</span>
  <span class="nv">toJSON: </span><span class="o">-&gt;</span>
    <span class="nx">@reduce</span> <span class="nf">(obj, key, value) -&gt;</span>
      <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span> <span class="k">then</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="k">else</span> <span class="nx">value</span>
      <span class="nx">obj</span>
    <span class="p">,</span> <span class="p">{}</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Hash</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Add a meta object to all hashes which we can then use in the <code>meta</code> filter to allow binding
to hash meta-properties without reserving keys.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@meta = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nx">@meta</span><span class="p">.</span><span class="nx">accessor</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">registerAsMutableSource</span><span class="p">()</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">@meta</span><span class="p">.</span><span class="nx">accessor</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
    <span class="nx">@meta</span><span class="p">.</span><span class="nx">accessor</span> <span class="s1">&#39;keys&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">keys</span><span class="p">()</span>
    <span class="k">super</span>

  <span class="nx">$extendsEnumerable</span><span class="p">(</span><span class="err">@</span><span class="o">::</span><span class="p">)</span>
  <span class="nv">propertyClass: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span>

  <span class="nx">@accessor</span>
    <span class="nv">get: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="nx">get</span>
    <span class="nv">set: </span><span class="nx">@mutation</span> <span class="nf">(key, value) -&gt;</span>
      <span class="nv">result = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
      <span class="nx">@fire</span> <span class="s1">&#39;itemsWereAdded&#39;</span><span class="p">,</span> <span class="nx">key</span>
      <span class="nx">result</span>
    <span class="nv">unset: </span><span class="nx">@mutation</span> <span class="nf">(key) -&gt;</span>
      <span class="nv">result = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="nx">unset</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
      <span class="nx">@fire</span> <span class="s1">&#39;itemsWereRemoved&#39;</span><span class="p">,</span> <span class="nx">key</span> <span class="k">if</span> <span class="nx">result</span><span class="o">?</span>
      <span class="nx">result</span>
    <span class="nv">cachable: </span><span class="kc">false</span>

  <span class="nv">clear: </span><span class="nx">@mutation</span> <span class="o">-&gt;</span>
    <span class="nv">keys = </span><span class="nx">@meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;keys&#39;</span><span class="p">)</span>
    <span class="nx">@forEach</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@unset</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
    <span class="nv">result = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="nx">clear</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="nx">@fire</span> <span class="s1">&#39;itemsWereRemoved&#39;</span><span class="p">,</span> <span class="nx">keys</span><span class="p">...</span>
    <span class="nx">result</span>
  <span class="nv">equality: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="nx">equality</span>
  <span class="nv">hashKeyFor: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="nx">hashKeyFor</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;hasKey&#39;</span><span class="p">,</span> <span class="s1">&#39;forEach&#39;</span><span class="p">,</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">,</span> <span class="s1">&#39;merge&#39;</span><span class="p">,</span> <span class="s1">&#39;toJSON&#39;</span><span class="p">]</span>
    <span class="nv">proto = </span><span class="nx">@prototype</span>
    <span class="nx">do</span> <span class="nf">(k) -&gt;</span>
      <span class="nx">proto</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span>
        <span class="nx">@registerAsMutableSource</span><span class="p">()</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@_storage = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="vi">@_indexes = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="vi">@_sorts = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="vi">@length = </span><span class="mi">0</span>
    <span class="nx">@add</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span> <span class="k">if</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>

  <span class="nx">$extendsEnumerable</span><span class="p">(</span><span class="err">@</span><span class="o">::</span><span class="p">)</span>

  <span class="nv">has: </span><span class="nf">(item) -&gt;</span>
    <span class="nx">@_storage</span><span class="p">.</span><span class="nx">hasKey</span> <span class="nx">item</span>

  <span class="nv">add: </span><span class="nf">(items...) -&gt;</span>
    <span class="nv">addedItems = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span> <span class="k">when</span> <span class="o">!</span><span class="nx">@_storage</span><span class="p">.</span><span class="nx">hasKey</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
      <span class="nx">@_storage</span><span class="p">.</span><span class="nx">set</span> <span class="nx">item</span><span class="p">,</span> <span class="kc">true</span>
      <span class="nx">addedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">item</span>
      <span class="nx">@length</span><span class="o">++</span>
    <span class="k">if</span> <span class="nx">@fire</span> <span class="o">and</span> <span class="nx">addedItems</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="nx">@fire</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
      <span class="nx">@fire</span><span class="p">(</span><span class="s1">&#39;itemsWereAdded&#39;</span><span class="p">,</span> <span class="nx">addedItems</span><span class="p">...)</span>
    <span class="nx">addedItems</span>
  <span class="nv">remove: </span><span class="nf">(items...) -&gt;</span>
    <span class="nv">removedItems = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span> <span class="k">when</span> <span class="nx">@_storage</span><span class="p">.</span><span class="nx">hasKey</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
      <span class="nx">@_storage</span><span class="p">.</span><span class="nx">unset</span> <span class="nx">item</span>
      <span class="nx">removedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">item</span>
      <span class="nx">@length</span><span class="o">--</span>
    <span class="k">if</span> <span class="nx">@fire</span> <span class="o">and</span> <span class="nx">removedItems</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="nx">@fire</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
      <span class="nx">@fire</span><span class="p">(</span><span class="s1">&#39;itemsWereRemoved&#39;</span><span class="p">,</span> <span class="nx">removedItems</span><span class="p">...)</span>
    <span class="nx">removedItems</span>
  <span class="nv">forEach: </span><span class="nf">(iterator) -&gt;</span>
    <span class="nx">@_storage</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(key, value) -&gt;</span> <span class="nx">iterator</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="nv">isEmpty: </span><span class="o">-&gt;</span> <span class="nx">@length</span> <span class="o">is</span> <span class="mi">0</span>
  <span class="nv">clear: </span><span class="o">-&gt;</span>
    <span class="nv">items = </span><span class="nx">@toArray</span><span class="p">()</span>
    <span class="vi">@_storage = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="vi">@length = </span><span class="mi">0</span>
    <span class="k">if</span> <span class="nx">@fire</span> <span class="o">and</span> <span class="nx">items</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="nx">@fire</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
      <span class="nx">@fire</span><span class="p">(</span><span class="s1">&#39;itemsWereRemoved&#39;</span><span class="p">,</span> <span class="nx">items</span><span class="p">...)</span>
    <span class="nx">items</span>
  <span class="nv">toArray: </span><span class="o">-&gt;</span>
    <span class="nx">@_storage</span><span class="p">.</span><span class="nx">keys</span><span class="p">()</span>
  <span class="nv">merge: </span><span class="nf">(others...) -&gt;</span>
    <span class="nv">merged = </span><span class="k">new</span> <span class="nx">@constructor</span>
    <span class="nx">others</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">set</span> <span class="k">in</span> <span class="nx">others</span>
      <span class="nx">set</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(v) -&gt;</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">add</span> <span class="nx">v</span>
    <span class="nx">merged</span>
  <span class="nv">indexedBy: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@_indexes</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@_indexes</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SetIndex</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span>
  <span class="nv">sortedBy: </span><span class="nf">(key, order=&quot;asc&quot;) -&gt;</span>
    <span class="nv">order = </span><span class="k">if</span> <span class="nx">order</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">is</span> <span class="s2">&quot;desc&quot;</span> <span class="k">then</span> <span class="s2">&quot;desc&quot;</span> <span class="k">else</span> <span class="s2">&quot;asc&quot;</span>
    <span class="nv">sortsForKey = </span><span class="nx">@_sorts</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@_sorts</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span><span class="p">)</span>
    <span class="nx">sortsForKey</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">order</span><span class="p">)</span> <span class="o">or</span> <span class="nx">sortsForKey</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">order</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SetSort</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">order</span><span class="p">))</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span>

  <span class="nx">$extendsEnumerable</span><span class="p">(</span><span class="err">@</span><span class="o">::</span><span class="p">)</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="s1">&#39;clear&#39;</span><span class="p">,</span> <span class="s1">&#39;indexedBy&#39;</span><span class="p">,</span> <span class="s1">&#39;sortedBy&#39;</span><span class="p">]</span>
    <span class="err">@</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;merge&#39;</span><span class="p">,</span> <span class="s1">&#39;forEach&#39;</span><span class="p">,</span> <span class="s1">&#39;toArray&#39;</span><span class="p">,</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">]</span>
    <span class="nv">proto = </span><span class="nx">@prototype</span>
    <span class="nx">do</span> <span class="nf">(k) -&gt;</span>
      <span class="nx">proto</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span>
        <span class="nx">@registerAsMutableSource</span><span class="p">()</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>

  <span class="nv">toJSON: </span><span class="err">@</span><span class="o">::</span><span class="nx">toArray</span>

  <span class="nx">@accessor</span> <span class="s1">&#39;indexedBy&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">TerminalAccessible</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@indexedBy</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="nx">@accessor</span> <span class="s1">&#39;sortedBy&#39;</span><span class="p">,</span>  <span class="o">-&gt;</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">TerminalAccessible</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@sortedBy</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="nx">@accessor</span> <span class="s1">&#39;sortedByDescending&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">TerminalAccessible</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@sortedBy</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">)</span>
  <span class="nx">@accessor</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">@isEmpty</span><span class="p">()</span>
  <span class="nx">@accessor</span> <span class="s1">&#39;toArray&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">@toArray</span><span class="p">()</span>
  <span class="nx">@accessor</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">@registerAsMutableSource</span><span class="p">()</span>
    <span class="nx">@length</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SetObserver</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nf">(@base) -&gt;</span>
    <span class="vi">@_itemObservers = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="vi">@_setObservers = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="nx">@_setObservers</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;itemsWereAdded&quot;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@fire</span><span class="p">(</span><span class="s1">&#39;itemsWereAdded&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...)</span>
    <span class="nx">@_setObservers</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;itemsWereRemoved&quot;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@fire</span><span class="p">(</span><span class="s1">&#39;itemsWereRemoved&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...)</span>
    <span class="nx">@on</span> <span class="s1">&#39;itemsWereAdded&#39;</span><span class="p">,</span> <span class="nx">@startObservingItems</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="nx">@on</span> <span class="s1">&#39;itemsWereRemoved&#39;</span><span class="p">,</span> <span class="nx">@stopObservingItems</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>

  <span class="nv">observedItemKeys: </span><span class="p">[]</span>
  <span class="nv">observerForItemAndKey: </span><span class="nf">(item, key) -&gt;</span>

  <span class="nv">_getOrSetObserverForItemAndKey: </span><span class="nf">(item, key) -&gt;</span>
    <span class="nx">@_itemObservers</span><span class="p">.</span><span class="nx">getOrSet</span> <span class="nx">item</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="nv">observersByKey = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
      <span class="nx">observersByKey</span><span class="p">.</span><span class="nx">getOrSet</span> <span class="nx">key</span><span class="p">,</span> <span class="o">=&gt;</span>
        <span class="nx">@observerForItemAndKey</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="nv">startObserving: </span><span class="o">-&gt;</span>
    <span class="nx">@_manageItemObservers</span><span class="p">(</span><span class="s2">&quot;observe&quot;</span><span class="p">)</span>
    <span class="nx">@_manageSetObservers</span><span class="p">(</span><span class="s2">&quot;addHandler&quot;</span><span class="p">)</span>
  <span class="nv">stopObserving: </span><span class="o">-&gt;</span>
    <span class="nx">@_manageItemObservers</span><span class="p">(</span><span class="s2">&quot;forget&quot;</span><span class="p">)</span>
    <span class="nx">@_manageSetObservers</span><span class="p">(</span><span class="s2">&quot;removeHandler&quot;</span><span class="p">)</span>
  <span class="nv">startObservingItems: </span><span class="nf">(items...) -&gt;</span>
    <span class="nx">@_manageObserversForItem</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="s2">&quot;observe&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span>
  <span class="nv">stopObservingItems: </span><span class="nf">(items...) -&gt;</span>
    <span class="nx">@_manageObserversForItem</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="s2">&quot;forget&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span>
  <span class="nv">_manageObserversForItem: </span><span class="nf">(item, method) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">item</span><span class="p">.</span><span class="nx">isObservable</span>
    <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">@observedItemKeys</span>
      <span class="nx">item</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">@_getOrSetObserverForItemAndKey</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
    <span class="nx">@_itemObservers</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="k">if</span> <span class="nx">method</span> <span class="o">is</span> <span class="s2">&quot;forget&quot;</span>
  <span class="nv">_manageItemObservers: </span><span class="nf">(method) -&gt;</span>
    <span class="nx">@base</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@_manageObserversForItem</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span>
  <span class="nv">_manageSetObservers: </span><span class="nf">(method) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">isObservable</span>
    <span class="nx">@_setObservers</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">observer</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">@base</span><span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="nx">key</span><span class="p">)[</span><span class="nx">method</span><span class="p">](</span><span class="nx">observer</span><span class="p">)</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SetProxy</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nf">() -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@length = </span><span class="mi">0</span>

  <span class="nx">$extendsEnumerable</span><span class="p">(</span><span class="err">@</span><span class="o">::</span><span class="p">)</span>

  <span class="nv">filter: </span><span class="nf">(f) -&gt;</span>
    <span class="nv">r = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span><span class="p">()</span>
    <span class="nx">@reduce</span><span class="p">((</span><span class="nf">(r, e) -&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="k">if</span> <span class="nx">f</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="nx">r</span><span class="p">),</span> <span class="nx">r</span><span class="p">)</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="s1">&#39;clear&#39;</span><span class="p">]</span>
    <span class="nx">do</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="err">@</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span>
        <span class="nv">results = </span><span class="nx">@base</span><span class="p">[</span><span class="nx">k</span><span class="p">](</span><span class="nx">arguments</span><span class="p">...)</span>
        <span class="vi">@length = </span><span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;length&#39;</span><span class="p">)</span>
        <span class="nx">results</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="s1">&#39;merge&#39;</span><span class="p">,</span> <span class="s1">&#39;toArray&#39;</span><span class="p">,</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">]</span>
    <span class="nx">do</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="err">@</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="nx">@base</span><span class="p">[</span><span class="nx">k</span><span class="p">](</span><span class="nx">arguments</span><span class="p">...)</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="s1">&#39;toArray&#39;</span><span class="p">]</span>
    <span class="nx">do</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">@accessor</span> <span class="nx">k</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>

  <span class="nx">@accessor</span> <span class="s1">&#39;length&#39;</span>
    <span class="nv">get: </span><span class="o">-&gt;</span>
      <span class="nx">@registerAsMutableSource</span><span class="p">()</span>
      <span class="nx">@length</span>
    <span class="nv">set: </span><span class="nf">(k, v) -&gt;</span>
      <span class="vi">@length = </span><span class="nx">v</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SetSort</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SetProxy</span>
  <span class="nv">constructor: </span><span class="nf">(@base, @key, order=&quot;asc&quot;) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@descending = </span><span class="nx">order</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">is</span> <span class="s2">&quot;desc&quot;</span>
    <span class="k">if</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">isObservable</span>
      <span class="vi">@_setObserver = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SetObserver</span><span class="p">(</span><span class="nx">@base</span><span class="p">)</span>
      <span class="vi">@_setObserver.observedItemKeys = </span><span class="p">[</span><span class="nx">@key</span><span class="p">]</span>
      <span class="nv">boundReIndex = </span><span class="nx">@_reIndex</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
      <span class="vi">@_setObserver.observerForItemAndKey = </span><span class="o">-&gt;</span> <span class="nx">boundReIndex</span>
      <span class="nx">@_setObserver</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;itemsWereAdded&#39;</span><span class="p">,</span> <span class="nx">boundReIndex</span>
      <span class="nx">@_setObserver</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;itemsWereRemoved&#39;</span><span class="p">,</span> <span class="nx">boundReIndex</span>
      <span class="nx">@startObserving</span><span class="p">()</span>
    <span class="nx">@_reIndex</span><span class="p">()</span>
  <span class="nv">startObserving: </span><span class="o">-&gt;</span> <span class="nx">@_setObserver</span><span class="o">?</span><span class="p">.</span><span class="nx">startObserving</span><span class="p">()</span>
  <span class="nv">stopObserving: </span><span class="o">-&gt;</span> <span class="nx">@_setObserver</span><span class="o">?</span><span class="p">.</span><span class="nx">stopObserving</span><span class="p">()</span>
  <span class="nv">toArray: </span><span class="o">-&gt;</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;_storage&#39;</span><span class="p">)</span>
  <span class="nx">@accessor</span> <span class="s1">&#39;toArray&#39;</span><span class="p">,</span> <span class="err">@</span><span class="o">::</span><span class="nx">toArray</span>
  <span class="nv">forEach: </span><span class="nf">(iterator) -&gt;</span> <span class="nx">iterator</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span> <span class="k">for</span> <span class="nx">e</span><span class="p">,</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;_storage&#39;</span><span class="p">)</span>
  <span class="nv">compare: </span><span class="nf">(a,b) -&gt;</span>
    <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">is</span> <span class="nx">b</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">is</span> <span class="kc">undefined</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nx">b</span> <span class="o">is</span> <span class="kc">undefined</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">is</span> <span class="kc">null</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nx">b</span> <span class="o">is</span> <span class="kc">null</span>
    <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">isEqual</span><span class="o">?</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">and</span> <span class="nx">b</span><span class="p">.</span><span class="nx">isEqual</span><span class="o">?</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
    <span class="nv">typeComparison = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SetSort</span><span class="o">::</span><span class="nx">compare</span><span class="p">(</span><span class="nx">$typeOf</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
    <span class="k">return</span> <span class="nx">typeComparison</span> <span class="k">if</span> <span class="nx">typeComparison</span> <span class="o">isnt</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">isnt</span> <span class="nx">a</span> <span class="c1"># means a is NaN</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nx">b</span> <span class="o">isnt</span> <span class="nx">b</span> <span class="c1"># means b is NaN</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">b</span>
    <span class="k">return</span> <span class="mi">0</span>
  <span class="nv">_reIndex: </span><span class="o">-&gt;</span>
    <span class="nv">newOrder = </span><span class="nx">@base</span><span class="p">.</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">sort</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nv">valueA = </span><span class="nx">$get</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">@key</span><span class="p">)</span>
      <span class="nv">valueA = </span><span class="nx">valueA</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">()</span> <span class="k">if</span> <span class="nx">valueA</span><span class="o">?</span>
      <span class="nv">valueB = </span><span class="nx">$get</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">@key</span><span class="p">)</span>
      <span class="nv">valueB = </span><span class="nx">valueB</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">()</span> <span class="k">if</span> <span class="nx">valueB</span><span class="o">?</span>
      <span class="nv">multiple = </span><span class="k">if</span> <span class="nx">@descending</span> <span class="k">then</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>
      <span class="nx">@compare</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">valueA</span><span class="p">,</span> <span class="nx">valueB</span><span class="p">)</span> <span class="o">*</span> <span class="nx">multiple</span>
    <span class="nx">@_setObserver</span><span class="o">?</span><span class="p">.</span><span class="nx">startObservingItems</span><span class="p">(</span><span class="nx">newOrder</span><span class="p">...)</span>
    <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;_storage&#39;</span><span class="p">,</span> <span class="nx">newOrder</span><span class="p">)</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SetIndex</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nf">(@base, @key) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@_storage = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="k">if</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">isEventEmitter</span>
      <span class="vi">@_setObserver = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SetObserver</span><span class="p">(</span><span class="nx">@base</span><span class="p">)</span>
      <span class="vi">@_setObserver.observedItemKeys = </span><span class="p">[</span><span class="nx">@key</span><span class="p">]</span>
      <span class="vi">@_setObserver.observerForItemAndKey = </span><span class="nx">@observerForItemAndKey</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
      <span class="nx">@_setObserver</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;itemsWereAdded&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">items</span><span class="p">...)</span> <span class="o">=&gt;</span>
        <span class="nx">@_addItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span>
      <span class="nx">@_setObserver</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;itemsWereRemoved&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">items</span><span class="p">...)</span> <span class="o">=&gt;</span>
        <span class="nx">@_removeItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span>
    <span class="nx">@base</span><span class="p">.</span><span class="nx">forEach</span> <span class="nx">@_addItem</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="nx">@startObserving</span><span class="p">()</span>
  <span class="nx">@accessor</span> <span class="nf">(key) -&gt;</span> <span class="nx">@_resultSetForKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="nv">startObserving: </span><span class="o">-&gt;</span><span class="nx">@_setObserver</span><span class="o">?</span><span class="p">.</span><span class="nx">startObserving</span><span class="p">()</span>
  <span class="nv">stopObserving: </span><span class="o">-&gt;</span> <span class="nx">@_setObserver</span><span class="o">?</span><span class="p">.</span><span class="nx">stopObserving</span><span class="p">()</span>
  <span class="nv">observerForItemAndKey: </span><span class="nf">(item, key) -&gt;</span>
    <span class="p">(</span><span class="nx">newValue</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">@_removeItemFromKey</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span>
      <span class="nx">@_addItemToKey</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">newValue</span><span class="p">)</span>
  <span class="nv">_addItem: </span><span class="nf">(item) -&gt;</span> <span class="nx">@_addItemToKey</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">@_keyForItem</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span>
  <span class="nv">_addItemToKey: </span><span class="nf">(item, key) -&gt;</span>
    <span class="nx">@_resultSetForKey</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">add</span> <span class="nx">item</span>
  <span class="nv">_removeItem: </span><span class="nf">(item) -&gt;</span> <span class="nx">@_removeItemFromKey</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">@_keyForItem</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span>
  <span class="nv">_removeItemFromKey: </span><span class="nf">(item, key) -&gt;</span>
    <span class="nv">results = </span><span class="nx">@_resultSetForKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="nx">results</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">item</span>
    <span class="nx">@_storage</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="k">if</span> <span class="nx">results</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
  <span class="nv">_resultSetForKey: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@_storage</span><span class="p">.</span><span class="nx">getOrSet</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span><span class="p">)</span>
  <span class="nv">_keyForItem: </span><span class="nf">(item) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">Keypath</span><span class="p">.</span><span class="nx">forBaseAndKey</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">@key</span><span class="p">).</span><span class="nx">getValue</span><span class="p">()</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">UniqueSetIndex</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SetIndex</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@_uniqueIndex = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Hash</span>
    <span class="k">super</span>
  <span class="nx">@accessor</span> <span class="nf">(key) -&gt;</span> <span class="nx">@_uniqueIndex</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="nv">_addItemToKey: </span><span class="nf">(item, key) -&gt;</span>
    <span class="nx">@_resultSetForKey</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">add</span> <span class="nx">item</span>
    <span class="nx">unless</span> <span class="nx">@_uniqueIndex</span><span class="p">.</span><span class="nx">hasKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
      <span class="nx">@_uniqueIndex</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span>
  <span class="nv">_removeItemFromKey: </span><span class="nf">(item, key) -&gt;</span>
    <span class="nv">resultSet = </span><span class="nx">@_resultSetForKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">super</span>
    <span class="k">if</span> <span class="nx">resultSet</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
      <span class="nx">@_uniqueIndex</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@_uniqueIndex</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">resultSet</span><span class="p">.</span><span class="nx">toArray</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <h2>State Machines</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.StateMachine = </span><span class="p">{</span>
  <span class="nv">initialize: </span><span class="o">-&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">states</span>
      <span class="vi">@_batman.states = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>

  <span class="nv">state: </span><span class="nf">(name, callback) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>

    <span class="k">return</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">getFirst</span> <span class="s1">&#39;state&#39;</span> <span class="nx">unless</span> <span class="nx">name</span>
    <span class="nx">developer</span><span class="p">.</span><span class="nx">assert</span> <span class="nx">@isEventEmitter</span><span class="p">,</span> <span class="s2">&quot;StateMachine requires EventEmitter&quot;</span>

    <span class="err">@</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">||=</span> <span class="nf">(callback) -&gt;</span> <span class="nx">_stateMachine_setState</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
    <span class="nx">@on</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">callback</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>

  <span class="nv">transition: </span><span class="nf">(from, to, callback) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>
    <span class="nx">@state</span> <span class="nx">from</span>
    <span class="nx">@state</span> <span class="nx">to</span>
    <span class="nx">@on</span><span class="p">(</span><span class="s2">&quot;#{from}-&gt;#{to}&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="k">if</span> <span class="nx">callback</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>A special method to alias state machine methods to class methods</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.Object.actsAsStateMachine = </span><span class="nf">(includeInstanceMethods=true) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@prototype</span>

    <span class="vi">@classState = </span><span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="vi">@state = </span><span class="o">-&gt;</span> <span class="nx">@classState</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@prototype</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="err">@</span><span class="o">::</span><span class="nv">state = </span><span class="nx">@classState</span> <span class="k">if</span> <span class="nx">includeInstanceMethods</span>

    <span class="vi">@classTransition = </span><span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">transition</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="vi">@transition = </span><span class="o">-&gt;</span> <span class="nx">@classTransition</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@prototype</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="err">@</span><span class="o">::</span><span class="nv">transition = </span><span class="nx">@classTransition</span> <span class="k">if</span> <span class="nx">includeInstanceMethods</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>This is cached here so it doesn't need to be recompiled for every setter</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_stateMachine_setState = </span><span class="nf">(newState) -&gt;</span>
  <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>

  <span class="k">if</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">isTransitioning</span>
    <span class="p">(</span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">nextState</span> <span class="o">||=</span> <span class="p">[]).</span><span class="nx">push</span><span class="p">(</span><span class="nx">newState</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">false</span>

  <span class="vi">@_batman.isTransitioning = </span><span class="kc">yes</span>

  <span class="nv">oldState = </span><span class="nx">@state</span><span class="p">()</span>
  <span class="vi">@_batman.state = </span><span class="nx">newState</span>

  <span class="k">if</span> <span class="nx">newState</span> <span class="o">and</span> <span class="nx">oldState</span>
    <span class="nx">@fire</span><span class="p">(</span><span class="s2">&quot;#{oldState}-&gt;#{newState}&quot;</span><span class="p">,</span> <span class="nx">newState</span><span class="p">,</span> <span class="nx">oldState</span><span class="p">)</span>

  <span class="k">if</span> <span class="nx">newState</span>
    <span class="nx">@fire</span><span class="p">(</span><span class="nx">newState</span><span class="p">,</span> <span class="nx">newState</span><span class="p">,</span> <span class="nx">oldState</span><span class="p">)</span>

  <span class="vi">@_batman.isTransitioning = </span><span class="kc">no</span>
  <span class="err">@</span><span class="p">[</span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">nextState</span><span class="p">.</span><span class="nx">shift</span><span class="p">()]()</span> <span class="k">if</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">nextState</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span>

  <span class="nx">newState</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <h2>App, Requests, and Routing</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p><code>Batman.Request</code> is a normalizer for XHR requests in the Batman world.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="vi">@objectToFormData: </span><span class="nf">(data) -&gt;</span>
    <span class="nv">pairForList = </span><span class="nf">(key, object, first = false) -&gt;</span>
      <span class="nv">list = </span><span class="k">switch</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">typeOf</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span>
        <span class="k">when</span> <span class="s1">&#39;Object&#39;</span>
          <span class="nv">list = </span><span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">object</span>
            <span class="nx">pairForList</span><span class="p">((</span><span class="k">if</span> <span class="nx">first</span> <span class="k">then</span> <span class="nx">k</span> <span class="k">else</span> <span class="s2">&quot;#{key}[#{k}]&quot;</span><span class="p">),</span> <span class="nx">v</span><span class="p">)</span>
          <span class="nx">list</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nf">(acc, list) -&gt;</span>
            <span class="nx">acc</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">list</span>
          <span class="p">,</span> <span class="p">[])</span>
        <span class="k">when</span> <span class="s1">&#39;Array&#39;</span>
          <span class="nx">object</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nf">(acc, element) -&gt;</span>
            <span class="nx">acc</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">pairForList</span><span class="p">(</span><span class="s2">&quot;#{key}[]&quot;</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span>
          <span class="p">,</span> <span class="p">[])</span>
        <span class="k">else</span>
          <span class="p">[[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">object</span><span class="p">]]</span>

    <span class="nv">formData = </span><span class="k">new</span> <span class="nx">FormData</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">]</span> <span class="k">in</span> <span class="nx">pairForList</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
      <span class="nx">formData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span>
    <span class="nx">formData</span>

  <span class="nv">url: </span><span class="s1">&#39;&#39;</span>
  <span class="nv">data: </span><span class="s1">&#39;&#39;</span>
  <span class="nv">method: </span><span class="s1">&#39;get&#39;</span>
  <span class="nv">formData: </span><span class="kc">false</span>
  <span class="nv">response: </span><span class="kc">null</span>
  <span class="nv">status: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Set the content type explicitly for PUT and POST requests.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">contentType: </span><span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>

  <span class="nv">constructor: </span><span class="nf">(options) -&gt;</span>
    <span class="nv">handlers = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">handler</span> <span class="k">of</span> <span class="nx">options</span> <span class="k">when</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;loading&#39;</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">]</span>
      <span class="nx">handlers</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">handler</span>
      <span class="k">delete</span> <span class="nx">options</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>

    <span class="k">super</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
    <span class="nx">@on</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">handler</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">handler</span> <span class="k">of</span> <span class="nx">handlers</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>After the URL gets set, we'll try to automatically send
your request after a short period. If this behavior is
not desired, use @cancel() after setting the URL.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@observeAll</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="vi">@_autosendTimeout = </span><span class="nx">$setImmediate</span> <span class="o">=&gt;</span> <span class="nx">@send</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p><code>send</code> is implmented in the platform layer files. One of those must be required for
<code>Batman.Request</code> to be useful.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">send: </span><span class="nf">() -&gt;</span> <span class="nx">developer</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;Please source a dependency file for a request implementation&quot;</span>

  <span class="nv">cancel: </span><span class="o">-&gt;</span>
    <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">@_autosendTimeout</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@_autosendTimeout</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p><code>Batman.App</code> manages requiring files and acts as a namespace for all code subclassing
Batman objects.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">App</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Require path tells the require methods which base directory to look in.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@requirePath: </span><span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>The require class methods (<code>controller</code>, <code>model</code>, <code>view</code>) simply tells
your app where to look for coffeescript source files. This
implementation may change in the future.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">developer</span><span class="p">.</span><span class="nx">do</span> <span class="o">=&gt;</span>
    <span class="nv">App.require = </span><span class="nf">(path, names...) -&gt;</span>
      <span class="nv">base = </span><span class="nx">@requirePath</span> <span class="o">+</span> <span class="nx">path</span>
      <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">names</span>
        <span class="nx">@prevent</span> <span class="s1">&#39;run&#39;</span>

        <span class="nv">path = </span><span class="nx">base</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;.coffee&#39;</span>
        <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span>
          <span class="nv">url: </span><span class="nx">path</span>
          <span class="nv">type: </span><span class="s1">&#39;html&#39;</span>
          <span class="nv">success: </span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">CoffeeScript</span><span class="p">.</span><span class="nb">eval</span> <span class="nx">response</span>
            <span class="nx">@allow</span> <span class="s1">&#39;run&#39;</span>
            <span class="k">if</span> <span class="o">not</span> <span class="nx">@isPrevented</span> <span class="s1">&#39;run&#39;</span>
              <span class="nx">@fire</span> <span class="s1">&#39;loaded&#39;</span>

            <span class="nx">@run</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@wantsToRun</span>
      <span class="err">@</span>

    <span class="vi">@controller = </span><span class="nf">(names...) -&gt;</span>
      <span class="nv">names = </span><span class="nx">names</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(n) -&gt;</span> <span class="nx">n</span> <span class="o">+</span> <span class="s1">&#39;_controller&#39;</span>
      <span class="nx">@require</span> <span class="s1">&#39;controllers&#39;</span><span class="p">,</span> <span class="nx">names</span><span class="p">...</span>

    <span class="vi">@model = </span><span class="o">-&gt;</span>
      <span class="nx">@require</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span>

    <span class="vi">@view = </span><span class="o">-&gt;</span>
      <span class="nx">@require</span> <span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Layout is the base view that other views can be yielded into. The
default behavior is that when <code>app.run()</code> is called, a new view will
be created for the layout using the <code>document</code> node as its content.
Use <code>MyApp.layout = null</code> to turn off the default behavior.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@layout: </span><span class="kc">undefined</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Call <code>MyApp.run()</code> to start up an app. Batman level initializers will
be run to bootstrap the application.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@event</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">).</span><span class="nv">oneShot = </span><span class="kc">true</span>
  <span class="nx">@event</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">).</span><span class="nv">oneShot = </span><span class="kc">true</span>
  <span class="vi">@run: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span> <span class="o">is</span> <span class="err">@</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>

    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">@hasRun</span>

    <span class="k">if</span> <span class="nx">@isPrevented</span> <span class="s1">&#39;run&#39;</span>
      <span class="vi">@wantsToRun = </span><span class="kc">true</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="k">else</span>
      <span class="k">delete</span> <span class="nx">@wantsToRun</span>

    <span class="nv">Batman.currentApp = </span><span class="err">@</span>

    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">@dispatcher</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
      <span class="nx">@dispatcher</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Dispatcher</span> <span class="err">@</span>

    <span class="nx">@observe</span> <span class="s1">&#39;layout&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">layout</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">layout</span><span class="o">?</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@fire</span> <span class="s1">&#39;ready&#39;</span>

    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">@layout</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
      <span class="nx">@set</span> <span class="s1">&#39;layout&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span>
        <span class="nv">contexts: </span><span class="p">[</span><span class="err">@</span><span class="p">]</span>
        <span class="nv">node: </span><span class="nb">document</span>
    <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">@layout</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
      <span class="nx">@set</span> <span class="s1">&#39;layout&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="err">@</span><span class="p">[</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">camelize</span><span class="p">(</span><span class="nx">@layout</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;View&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">@navigator</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">and</span> <span class="nx">@dispatcher</span><span class="p">.</span><span class="nx">routeMap</span>
      <span class="nx">@on</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
        <span class="vi">@navigator = </span><span class="nv">Batman.navigator = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Navigator</span><span class="p">.</span><span class="nx">forApp</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="nx">@navigator</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>

    <span class="vi">@hasRun = </span><span class="kc">yes</span>
    <span class="nx">@fire</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">)</span>
    <span class="err">@</span>

  <span class="nx">@event</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">).</span><span class="nv">oneShot = </span><span class="kc">true</span>

  <span class="nx">@event</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">).</span><span class="nv">oneShot = </span><span class="kc">true</span>
  <span class="vi">@stop: </span><span class="o">-&gt;</span>
    <span class="nx">@navigator</span><span class="o">?</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
    <span class="nv">Batman.navigator = </span><span class="kc">null</span>
    <span class="vi">@hasRun = </span><span class="kc">no</span>
    <span class="nx">@fire</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>
    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <h2>Dispatcher</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Route</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Route regexes courtesy of Backbone</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">namedParam = </span><span class="sr">/:([\w\d]+)/g</span>
  <span class="nv">splatParam = </span><span class="sr">/\*([\w\d]+)/g</span>
  <span class="nv">queryParam = </span><span class="s1">&#39;(?:\\?.+)?&#39;</span>
  <span class="nv">namedOrSplat = </span><span class="sr">/[:|\*]([\w\d]+)/g</span>
  <span class="nv">escapeRegExp = </span><span class="sr">/[-[\]{}()+?.,\\^$|#\s]/g</span>

  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span>

    <span class="vi">@pattern = </span><span class="nx">@url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">escapeRegExp</span><span class="p">,</span> <span class="s1">&#39;\\$&amp;&#39;</span><span class="p">)</span>
    <span class="vi">@regexp = </span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">@pattern</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">namedParam</span><span class="p">,</span> <span class="s1">&#39;([^\/]*)&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">splatParam</span><span class="p">,</span> <span class="s1">&#39;(.*?)&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">queryParam</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">)</span>

    <span class="vi">@namedArguments = </span><span class="p">[]</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">array = </span><span class="nx">namedOrSplat</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">@pattern</span><span class="p">))</span><span class="o">?</span>
      <span class="nx">@namedArguments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nx">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

  <span class="nx">@accessor</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="o">-&gt;</span>
      <span class="k">return</span> <span class="nx">@action</span> <span class="k">if</span> <span class="nx">@action</span>

      <span class="k">if</span> <span class="nx">@options</span>
        <span class="nv">result = </span><span class="nx">$mixin</span> <span class="p">{},</span> <span class="nx">@options</span>

        <span class="k">if</span> <span class="nv">signature = </span><span class="nx">result</span><span class="p">.</span><span class="nx">signature</span>
          <span class="nv">components = </span><span class="nx">signature</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
          <span class="nv">result.controller = </span><span class="nx">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="nv">result.action = </span><span class="nx">components</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;index&#39;</span>

        <span class="nv">result.target = </span><span class="nx">@dispatcher</span><span class="p">.</span><span class="nx">get</span> <span class="nx">result</span><span class="p">.</span><span class="nx">controller</span>
        <span class="nx">@set</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="nx">result</span>
    <span class="nv">set: </span><span class="nf">(key, action) -&gt;</span>
      <span class="vi">@action = </span><span class="nx">action</span>

  <span class="nv">parameterize: </span><span class="nf">(url) -&gt;</span>
    <span class="p">[</span><span class="nx">url</span><span class="p">,</span> <span class="nx">query</span><span class="p">]</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;?&#39;</span>
    <span class="nv">array = </span><span class="nx">@regexp</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">params = url: </span><span class="nx">url</span>

    <span class="nv">action = </span><span class="nx">@get</span> <span class="s1">&#39;action&#39;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">action</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nv">params.action = </span><span class="nx">action</span>
    <span class="k">else</span>
      <span class="nx">$mixin</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">action</span>

    <span class="k">if</span> <span class="nx">array</span>
      <span class="k">for</span> <span class="nx">param</span><span class="p">,</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">array</span>
        <span class="nx">params</span><span class="p">[</span><span class="nx">@namedArguments</span><span class="p">[</span><span class="nx">index</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">param</span>

    <span class="k">if</span> <span class="nx">query</span>
      <span class="k">for</span> <span class="nx">s</span> <span class="k">in</span> <span class="nx">query</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;&amp;&#39;</span>
        <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">]</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;=&#39;</span>
        <span class="nx">params</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="nx">params</span>

  <span class="nv">dispatch: </span><span class="nf">(url) -&gt;</span>
    <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;String&#39;</span>
      <span class="nv">params = </span><span class="nx">@parameterize</span> <span class="nx">url</span>

    <span class="nx">$redirect</span><span class="p">(</span><span class="s1">&#39;/404&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nv">action = </span><span class="nx">params</span><span class="p">.</span><span class="nx">action</span><span class="p">)</span> <span class="o">and</span> <span class="nx">url</span> <span class="o">isnt</span> <span class="s1">&#39;/404&#39;</span>
    <span class="k">return</span> <span class="nx">action</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">action</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="k">return</span> <span class="nx">params</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="nx">action</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="k">if</span> <span class="nx">params</span><span class="p">.</span><span class="nx">target</span><span class="o">?</span><span class="p">.</span><span class="nx">dispatch</span>
    <span class="k">return</span> <span class="nx">params</span><span class="p">.</span><span class="nx">target</span><span class="o">?</span><span class="p">[</span><span class="nx">action</span><span class="p">](</span><span class="nx">params</span><span class="p">)</span>


<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Dispatcher</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nf">(@app) -&gt;</span>
    <span class="nx">@app</span><span class="p">.</span><span class="nx">route</span> <span class="err">@</span>

    <span class="vi">@app.controllers = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">controller</span> <span class="k">of</span> <span class="nx">@app</span>
      <span class="k">continue</span> <span class="nx">unless</span> <span class="nx">controller</span><span class="o">?</span><span class="p">.</span><span class="nx">prototype</span> <span class="k">instanceof</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Controller</span>
      <span class="nx">@prepareController</span> <span class="nx">controller</span>

  <span class="nv">prepareController: </span><span class="nf">(controller) -&gt;</span>
    <span class="nv">name = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">$functionName</span><span class="p">(</span><span class="nx">controller</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;Controller&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">name</span>

    <span class="nv">getter = </span><span class="o">-&gt;</span> <span class="err">@</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;sharedController&#39;</span>
    <span class="nx">@accessor</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">getter</span>
    <span class="nx">@app</span><span class="p">.</span><span class="nx">controllers</span><span class="p">.</span><span class="nx">accessor</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">getter</span>

  <span class="nv">register: </span><span class="nf">(url, options) -&gt;</span>
    <span class="nv">url = </span><span class="s2">&quot;/#{url}&quot;</span> <span class="k">if</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="mi">0</span>
    <span class="nv">route = </span><span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;Function&#39;</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Route</span> <span class="nv">url: </span><span class="nx">url</span><span class="p">,</span> <span class="nv">action: </span><span class="nx">options</span><span class="p">,</span> <span class="nv">dispatcher: </span><span class="err">@</span>
    <span class="k">else</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Route</span> <span class="nv">url: </span><span class="nx">url</span><span class="p">,</span> <span class="nv">options: </span><span class="nx">options</span><span class="p">,</span> <span class="nv">dispatcher: </span><span class="err">@</span>

    <span class="nx">@routeMap</span> <span class="o">||=</span> <span class="p">{}</span>
    <span class="nx">@routeMap</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="nx">route</span>

  <span class="nv">findRoute: </span><span class="nf">(url) -&gt;</span>
    <span class="nv">url = </span><span class="s2">&quot;/#{url}&quot;</span> <span class="k">if</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="nx">route</span> <span class="k">if</span> <span class="p">(</span><span class="nv">route = </span><span class="nx">@routeMap</span><span class="p">[</span><span class="nx">url</span><span class="p">])</span>
    <span class="k">for</span> <span class="nx">routeUrl</span><span class="p">,</span> <span class="nx">route</span> <span class="k">of</span> <span class="nx">@routeMap</span>
      <span class="k">return</span> <span class="nx">route</span> <span class="k">if</span> <span class="nx">route</span><span class="p">.</span><span class="nx">regexp</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>

  <span class="nv">findUrl: </span><span class="nf">(params) -&gt;</span>
    <span class="k">for</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">route</span> <span class="k">of</span> <span class="nx">@routeMap</span>
      <span class="nv">matches = </span><span class="kc">no</span>
      <span class="nv">options = </span><span class="nx">route</span><span class="p">.</span><span class="nx">options</span>
      <span class="k">if</span> <span class="nx">params</span><span class="p">.</span><span class="nx">resource</span>
        <span class="nv">matches = </span><span class="nx">options</span><span class="p">.</span><span class="nx">resource</span> <span class="o">is</span> <span class="nx">params</span><span class="p">.</span><span class="nx">resource</span> <span class="o">and</span>
          <span class="nx">options</span><span class="p">.</span><span class="nx">action</span> <span class="o">is</span> <span class="nx">params</span><span class="p">.</span><span class="nx">action</span>
      <span class="k">else</span>
        <span class="nv">action = </span><span class="nx">route</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;action&#39;</span>
        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">action</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
          <span class="nv">matches = </span><span class="kc">yes</span>
        <span class="k">else</span>
          <span class="p">{</span><span class="nx">controller</span><span class="p">,</span> <span class="nx">action</span><span class="p">}</span> <span class="o">=</span> <span class="nx">action</span>
          <span class="k">if</span> <span class="nx">controller</span> <span class="o">is</span> <span class="nx">params</span><span class="p">.</span><span class="nx">controller</span> <span class="o">and</span> <span class="nx">action</span> <span class="o">is</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">action</span> <span class="o">||</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>
            <span class="nv">matches = </span><span class="kc">yes</span>

      <span class="k">continue</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">matches</span>
      <span class="nx">$mixin</span> <span class="nv">paramsCopy = </span><span class="p">{},</span> <span class="nx">params</span>
      <span class="nx">$unmixin</span> <span class="nx">paramsCopy</span><span class="p">,</span> <span class="p">{</span><span class="nx">controller</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="nx">resource</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="nx">signature</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="nx">target</span><span class="o">:</span><span class="kc">null</span><span class="p">}</span>

      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">params</span>
        <span class="nv">regex = </span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;[:|\*]&#39;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">)</span>
        <span class="k">continue</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">test</span> <span class="nx">url</span>

        <span class="nv">url = </span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">regex</span><span class="p">,</span> <span class="nx">value</span>
        <span class="nx">paramsCopy</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
        <span class="k">delete</span> <span class="nx">paramsCopy</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>

      <span class="nv">queryString = </span><span class="s1">&#39;&#39;</span>
      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">paramsCopy</span>
        <span class="nx">queryString</span> <span class="o">+=</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">queryString</span> <span class="k">then</span> <span class="s1">&#39;?&#39;</span> <span class="k">else</span> <span class="s1">&#39;&amp;&#39;</span>
        <span class="nx">queryString</span> <span class="o">+=</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nx">value</span>

      <span class="k">return</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">queryString</span>

  <span class="nv">pathFromParams: </span><span class="nf">(params) -&gt;</span>
    <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;String&#39;</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">Navigator</span><span class="p">.</span><span class="nx">normalizePath</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@findUrl</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>

  <span class="nv">dispatch: </span><span class="nf">(params) -&gt;</span>
    <span class="nv">url = </span><span class="nx">@pathFromParams</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
    <span class="nv">route = </span><span class="nx">@findRoute</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">route</span>
      <span class="nx">route</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">url</span> <span class="o">isnt</span> <span class="s1">&#39;/404&#39;</span>
      <span class="nx">$redirect</span><span class="p">(</span><span class="s1">&#39;/404&#39;</span><span class="p">)</span>

    <span class="nx">@app</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;currentURL&#39;</span><span class="p">,</span> <span class="nx">url</span>
    <span class="nx">@app</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;currentRoute&#39;</span><span class="p">,</span> <span class="nx">route</span>
    <span class="nx">@app</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;currentParams&#39;</span><span class="p">,</span> <span class="nx">params</span>
    <span class="nx">url</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Navigator</span>
  <span class="vi">@defaultClass: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">usePushState</span> <span class="o">and</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">PushStateNavigator</span><span class="p">.</span><span class="nx">isSupported</span><span class="p">()</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">PushStateNavigator</span>
    <span class="k">else</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">HashbangNavigator</span>
  <span class="vi">@forApp: </span><span class="nf">(app) -&gt;</span> <span class="k">new</span> <span class="p">(</span><span class="nx">@defaultClass</span><span class="p">())(</span><span class="nx">app</span><span class="p">)</span>
  <span class="nv">constructor: </span><span class="nf">(@app) -&gt;</span>
  <span class="nv">start: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@started</span>
    <span class="vi">@started = </span><span class="kc">yes</span>
    <span class="nx">@startWatching</span><span class="p">()</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span><span class="p">.</span><span class="nx">prevent</span> <span class="s1">&#39;ready&#39;</span>
    <span class="nx">$setImmediate</span> <span class="o">=&gt;</span>
      <span class="nx">@handleCurrentLocation</span><span class="p">()</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span><span class="p">.</span><span class="nx">allowAndFire</span> <span class="s1">&#39;ready&#39;</span>
  <span class="nv">stop: </span><span class="o">-&gt;</span>
    <span class="nx">@stopWatching</span><span class="p">()</span>
    <span class="vi">@started = </span><span class="kc">no</span>
  <span class="nv">handleLocation: </span><span class="nf">(location) -&gt;</span>
    <span class="nv">path = </span><span class="nx">@pathFromLocation</span><span class="p">(</span><span class="nx">location</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">path</span> <span class="o">is</span> <span class="nx">@cachedPath</span>
    <span class="nx">@dispatch</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
  <span class="nv">handleCurrentLocation: </span><span class="o">=&gt;</span> <span class="nx">@handleLocation</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span>
  <span class="nv">dispatch: </span><span class="nf">(params) -&gt;</span>
    <span class="vi">@cachedPath = </span><span class="nx">@app</span><span class="p">.</span><span class="nx">dispatcher</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
  <span class="nv">push: </span><span class="nf">(params) -&gt;</span>
    <span class="nv">path = </span><span class="nx">@dispatch</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
    <span class="nx">@pushState</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
    <span class="nx">path</span>
  <span class="nv">replace: </span><span class="nf">(params) -&gt;</span>
    <span class="nv">path = </span><span class="nx">@dispatch</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
    <span class="nx">@replaceState</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
    <span class="nx">path</span>
  <span class="nv">redirect: </span><span class="err">@</span><span class="o">::</span><span class="nx">push</span>
  <span class="nv">normalizePath: </span><span class="nf">(segments...) -&gt;</span>
    <span class="nv">segments = </span><span class="k">for</span> <span class="nx">seg</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">segments</span>
      <span class="s2">&quot;#{seg}&quot;</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(?!\/)/</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/+$/</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nx">segments</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="s1">&#39;/&#39;</span>
  <span class="vi">@normalizePath: </span><span class="err">@</span><span class="o">::</span><span class="nx">normalizePath</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">PushStateNavigator</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Navigator</span>
  <span class="vi">@isSupported: </span><span class="o">-&gt;</span> <span class="nb">window</span><span class="o">?</span><span class="p">.</span><span class="nx">history</span><span class="o">?</span><span class="p">.</span><span class="nx">pushState</span><span class="o">?</span>
  <span class="nv">startWatching: </span><span class="o">-&gt;</span>
    <span class="nx">$addEventListener</span> <span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;popstate&#39;</span><span class="p">,</span> <span class="nx">@handleCurrentLocation</span>
  <span class="nv">stopWatching: </span><span class="o">-&gt;</span>
    <span class="nx">$removeEventListener</span> <span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;popstate&#39;</span><span class="p">,</span> <span class="nx">@handleCurrentLocation</span>
  <span class="nv">pushState: </span><span class="nf">(stateObject, title, path) -&gt;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span><span class="p">(</span><span class="nx">stateObject</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">@linkTo</span><span class="p">(</span><span class="nx">path</span><span class="p">))</span>
  <span class="nv">replaceState: </span><span class="nf">(stateObject, title, path) -&gt;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span><span class="p">(</span><span class="nx">stateObject</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">@linkTo</span><span class="p">(</span><span class="nx">path</span><span class="p">))</span>
  <span class="nv">linkTo: </span><span class="nf">(url) -&gt;</span>
    <span class="nx">@normalizePath</span><span class="p">(</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">pathPrefix</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span>
  <span class="nv">pathFromLocation: </span><span class="nf">(location) -&gt;</span>
    <span class="nv">fullPath = </span><span class="s2">&quot;#{location.pathname or &#39;&#39;}#{location.search or &#39;&#39;}&quot;</span>
    <span class="nv">prefixPattern = </span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;^#{@normalizePath(Batman.config.pathPrefix)}&quot;</span><span class="p">)</span>
    <span class="nx">@normalizePath</span><span class="p">(</span><span class="nx">fullPath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">prefixPattern</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
  <span class="nv">handleLocation: </span><span class="nf">(location) -&gt;</span>
    <span class="nv">path = </span><span class="nx">@pathFromLocation</span><span class="p">(</span><span class="nx">location</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">path</span> <span class="o">is</span> <span class="s1">&#39;/&#39;</span> <span class="o">and</span> <span class="p">(</span><span class="nv">hashbangPath = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">HashbangNavigator</span><span class="o">::</span><span class="nx">pathFromLocation</span><span class="p">(</span><span class="nx">location</span><span class="p">))</span> <span class="o">isnt</span> <span class="s1">&#39;/&#39;</span>
      <span class="nx">@replace</span><span class="p">(</span><span class="nx">hashbangPath</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">super</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">HashbangNavigator</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Navigator</span>
  <span class="nv">HASH_PREFIX: </span><span class="s1">&#39;#!&#39;</span>
  <span class="k">if</span> <span class="nb">window</span><span class="o">?</span> <span class="o">and</span> <span class="s1">&#39;onhashchange&#39;</span> <span class="k">of</span> <span class="nb">window</span>
    <span class="err">@</span><span class="o">::</span><span class="nv">startWatching = </span><span class="o">-&gt;</span>
      <span class="nx">$addEventListener</span> <span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;hashchange&#39;</span><span class="p">,</span> <span class="nx">@handleCurrentLocation</span>
    <span class="err">@</span><span class="o">::</span><span class="nv">stopWatching = </span><span class="o">-&gt;</span>
      <span class="nx">$removeEventListener</span> <span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;hashchange&#39;</span><span class="p">,</span> <span class="nx">@handleCurrentLocation</span>
  <span class="k">else</span>
    <span class="err">@</span><span class="o">::</span><span class="nv">startWatching = </span><span class="o">-&gt;</span>
      <span class="vi">@interval = </span><span class="nx">setInterval</span> <span class="nx">@handleCurrentLocation</span><span class="p">,</span> <span class="mi">100</span>
    <span class="err">@</span><span class="o">::</span><span class="nv">stopWatching = </span><span class="o">-&gt;</span>
      <span class="vi">@interval = </span><span class="nx">clearInterval</span> <span class="nx">@interval</span>
  <span class="nv">pushState: </span><span class="nf">(stateObject, title, path) -&gt;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">location.hash = </span><span class="nx">@linkTo</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
  <span class="nv">replaceState: </span><span class="nf">(stateObject, title, path) -&gt;</span>
    <span class="nv">loc = </span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span>
    <span class="nx">loc</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;#{loc.pathname}#{loc.search}#{@linkTo(path)}&quot;</span><span class="p">)</span>
  <span class="nv">linkTo: </span><span class="nf">(url) -&gt;</span> <span class="nx">@HASH_PREFIX</span> <span class="o">+</span> <span class="nx">url</span>
  <span class="nv">pathFromLocation: </span><span class="nf">(location) -&gt;</span>
    <span class="nv">hash = </span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span>
    <span class="k">if</span> <span class="nx">hash</span><span class="o">?</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">is</span> <span class="nx">@HASH_PREFIX</span>
      <span class="nx">@normalizePath</span><span class="p">(</span><span class="nx">hash</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span>
      <span class="s1">&#39;/&#39;</span>
  <span class="nv">handleLocation: </span><span class="nf">(location) -&gt;</span>
    <span class="k">return</span> <span class="k">super</span> <span class="nx">unless</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">usePushState</span>
    <span class="nv">realPath = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">PushStateNavigator</span><span class="o">::</span><span class="nx">pathFromLocation</span><span class="p">(</span><span class="nx">location</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">realPath</span> <span class="o">is</span> <span class="s1">&#39;/&#39;</span>
      <span class="k">super</span>
    <span class="k">else</span>
      <span class="nx">location</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">@normalizePath</span><span class="p">(</span><span class="s2">&quot;#{Batman.config.pathPrefix}#{@linkTo(realPath)}&quot;</span><span class="p">))</span>


<span class="nv">Batman.redirect = $redirect = </span><span class="nf">(url) -&gt;</span>
  <span class="nx">Batman</span><span class="p">.</span><span class="nx">navigator</span><span class="o">?</span><span class="p">.</span><span class="nx">redirect</span> <span class="nx">url</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <h2>Route Declarators</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Batman</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">classMixin</span>
  <span class="nv">route: </span><span class="nf">(url, signature, options={}) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">url</span>
    <span class="k">if</span> <span class="nx">url</span> <span class="k">instanceof</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Dispatcher</span>
      <span class="nv">dispatcher = </span><span class="nx">url</span>
      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@_dispatcherCache</span>
        <span class="nx">dispatcher</span><span class="p">.</span><span class="nx">register</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span>

      <span class="vi">@_dispatcherCache = </span><span class="kc">null</span>
      <span class="k">return</span> <span class="nx">dispatcher</span>

    <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">signature</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;String&#39;</span>
      <span class="nv">options.signature = </span><span class="nx">signature</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">signature</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;Function&#39;</span>
      <span class="nv">options = </span><span class="nx">signature</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">signature</span>
      <span class="nx">$mixin</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">signature</span>

    <span class="nx">@_dispatcherCache</span> <span class="o">||=</span> <span class="p">{}</span>
    <span class="nx">@_dispatcherCache</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span>

  <span class="nv">root: </span><span class="nf">(signature, options) -&gt;</span>
    <span class="nx">@route</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">signature</span><span class="p">,</span> <span class="nx">options</span>

  <span class="nv">resources: </span><span class="nf">(resource, options={}, callback) -&gt;</span>
    <span class="p">(</span><span class="nv">callback = </span><span class="nx">options</span><span class="p">;</span> <span class="nv">options = </span><span class="p">{})</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">options</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="nv">resource = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">resource</span><span class="p">)</span>
    <span class="nv">controller = </span><span class="nx">options</span><span class="p">.</span><span class="nx">controller</span> <span class="o">||</span> <span class="nx">resource</span>
    <span class="nv">resource = </span><span class="s2">&quot;#{options.parentResource}/:#{helpers.singularize(options.parentResource)}Id/#{resource}&quot;</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">parentResource</span>

    <span class="nx">@route</span><span class="p">(</span><span class="nx">resource</span><span class="p">,</span> <span class="s2">&quot;#{controller}#index&quot;</span><span class="p">,</span> <span class="nv">resource: </span><span class="nx">controller</span><span class="p">,</span> <span class="nv">action: </span><span class="s1">&#39;index&#39;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">index</span> <span class="o">is</span> <span class="kc">false</span>
    <span class="nx">@route</span><span class="p">(</span><span class="s2">&quot;#{resource}/new&quot;</span><span class="p">,</span> <span class="s2">&quot;#{controller}#new&quot;</span><span class="p">,</span> <span class="nv">resource: </span><span class="nx">controller</span><span class="p">,</span> <span class="nv">action: </span><span class="s1">&#39;new&#39;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="k">new</span> <span class="o">is</span> <span class="kc">false</span>
    <span class="nx">@route</span><span class="p">(</span><span class="s2">&quot;#{resource}/:id&quot;</span><span class="p">,</span> <span class="s2">&quot;#{controller}#show&quot;</span><span class="p">,</span> <span class="nv">resource: </span><span class="nx">controller</span><span class="p">,</span> <span class="nv">action: </span><span class="s1">&#39;show&#39;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">show</span> <span class="o">is</span> <span class="kc">false</span>
    <span class="nx">@route</span><span class="p">(</span><span class="s2">&quot;#{resource}/:id/edit&quot;</span><span class="p">,</span> <span class="s2">&quot;#{controller}#edit&quot;</span><span class="p">,</span> <span class="nv">resource: </span><span class="nx">controller</span><span class="p">,</span> <span class="nv">action: </span><span class="s1">&#39;edit&#39;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">edit</span> <span class="o">is</span> <span class="kc">false</span>

    <span class="k">if</span> <span class="nx">callback</span>
      <span class="nv">app = </span><span class="err">@</span>
      <span class="nv">ops =</span>
        <span class="nv">collection: </span><span class="nf">(collectionCallback) -&gt;</span>
          <span class="nx">collectionCallback</span><span class="o">?</span><span class="p">.</span><span class="nx">call</span> <span class="nv">route: </span><span class="nf">(url, methodName) -&gt;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">route</span> <span class="s2">&quot;#{resource}/#{url}&quot;</span><span class="p">,</span> <span class="s2">&quot;#{controller}##{methodName || url}&quot;</span>
        <span class="nv">member: </span><span class="nf">(memberCallback) -&gt;</span>
          <span class="nx">memberCallback</span><span class="o">?</span><span class="p">.</span><span class="nx">call</span> <span class="nv">route: </span><span class="nf">(url, methodName) -&gt;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">route</span> <span class="s2">&quot;#{resource}/:id/#{url}&quot;</span><span class="p">,</span> <span class="s2">&quot;#{controller}##{methodName || url}&quot;</span>
        <span class="nv">resources: </span><span class="p">(</span><span class="nx">childResource</span><span class="p">,</span> <span class="nx">options</span><span class="o">=</span><span class="p">{},</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="p">(</span><span class="nv">callback = </span><span class="nx">options</span><span class="p">;</span> <span class="nv">options = </span><span class="p">{})</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">options</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
          <span class="nv">options.parentResource = </span><span class="nx">resource</span>
          <span class="nx">@resources</span> <span class="nx">childResource</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span>

      <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span> <span class="nx">ops</span>

  <span class="nv">redirect: </span><span class="nx">$redirect</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <h2>Controllers</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Controller</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nx">@singleton</span> <span class="s1">&#39;sharedController&#39;</span>

  <span class="vi">@beforeFilter: </span><span class="nf">(nameOrFunction) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
    <span class="nv">filters = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">beforeFilters</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="nx">filters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">nameOrFunction</span><span class="p">)</span> <span class="k">if</span> <span class="nx">filters</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">nameOrFunction</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>

  <span class="nx">@accessor</span> <span class="s1">&#39;controllerName&#39;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@_controllerName</span> <span class="o">||=</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">$functionName</span><span class="p">(</span><span class="nx">@constructor</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;Controller&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
  <span class="vi">@afterFilter: </span><span class="nf">(nameOrFunction) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
    <span class="nv">filters = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">afterFilters</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="nx">filters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">nameOrFunction</span><span class="p">)</span> <span class="k">if</span> <span class="nx">filters</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">nameOrFunction</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>

  <span class="nx">@accessor</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="c1"># FIXME: does this even need to be private?</span>
    <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@_currentAction</span>
    <span class="nv">set: </span><span class="nf">(key, value) -&gt;</span> <span class="vi">@_currentAction = </span><span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>You shouldn't call this method directly. It will be called by the dispatcher when a route is called.
If you need to call a route manually, use <code>$redirect()</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">dispatch: </span><span class="nf">(action, params = {}) -&gt;</span>
    <span class="nx">params</span><span class="p">.</span><span class="nx">controller</span> <span class="o">||=</span> <span class="nx">@get</span> <span class="s1">&#39;controllerName&#39;</span>
    <span class="nx">params</span><span class="p">.</span><span class="nx">action</span> <span class="o">||=</span> <span class="nx">action</span>
    <span class="nx">params</span><span class="p">.</span><span class="nx">target</span> <span class="o">||=</span> <span class="err">@</span>

    <span class="nv">oldRedirect = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">navigator</span><span class="o">?</span><span class="p">.</span><span class="nx">redirect</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">navigator</span><span class="o">?</span><span class="p">.</span><span class="nv">redirect = </span><span class="nx">@redirect</span>

    <span class="vi">@_actedDuringAction = </span><span class="kc">no</span>
    <span class="nx">@set</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="nx">action</span>
    <span class="nx">@set</span> <span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="nx">params</span>

    <span class="k">if</span> <span class="nv">filters = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;beforeFilters&#39;</span><span class="p">)</span>
      <span class="k">for</span> <span class="nx">filter</span> <span class="k">in</span> <span class="nx">filters</span>
        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">filter</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="k">then</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="k">else</span> <span class="err">@</span><span class="p">[</span><span class="nx">filter</span><span class="p">](</span><span class="nx">params</span><span class="p">)</span>

    <span class="nx">developer</span><span class="p">.</span><span class="nx">assert</span> <span class="err">@</span><span class="p">[</span><span class="nx">action</span><span class="p">],</span> <span class="s2">&quot;Error! Controller action #{@get &#39;controllerName&#39;}.#{action} couldn&#39;t be found!&quot;</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">action</span><span class="p">](</span><span class="nx">params</span><span class="p">)</span>

    <span class="k">if</span> <span class="o">not</span> <span class="nx">@_actedDuringAction</span>
      <span class="nx">@render</span><span class="p">()</span>

    <span class="k">if</span> <span class="nv">filters = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;afterFilters&#39;</span><span class="p">)</span>
      <span class="k">for</span> <span class="nx">filter</span> <span class="k">in</span> <span class="nx">filters</span>
        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">filter</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="k">then</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="k">else</span> <span class="err">@</span><span class="p">[</span><span class="nx">filter</span><span class="p">](</span><span class="nx">params</span><span class="p">)</span>

    <span class="k">delete</span> <span class="nx">@_actedDuringAction</span>

    <span class="nx">Batman</span><span class="p">.</span><span class="nx">navigator</span><span class="o">?</span><span class="p">.</span><span class="nv">redirect = </span><span class="nx">oldRedirect</span>

    <span class="nv">redirectTo = </span><span class="nx">@_afterFilterRedirect</span>
    <span class="k">delete</span> <span class="nx">@_afterFilterRedirect</span>

    <span class="nx">$redirect</span><span class="p">(</span><span class="nx">redirectTo</span><span class="p">)</span> <span class="k">if</span> <span class="nx">redirectTo</span>

  <span class="nv">redirect: </span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">throw</span> <span class="s1">&#39;DoubleRedirectError&#39;</span> <span class="k">if</span> <span class="nx">@_actedDuringAction</span>
    <span class="k">if</span> <span class="nx">@get</span> <span class="s1">&#39;action&#39;</span>
      <span class="vi">@_actedDuringAction = </span><span class="kc">yes</span>
      <span class="vi">@_afterFilterRedirect = </span><span class="nx">url</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;Object&#39;</span>
        <span class="nv">url.controller = </span><span class="err">@</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">url</span><span class="p">.</span><span class="nx">controller</span>

      <span class="nx">$redirect</span> <span class="nx">url</span>

  <span class="nv">render: </span><span class="nf">(options = {}) -&gt;</span>
    <span class="k">throw</span> <span class="s1">&#39;DoubleRenderError&#39;</span> <span class="k">if</span> <span class="nx">@_actedDuringAction</span>
    <span class="vi">@_actedDuringAction = </span><span class="kc">yes</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">options</span> <span class="o">is</span> <span class="kc">false</span>

    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">view</span>
      <span class="nv">controllerName = </span><span class="nx">$functionName</span><span class="p">(</span><span class="nx">@constructor</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;Controller&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

      <span class="nx">options</span><span class="p">.</span><span class="nx">contexts</span> <span class="o">||=</span> <span class="p">[]</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">contexts</span><span class="p">.</span><span class="nx">push</span> <span class="err">@</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">source</span> <span class="o">||=</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">controllerName</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">@_currentAction</span>
      <span class="nv">options.view = </span><span class="k">new</span> <span class="p">(</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span><span class="o">?</span><span class="p">[</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">camelize</span><span class="p">(</span><span class="s2">&quot;#{controllerName}_#{@_currentAction}_view&quot;</span><span class="p">)]</span> <span class="o">||</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span><span class="p">)(</span><span class="nx">options</span><span class="p">)</span>

    <span class="k">if</span> <span class="nv">view = </span><span class="nx">options</span><span class="p">.</span><span class="nx">view</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span><span class="o">?</span><span class="p">.</span><span class="nx">prevent</span> <span class="s1">&#39;ready&#39;</span>
      <span class="nx">view</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
        <span class="nv">node = </span><span class="nx">view</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">)</span>
        <span class="nv">yieldTo = </span><span class="nx">options</span><span class="p">.</span><span class="nx">into</span> <span class="o">||</span> <span class="s1">&#39;main&#39;</span>
        <span class="k">if</span> <span class="nx">view</span><span class="p">.</span><span class="nx">hasContainer</span>
          <span class="nv">yieldingNode = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yields</span><span class="p">[</span><span class="nx">yieldTo</span><span class="p">]</span>
          <span class="nx">$setInnerHTML</span> <span class="nx">yieldingNode</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
          <span class="k">while</span> <span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="nx">$appendChild</span><span class="p">(</span><span class="nx">yieldingNode</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">yieldTo</span><span class="p">,</span> <span class="nx">node</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span><span class="o">?</span><span class="p">.</span><span class="nx">allowAndFire</span> <span class="s1">&#39;ready&#39;</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">ready</span><span class="o">?</span><span class="p">(</span><span class="nx">@params</span><span class="p">)</span>
    <span class="nx">view</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <h2>Models</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Model</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <h2>Model API</h2>

<p>Override this property if your model is indexed by a key other than <code>id</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@primaryKey: </span><span class="s1">&#39;id&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Override this property to define the key which storage adapters will use to store instances of this model under.
 - For RestStorage, this ends up being part of the url built to store this model
 - For LocalStorage, this ends up being the namespace in localStorage in which JSON is stored</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@storageKey: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Pick one or many mechanisms with which this model should be persisted. The mechanisms
can be already instantiated or just the class defining them.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@persist: </span><span class="nf">(mechanisms...) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="nx">@prototype</span>
    <span class="nv">storage = </span><span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">storage</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="nv">results = </span><span class="k">for</span> <span class="nx">mechanism</span> <span class="k">in</span> <span class="nx">mechanisms</span>
      <span class="nv">mechanism = </span><span class="k">if</span> <span class="nx">mechanism</span><span class="p">.</span><span class="nx">isStorageAdapter</span> <span class="k">then</span> <span class="nx">mechanism</span> <span class="k">else</span> <span class="k">new</span> <span class="nx">mechanism</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
      <span class="nx">storage</span><span class="p">.</span><span class="nx">push</span> <span class="nx">mechanism</span>
      <span class="nx">mechanism</span>
    <span class="k">if</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="nx">results</span>
    <span class="k">else</span>
      <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Encoders are the tiny bits of logic which manage marshalling Batman models to and from their
storage representations. Encoders do things like stringifying dates and parsing them back out again,
pulling out nested model collections and instantiating them (and JSON.stringifying them back again),
and marshalling otherwise un-storable object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@encode: </span><span class="nf">(keys..., encoderOrLastKey) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="nx">@prototype</span>
    <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">encoders</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">decoders</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="k">switch</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">encoderOrLastKey</span><span class="p">)</span>
      <span class="k">when</span> <span class="s1">&#39;String&#39;</span>
        <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span> <span class="nx">encoderOrLastKey</span>
      <span class="k">when</span> <span class="s1">&#39;Function&#39;</span>
        <span class="nv">encoder = </span><span class="nx">encoderOrLastKey</span>
      <span class="k">else</span>
        <span class="nv">encoder = </span><span class="nx">encoderOrLastKey</span><span class="p">.</span><span class="nx">encode</span>
        <span class="nv">decoder = </span><span class="nx">encoderOrLastKey</span><span class="p">.</span><span class="nx">decode</span>

    <span class="nv">encoder = </span><span class="nx">@defaultEncoder</span><span class="p">.</span><span class="nx">encode</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">encoder</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
    <span class="nv">decoder = </span><span class="nx">@defaultEncoder</span><span class="p">.</span><span class="nx">decode</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">decoder</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>

    <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">keys</span>
      <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">encoders</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">encoder</span><span class="p">)</span> <span class="k">if</span> <span class="nx">encoder</span>
      <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">decoders</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">decoder</span><span class="p">)</span> <span class="k">if</span> <span class="nx">decoder</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Set up the unit functions as the default for both</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@defaultEncoder:</span>
    <span class="nv">encode: </span><span class="nf">(x) -&gt;</span> <span class="nx">x</span>
    <span class="nv">decode: </span><span class="nf">(x) -&gt;</span> <span class="nx">x</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Attach encoders and decoders for the primary key, and update them if the primary key changes.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@observeAndFire</span> <span class="s1">&#39;primaryKey&#39;</span><span class="p">,</span> <span class="nf">(newPrimaryKey) -&gt;</span> <span class="nx">@encode</span> <span class="nx">newPrimaryKey</span><span class="p">,</span> <span class="p">{</span><span class="nv">encode: </span><span class="kc">false</span><span class="p">,</span> <span class="nv">decode: </span><span class="nx">@defaultEncoder</span><span class="p">.</span><span class="nx">decode</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Validations allow a model to be marked as 'valid' or 'invalid' based on a set of programmatic rules.
By validating our data before it gets to the server we can provide immediate feedback to the user about
what they have entered and forgo waiting on a round trip to the server.
<code>validate</code> allows the attachment of validations to the model on particular keys, where the validation is
either a built in one (by use of options to pass to them) or a custom one (by use of a custom function as
the second argument). Custom validators should have the signature <code>(errors, record, key, callback)</code>. They
should add strings to the <code>errors</code> set based on the record (maybe depending on the <code>key</code> they were attached
to) and then always call the callback. Again: the callback must always be called.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@validate: </span><span class="nf">(keys..., optionsOrFunction) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="nx">@prototype</span>
    <span class="nv">validators = </span><span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">validators</span> <span class="o">||=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">optionsOrFunction</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Given a function, use that as the actual validator, expecting it to conform to the API
the built in validators do.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">validators</span><span class="p">.</span><span class="nx">push</span>
        <span class="nv">keys: </span><span class="nx">keys</span>
        <span class="nv">callback: </span><span class="nx">optionsOrFunction</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Given options, find the validations which match the given options, and add them to the validators
array.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">options = </span><span class="nx">optionsOrFunction</span>
      <span class="k">for</span> <span class="nx">validator</span> <span class="k">in</span> <span class="nx">Validators</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">matches = </span><span class="nx">validator</span><span class="p">.</span><span class="nx">matches</span><span class="p">(</span><span class="nx">options</span><span class="p">))</span>
          <span class="k">delete</span> <span class="nx">options</span><span class="p">[</span><span class="nx">match</span><span class="p">]</span> <span class="k">for</span> <span class="nx">match</span> <span class="k">in</span> <span class="nx">matches</span>
          <span class="nx">validators</span><span class="p">.</span><span class="nx">push</span>
            <span class="nv">keys: </span><span class="nx">keys</span>
            <span class="nv">validator: </span><span class="k">new</span> <span class="nx">validator</span><span class="p">(</span><span class="nx">matches</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <h3>Query methods</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@classAccessor</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="o">-&gt;</span>
      <span class="nx">@load</span><span class="p">()</span> <span class="k">if</span> <span class="err">@</span><span class="o">::</span><span class="nx">hasStorage</span><span class="p">()</span> <span class="o">and</span> <span class="nx">@classState</span><span class="p">()</span> <span class="o">not</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;loaded&#39;</span><span class="p">,</span> <span class="s1">&#39;loading&#39;</span><span class="p">]</span>
      <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;loaded&#39;</span><span class="p">)</span>

    <span class="nv">set: </span><span class="nf">(k, v) -&gt;</span> <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;loaded&#39;</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>

  <span class="nx">@classAccessor</span> <span class="s1">&#39;loaded&#39;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@_loaded</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span>
    <span class="nv">set: </span><span class="nf">(k, v) -&gt;</span> <span class="vi">@_loaded = </span><span class="nx">v</span>

  <span class="nx">@classAccessor</span> <span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">).</span><span class="nx">toArray</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nx">@classAccessor</span> <span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nv">x = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span> <span class="nx">x</span><span class="p">[</span><span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

  <span class="vi">@find: </span><span class="nf">(id, callback) -&gt;</span>
    <span class="nx">developer</span><span class="p">.</span><span class="nx">assert</span> <span class="nx">callback</span><span class="p">,</span> <span class="s2">&quot;Must call find with a callback!&quot;</span>
    <span class="nv">record = </span><span class="k">new</span> <span class="err">@</span><span class="p">()</span>
    <span class="nx">record</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">id</span>
    <span class="nv">newRecord = </span><span class="nx">@_mapIdentity</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span>
    <span class="nx">newRecord</span><span class="p">.</span><span class="nx">load</span> <span class="nx">callback</span>
    <span class="k">return</span> <span class="nx">newRecord</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p><code>load</code> fetches records from all sources possible</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@load: </span><span class="nf">(options, callback) -&gt;</span>
    <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;Function&#39;</span>
      <span class="nv">callback = </span><span class="nx">options</span>
      <span class="nv">options = </span><span class="p">{}</span>

    <span class="nx">developer</span><span class="p">.</span><span class="nx">assert</span> <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">getAll</span><span class="p">(</span><span class="s1">&#39;storage&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&quot;Can&#39;t load model #{$functionName(@)} without any storage adapters!&quot;</span>

    <span class="nx">@loading</span><span class="p">()</span>
    <span class="err">@</span><span class="o">::</span><span class="nx">_doStorageOperation</span> <span class="s1">&#39;readAll&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">records</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span><span class="o">?</span>
        <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="p">[])</span>
      <span class="k">else</span>
        <span class="nv">mappedRecords = </span><span class="p">(</span><span class="nx">@_mapIdentity</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span> <span class="k">for</span> <span class="nx">record</span> <span class="k">in</span> <span class="nx">records</span><span class="p">)</span>
        <span class="nx">@loaded</span><span class="p">()</span>
        <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">mappedRecords</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p><code>create</code> takes an attributes hash, creates a record from it, and saves it given the callback.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@create: </span><span class="nf">(attrs, callback) -&gt;</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">callback</span>
      <span class="p">[</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">callback</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{},</span> <span class="nx">attrs</span><span class="p">]</span>
    <span class="nv">obj = </span><span class="k">new</span> <span class="k">this</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span>
    <span class="nx">obj</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span>
    <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p><code>findOrCreate</code> takes an attributes hash, optionally containing a primary key, and returns to you a saved record
representing those attributes, either from the server or from the identity map.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@findOrCreate: </span><span class="nf">(attrs, callback) -&gt;</span>
    <span class="nv">record = </span><span class="k">new</span> <span class="k">this</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">record</span><span class="p">.</span><span class="nx">isNew</span><span class="p">()</span>
      <span class="nx">record</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">foundRecord = </span><span class="nx">@_mapIdentity</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span>
      <span class="nx">foundRecord</span><span class="p">.</span><span class="nx">updateAttributes</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">foundRecord</span><span class="p">)</span>

  <span class="vi">@_mapIdentity: </span><span class="nf">(record) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="p">(</span><span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">||</span> <span class="nx">id</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
      <span class="k">return</span> <span class="nx">record</span>
    <span class="k">else</span>
      <span class="nv">existing = </span><span class="nx">@get</span><span class="p">(</span><span class="s2">&quot;loaded.indexedBy.id&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">toArray</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">existing</span>
        <span class="nx">existing</span><span class="p">.</span><span class="nx">updateAttributes</span><span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">||</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="nx">existing</span>
      <span class="k">else</span>
        <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;loaded&#39;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">record</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <h3>Associations API</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;belongsTo&#39;</span><span class="p">,</span> <span class="s1">&#39;hasOne&#39;</span><span class="p">,</span> <span class="s1">&#39;hasMany&#39;</span><span class="p">]</span>
    <span class="nx">do</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="err">@</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">(label, scope) -&gt;</span>
        <span class="nx">@_batman</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
        <span class="nv">collection = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">associations</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">AssociationCollection</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
        <span class="nx">collection</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Association</span><span class="p">[</span><span class="nx">k</span><span class="p">](</span><span class="err">@</span><span class="p">,</span> <span class="nx">label</span><span class="p">,</span> <span class="nx">scope</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <h3>Record API</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Add a universally accessible accessor for retrieving the primrary key, regardless of which key its stored under.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@accessor</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="o">-&gt;</span>
      <span class="nv">pk = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">primaryKey</span>
      <span class="k">if</span> <span class="nx">pk</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span>
        <span class="nx">@id</span>
      <span class="k">else</span>
        <span class="nx">@get</span><span class="p">(</span><span class="nx">pk</span><span class="p">)</span>
    <span class="nv">set: </span><span class="nf">(k, v) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>naively coerce string ids into integers</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">v</span> <span class="o">is</span> <span class="s2">&quot;string&quot;</span> <span class="o">and</span> <span class="nx">v</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/[^0-9]/</span><span class="p">)</span> <span class="o">is</span> <span class="kc">null</span>
        <span class="nv">v = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

      <span class="nv">pk = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">primaryKey</span>
      <span class="k">if</span> <span class="nx">pk</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span>
        <span class="vi">@id = </span><span class="nx">v</span>
      <span class="k">else</span>
        <span class="nx">@set</span><span class="p">(</span><span class="nx">pk</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Add normal accessors for the dirty keys and errors attributes of a record, so these accesses don't fall to the
default accessor.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@accessor</span> <span class="s1">&#39;dirtyKeys&#39;</span><span class="p">,</span> <span class="s1">&#39;errors&#39;</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">defaultAccessor</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Add an accessor for the internal batman state under <code>batmanState</code>, so that the <code>state</code> key can be a valid
attribute.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@accessor</span> <span class="s1">&#39;batmanState&#39;</span>
    <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@state</span><span class="p">()</span>
    <span class="nv">set: </span><span class="nf">(k, v) -&gt;</span> <span class="nx">@state</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Add a default accessor to make models store their attributes under a namespace by default.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@accessor</span> <span class="nv">Model.defaultAccessor =</span>
    <span class="nv">get: </span><span class="nf">(k) -&gt;</span> <span class="p">(</span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">||=</span> <span class="p">{})[</span><span class="nx">k</span><span class="p">]</span> <span class="o">||</span> <span class="err">@</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
    <span class="nv">set: </span><span class="nf">(k, v) -&gt;</span> <span class="p">(</span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">||=</span> <span class="p">{})[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
    <span class="nv">unset: </span><span class="nf">(k) -&gt;</span>
      <span class="nv">x = </span><span class="p">(</span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">||=</span><span class="p">{})[</span><span class="nx">k</span><span class="p">]</span>
      <span class="k">delete</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
      <span class="nx">x</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>New records can be constructed by passing either an ID or a hash of attributes (potentially
containing an ID) to the Model constructor. By not passing an ID, the model is marked as new.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(idOrAttributes = {}) -&gt;</span>
    <span class="nx">developer</span><span class="p">.</span><span class="nx">assert</span>  <span class="err">@</span> <span class="k">instanceof</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span><span class="p">,</span> <span class="s2">&quot;constructors must be called with new&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>We have to do this ahead of super, because mixins will call set which calls things on dirtyKeys.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@dirtyKeys = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Hash</span>
    <span class="vi">@errors = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ErrorsSet</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Find the ID from either the first argument or the attributes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">idOrAttributes</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;Object&#39;</span>
      <span class="k">super</span><span class="p">(</span><span class="nx">idOrAttributes</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">super</span><span class="p">()</span>
      <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">idOrAttributes</span><span class="p">)</span>

    <span class="nx">@empty</span><span class="p">()</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@state</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Override the <code>Batman.Observable</code> implementation of <code>set</code> to implement dirty tracking.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">set: </span><span class="nf">(key, value) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Optimize setting where the value is the same as what's already been set.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">oldValue = </span><span class="nx">@get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">oldValue</span> <span class="o">is</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Actually set the value and note what the old value was in the tracking array.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">result = </span><span class="k">super</span>
    <span class="nx">@dirtyKeys</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Mark the model as dirty if isn't already.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@dirty</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">@state</span><span class="p">()</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;dirty&#39;</span><span class="p">,</span> <span class="s1">&#39;loading&#39;</span><span class="p">,</span> <span class="s1">&#39;creating&#39;</span><span class="p">]</span>
    <span class="nx">result</span>

  <span class="nv">updateAttributes: </span><span class="nf">(attrs) -&gt;</span>
    <span class="nx">@mixin</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span>
    <span class="err">@</span>

  <span class="nv">toString: </span><span class="o">-&gt;</span>
    <span class="s2">&quot;#{$functionName(@constructor)}: #{@get(&#39;id&#39;)}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p><code>toJSON</code> uses the various encoders for each key to grab a storable representation of the record.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">toJSON: </span><span class="o">-&gt;</span>
    <span class="nv">obj = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Encode each key into a new object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">encoders = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;encoders&#39;</span><span class="p">)</span>
    <span class="nx">unless</span> <span class="o">!</span><span class="nx">encoders</span> <span class="o">or</span> <span class="nx">encoders</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
      <span class="nx">encoders</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">encoder</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">val = </span><span class="nx">@get</span> <span class="nx">key</span>
        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">val</span> <span class="o">isnt</span> <span class="s1">&#39;undefined&#39;</span>
          <span class="nv">encodedVal = </span><span class="nx">encoder</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span>
          <span class="k">if</span> <span class="k">typeof</span> <span class="nx">encodedVal</span> <span class="o">isnt</span> <span class="s1">&#39;undefined&#39;</span>
            <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">encodedVal</span>
    <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p><code>fromJSON</code> uses the various decoders for each key to generate a record instance from the JSON
stored in whichever storage mechanism.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fromJSON: </span><span class="nf">(data) -&gt;</span>
    <span class="nv">obj = </span><span class="p">{}</span>

    <span class="nv">decoders = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;decoders&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>If no decoders were specified, do the best we can to interpret the given JSON by camelizing
each key and just setting the values.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">!</span><span class="nx">decoders</span> <span class="o">or</span> <span class="nx">decoders</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">data</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>If we do have decoders, use them to get the data.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">decoders</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">decoder</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">decoder</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span> <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="nx">developer</span><span class="p">.</span><span class="nx">do</span> <span class="o">-&gt;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">decoders</span><span class="p">)</span> <span class="o">||</span> <span class="nx">decoders</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nf">(sum, x) -&gt;</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">x</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="nx">developer</span><span class="p">.</span><span class="nx">warn</span> <span class="s2">&quot;Warning: Model #{@get(&#39;storageKey&#39;)} has suspiciously few decoders!&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Mixin the buffer object to use optimized and event-preventing sets used by <code>mixin</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@mixin</span> <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>Each model instance (each record) can be in one of many states throughout its lifetime. Since various
operations on the model are asynchronous, these states are used to indicate exactly what point the
record is at in it's lifetime, which can often be during a save or load operation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@actsAsStateMachine</span> <span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Add the various states to the model.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="s1">&#39;dirty&#39;</span><span class="p">,</span> <span class="s1">&#39;loading&#39;</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">,</span> <span class="s1">&#39;saving&#39;</span><span class="p">,</span> <span class="s1">&#39;saved&#39;</span><span class="p">,</span> <span class="s1">&#39;creating&#39;</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;validating&#39;</span><span class="p">,</span> <span class="s1">&#39;validated&#39;</span><span class="p">,</span> <span class="s1">&#39;destroying&#39;</span><span class="p">,</span> <span class="s1">&#39;destroyed&#39;</span><span class="p">]</span>
    <span class="nx">@state</span> <span class="nx">k</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;loading&#39;</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">]</span>
    <span class="nx">@classState</span> <span class="nx">k</span>

  <span class="nv">_doStorageOperation: </span><span class="nf">(operation, options, callback) -&gt;</span>
    <span class="nx">developer</span><span class="p">.</span><span class="nx">assert</span> <span class="nx">@hasStorage</span><span class="p">(),</span> <span class="s2">&quot;Can&#39;t #{operation} model #{$functionName(@constructor)} without any storage adapters!&quot;</span>
    <span class="nv">mechanisms = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;storage&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">mechanism</span> <span class="k">in</span> <span class="nx">mechanisms</span>
      <span class="nx">mechanism</span><span class="p">[</span><span class="nx">operation</span><span class="p">]</span> <span class="err">@</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span>
    <span class="kc">true</span>

  <span class="nv">hasStorage: </span><span class="o">-&gt;</span> <span class="p">(</span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;storage&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p><code>load</code> fetches the record from all sources possible</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">load: </span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">@state</span><span class="p">()</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;destroying&#39;</span><span class="p">,</span> <span class="s1">&#39;destroyed&#39;</span><span class="p">]</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t load a destroyed record!&quot;</span><span class="p">))</span>
      <span class="k">return</span>

    <span class="nx">@loading</span><span class="p">()</span>
    <span class="nx">@_doStorageOperation</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">unless</span> <span class="nx">err</span>
        <span class="nx">@loaded</span><span class="p">()</span>
        <span class="nv">record = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">_mapIdentity</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p><code>save</code> persists a record to all the storage mechanisms added using <code>@persist</code>. <code>save</code> will only save
a model if it is valid.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">save: </span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">@state</span><span class="p">()</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;destroying&#39;</span><span class="p">,</span> <span class="s1">&#39;destroyed&#39;</span><span class="p">]</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t save a destroyed record!&quot;</span><span class="p">))</span>
      <span class="k">return</span>

    <span class="nx">@validate</span> <span class="p">(</span><span class="nx">isValid</span><span class="p">,</span> <span class="nx">errors</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="o">!</span><span class="nx">isValid</span>
        <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">errors</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="nv">creating = </span><span class="nx">@isNew</span><span class="p">()</span>

      <span class="nx">do</span> <span class="nx">@saving</span>
      <span class="nx">do</span> <span class="nx">@creating</span> <span class="k">if</span> <span class="nx">creating</span>

      <span class="nv">associations = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">associations</span><span class="o">?</span><span class="p">.</span><span class="nx">getAll</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Save belongsTo models immediately since we don't need this model's id</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">associations</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;belongsTo&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">association</span><span class="p">,</span> <span class="nx">label</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">association</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>

      <span class="nx">@_doStorageOperation</span> <span class="p">(</span><span class="k">if</span> <span class="nx">creating</span> <span class="k">then</span> <span class="s1">&#39;create&#39;</span> <span class="k">else</span> <span class="s1">&#39;update&#39;</span><span class="p">),</span> <span class="p">{},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">unless</span> <span class="nx">err</span>
          <span class="k">if</span> <span class="nx">creating</span>
            <span class="nx">do</span> <span class="nx">@created</span>
          <span class="nx">do</span> <span class="nx">@saved</span>
          <span class="nx">@dirtyKeys</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>

          <span class="nx">associations</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;hasOne&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(association) -&gt;</span> <span class="nx">association</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span>
          <span class="nx">associations</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;hasMany&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(association) -&gt;</span> <span class="nx">association</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span>

          <span class="nv">record = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">_mapIdentity</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span>
        <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p><code>destroy</code> destroys a record in all the stores.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">destroy: </span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">do</span> <span class="nx">@destroying</span>
    <span class="nx">@_doStorageOperation</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">unless</span> <span class="nx">err</span>
        <span class="nx">@constructor</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
        <span class="nx">do</span> <span class="nx">@destroyed</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p><code>validate</code> performs the record level validations determining the record's validity. These may be asynchronous,
in which case <code>validate</code> has no useful return value. Results from asynchronous validations can be received by
listening to the <code>afterValidation</code> lifecycle callback.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">validate: </span><span class="nf">(callback) -&gt;</span>
    <span class="nv">oldState = </span><span class="nx">@state</span><span class="p">()</span>
    <span class="nx">@errors</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
    <span class="nx">do</span> <span class="nx">@validating</span>

    <span class="nv">finish = </span><span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">do</span> <span class="nx">@validated</span>
      <span class="err">@</span><span class="p">[</span><span class="nx">oldState</span><span class="p">]()</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">@errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">@errors</span><span class="p">)</span>

    <span class="nv">validators = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;validators&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]</span>
    <span class="nx">unless</span> <span class="nx">validators</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">finish</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nv">count = </span><span class="nx">validators</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">validationCallback = </span><span class="o">=&gt;</span>
        <span class="k">if</span> <span class="o">--</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span>
          <span class="nx">finish</span><span class="p">()</span>
      <span class="k">for</span> <span class="nx">validator</span> <span class="k">in</span> <span class="nx">validators</span>
        <span class="nv">v = </span><span class="nx">validator</span><span class="p">.</span><span class="nx">validator</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>Run the validator <code>v</code> or the custom callback on each key it validates by instantiating a new promise
and passing it to the appropriate function along with the key and the value to be validated.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">validator</span><span class="p">.</span><span class="nx">keys</span>
          <span class="k">if</span> <span class="nx">v</span>
            <span class="nx">v</span><span class="p">.</span><span class="nx">validateEach</span> <span class="nx">@errors</span><span class="p">,</span> <span class="err">@</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">validationCallback</span>
          <span class="k">else</span>
            <span class="nx">validator</span><span class="p">.</span><span class="nx">callback</span> <span class="nx">@errors</span><span class="p">,</span> <span class="err">@</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">validationCallback</span>
    <span class="k">return</span>

  <span class="nv">isNew: </span><span class="o">-&gt;</span> <span class="k">typeof</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>


<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">AssociationCollection</span>
  <span class="vi">@availableAssociations: </span><span class="p">[</span><span class="s1">&#39;belongsTo&#39;</span><span class="p">,</span> <span class="s1">&#39;hasOne&#39;</span><span class="p">,</span> <span class="s1">&#39;hasMany&#39;</span><span class="p">]</span>
  <span class="nv">constructor: </span><span class="nf">(@model) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>Contains (association, label) pairs mapped by association type
ie. @storage = {<Association.associationType>: {<Association>: <label>}}</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@storage = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>

  <span class="nv">add: </span><span class="nf">(association) -&gt;</span>
    <span class="nx">unless</span> <span class="nv">associationTypeHash = </span><span class="nx">@storage</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">association</span><span class="p">.</span><span class="nx">constructor</span><span class="p">)</span>
      <span class="nv">associationTypeHash = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
      <span class="nx">@storage</span><span class="p">.</span><span class="nx">set</span> <span class="nx">association</span><span class="p">.</span><span class="nx">associationType</span><span class="p">,</span> <span class="nx">associationTypeHash</span>

    <span class="nx">associationTypeHash</span><span class="p">.</span><span class="nx">set</span> <span class="nx">association</span><span class="p">,</span> <span class="nx">association</span><span class="p">.</span><span class="nx">label</span>

  <span class="nv">get: </span><span class="nf">(key) -&gt;</span> <span class="nx">@storage</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>

  <span class="nv">getAll: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>Traverse the class heirarchy to get all the AssociationCollection objects</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@model</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="nx">@model</span><span class="p">)</span>
    <span class="nv">ancestorCollections = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">ancestors</span><span class="p">(</span><span class="nf">(ancestor) -&gt;</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;associations&#39;</span><span class="p">))</span>
    <span class="nv">newStorage = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>Flatten the deep hashes to merge the ancestors into the final, inherited storage for this model.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">AssociationCollection</span><span class="p">.</span><span class="nx">availableAssociations</span>
      <span class="nv">ancestorValuesAtKey = </span><span class="k">for</span> <span class="nx">ancestorCollection</span> <span class="k">in</span> <span class="nx">ancestorCollections</span> <span class="k">when</span> <span class="nx">ancestorCollection</span><span class="o">?</span> <span class="o">and</span> <span class="nv">val = </span><span class="nx">ancestorCollection</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
        <span class="nx">val</span>
      <span class="nx">newStorage</span><span class="p">.</span><span class="nx">set</span> <span class="nx">key</span><span class="p">,</span> <span class="p">(</span><span class="nx">@storage</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="p">).</span><span class="nx">merge</span><span class="p">(</span><span class="nx">ancestorValuesAtKey</span><span class="p">...)</span>

    <span class="vi">@storage = </span><span class="nx">newStorage</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>Gives {hasMany: Hash{<Association>: <label>}, hasOne: Hash{...}, ...}</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@getAll = </span><span class="o">-&gt;</span> <span class="nx">@storage</span>
    <span class="nx">@storage</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Association</span>
  <span class="nv">associationType: </span><span class="s1">&#39;&#39;</span>
  <span class="nv">defaultOptions:</span>
    <span class="nv">saveInline: </span><span class="kc">true</span>
    <span class="nv">autoload: </span><span class="kc">true</span>

  <span class="nv">constructor: </span><span class="nf">(@model, @label, options = {}) -&gt;</span>
    <span class="nv">defaultOptions =</span>
      <span class="nv">namespace: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span>
      <span class="nv">name: </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">camelize</span><span class="p">(</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">singularize</span><span class="p">(</span><span class="nx">@label</span><span class="p">))</span>
    <span class="vi">@options = </span><span class="nx">$mixin</span> <span class="nx">defaultOptions</span><span class="p">,</span> <span class="nx">@defaultOptions</span><span class="p">,</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>Setup encoders and accessors for this association. The accessor needs reference to this
association object, so curry the association info into the getAccessor, which has the
model applied as the context</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">model</span><span class="p">.</span><span class="nx">encode</span> <span class="nx">label</span><span class="p">,</span> <span class="nx">@encoder</span><span class="p">()</span>

    <span class="nv">self = </span><span class="err">@</span>
    <span class="nv">getAccessor = </span><span class="o">-&gt;</span> <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">getAccessor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">label</span><span class="p">)</span>
    <span class="nx">model</span><span class="p">.</span><span class="nx">accessor</span> <span class="nx">label</span><span class="p">,</span>
      <span class="nv">get: </span><span class="nx">getAccessor</span>
      <span class="nv">set: </span><span class="nx">model</span><span class="p">.</span><span class="nx">defaultAccessor</span><span class="p">.</span><span class="nx">set</span>
      <span class="nv">unset: </span><span class="nx">model</span><span class="p">.</span><span class="nx">defaultAccessor</span><span class="p">.</span><span class="nx">unset</span>

  <span class="k">class</span> <span class="nx">AssociationSetSetIndex</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SetIndex</span>
    <span class="nv">constructor: </span><span class="nf">(@association) -&gt;</span> <span class="k">super</span><span class="p">(</span><span class="nx">@association</span><span class="p">.</span><span class="nx">getRelatedModel</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;loaded&#39;</span><span class="p">),</span> <span class="nx">@association</span><span class="p">.</span><span class="nx">foreignKey</span><span class="p">)</span>
    <span class="nv">_resultSetForKey: </span><span class="nf">(key) -&gt;</span> <span class="nx">@_storage</span><span class="p">.</span><span class="nx">getOrSet</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Association</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">@association</span><span class="p">))</span>

  <span class="nv">setIndex: </span><span class="o">-&gt;</span>
    <span class="nx">@index</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">AssociationSetSetIndex</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="nx">@index</span>

  <span class="nv">getRelatedModel: </span><span class="o">-&gt;</span>
    <span class="nv">scope = </span><span class="nx">@options</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">or</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span>
    <span class="nv">modelName = </span><span class="nx">@options</span><span class="p">.</span><span class="nx">name</span>
    <span class="nx">scope</span><span class="o">?</span><span class="p">[</span><span class="nx">modelName</span><span class="p">]</span>

  <span class="nv">getFromAttributes: </span><span class="nf">(record) -&gt;</span> <span class="nx">record</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">defaultAccessor</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">record</span><span class="p">,</span> <span class="nx">@label</span><span class="p">)</span>
  <span class="nv">getAccessor: </span><span class="o">-&gt;</span> <span class="nx">developer</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;You must override getAccessor in Batman.Association subclasses.&quot;</span>
  <span class="nv">encoder: </span><span class="o">-&gt;</span> <span class="nx">developer</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;You must override encoder in Batman.Association subclasses.&quot;</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Association</span><span class="p">.</span><span class="nx">belongsTo</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Association</span>
  <span class="nv">associationType: </span><span class="s1">&#39;belongsTo&#39;</span>
  <span class="nv">defaultOptions:</span>
    <span class="nv">saveInline: </span><span class="kc">false</span>
    <span class="nv">autoload: </span><span class="kc">true</span>

  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span>
    <span class="nx">@model</span><span class="p">.</span><span class="nx">encode</span> <span class="s2">&quot;#{@label}_id&quot;</span>

  <span class="nv">getAccessor: </span><span class="nf">(self, model, label) -&gt;</span>
    <span class="k">if</span> <span class="nv">relatedRecord = </span><span class="nx">self</span><span class="p">.</span><span class="nx">getFromAttributes</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">relatedRecord</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>Make sure there is a relation</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">unless</span> <span class="nv">relatedID = </span><span class="nx">@get</span><span class="p">(</span><span class="s2">&quot;#{label}_id&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>Make sure the related model has been loaded</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">unless</span> <span class="nv">relatedModel = </span><span class="nx">self</span><span class="p">.</span><span class="nx">getRelatedModel</span><span class="p">()</span>

    <span class="nv">loadedRecord = </span><span class="nx">self</span><span class="p">.</span><span class="nx">setIndex</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="nx">relatedID</span><span class="p">)</span>

    <span class="nx">unless</span> <span class="nx">loadedRecord</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
      <span class="nx">loadedRecord</span><span class="p">.</span><span class="nx">toArray</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">autoload</span>
        <span class="nx">relatedModel</span><span class="p">.</span><span class="nx">find</span> <span class="nx">relatedID</span><span class="p">,</span> <span class="nf">(error, loadedRecord) -&gt;</span> <span class="k">throw</span> <span class="nx">error</span> <span class="k">if</span> <span class="nx">error</span>
      <span class="k">else</span>
        <span class="k">new</span> <span class="nx">relatedModel</span><span class="p">(</span><span class="nx">relatedID</span><span class="p">)</span>

  <span class="nv">encoder: </span><span class="o">-&gt;</span>
    <span class="nv">association = </span><span class="err">@</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nv">encode: </span><span class="nf">(val) -&gt;</span>
        <span class="k">return</span> <span class="nx">unless</span> <span class="nx">association</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">saveInline</span>
        <span class="nx">val</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
      <span class="nv">decode: </span><span class="nf">(data) -&gt;</span>
        <span class="nv">record = </span><span class="k">new</span> <span class="p">(</span><span class="nx">association</span><span class="p">.</span><span class="nx">getRelatedModel</span><span class="p">())()</span>
        <span class="nx">record</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
        <span class="nx">record</span>
    <span class="p">}</span>

  <span class="nv">apply: </span><span class="nf">(base) -&gt;</span>
    <span class="k">if</span> <span class="nv">model = </span><span class="nx">base</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">@label</span><span class="p">)</span>
      <span class="nx">base</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;#{@label}_id&quot;</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Association</span><span class="p">.</span><span class="nx">hasOne</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Association</span>
  <span class="nv">associationType: </span><span class="s1">&#39;hasOne&#39;</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span>
    <span class="vi">@propertyName = </span><span class="nx">$functionName</span><span class="p">(</span><span class="nx">@model</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="vi">@foreignKey = </span><span class="s2">&quot;#{helpers.underscore($functionName(@model))}_id&quot;</span>

  <span class="nv">getAccessor: </span><span class="nf">(self, model, label) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@amSetting</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>Check whether the relatedModel has already been set on this model</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">existingInstance = </span><span class="nx">self</span><span class="p">.</span><span class="nx">getFromAttributes</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">existingInstance</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>Make sure relatedModel has been loaded</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">unless</span> <span class="nv">relatedModel = </span><span class="nx">self</span><span class="p">.</span><span class="nx">getRelatedModel</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>Make sure we have an id to match on</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">unless</span> <span class="nv">id = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>Check whether the relatedModel has already loaded the instance we want</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">relatedRecords = </span><span class="nx">self</span><span class="p">.</span><span class="nx">setIndex</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
    <span class="nx">unless</span> <span class="nx">relatedRecords</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">relatedRecords</span><span class="p">.</span><span class="nx">toArray</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>Create a relatedModel instance to return immediately and populate when it loads</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">loadingRecord = </span><span class="k">new</span> <span class="nx">relatedModel</span>
      <span class="nv">loadingRecord.load = </span><span class="nf">(callback) -&gt;</span>
        <span class="nv">loadOptions = </span><span class="p">{}</span>
        <span class="nx">loadOptions</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">foreignKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">id</span>
        <span class="nx">relatedModel</span><span class="p">.</span><span class="nx">load</span> <span class="nx">loadOptions</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">loadedRecords</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">unless</span> <span class="nx">error</span>
            <span class="k">if</span> <span class="o">!</span><span class="nx">loadedRecords</span> <span class="o">or</span> <span class="nx">loadedRecords</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">0</span>
              <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find related record!&quot;</span><span class="p">))</span>
            <span class="k">else</span>
              <span class="nx">@fromJSON</span> <span class="nx">loadedRecords</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toJSON</span><span class="p">()</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">loadedRecords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>FIXME shouldn't need to short-circuit the get/set accessor loop</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@amSetting = </span><span class="kc">true</span>
      <span class="nx">@set</span> <span class="nx">label</span><span class="p">,</span> <span class="nx">loadingRecord</span>
      <span class="vi">@amSetting = </span><span class="kc">false</span>

      <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">autoload</span>
        <span class="nx">loadingRecord</span><span class="p">.</span><span class="nx">load</span> <span class="nf">(error) -&gt;</span>

      <span class="k">return</span> <span class="nx">loadingRecord</span>

  <span class="nv">apply: </span><span class="nf">(baseSaveError, base) -&gt;</span>
    <span class="k">if</span> <span class="nv">relation = </span><span class="nx">base</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">defaultAccessor</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">@label</span><span class="p">)</span>
      <span class="nx">relation</span><span class="p">.</span><span class="nx">set</span> <span class="nx">@foreignKey</span><span class="p">,</span> <span class="nx">base</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

  <span class="nv">encoder: </span><span class="o">-&gt;</span>
    <span class="nv">association = </span><span class="err">@</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nv">encode: </span><span class="nf">(val, key, object, record) -&gt;</span>
        <span class="k">return</span> <span class="nx">unless</span> <span class="nx">association</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">saveInline</span>
        <span class="nv">json = </span><span class="nx">val</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
        <span class="nx">json</span><span class="p">[</span><span class="nx">association</span><span class="p">.</span><span class="nx">foreignKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="nx">json</span>
      <span class="nv">decode: </span><span class="nf">(data) -&gt;</span>
        <span class="nv">record = </span><span class="k">new</span> <span class="p">(</span><span class="nx">association</span><span class="p">.</span><span class="nx">getRelatedModel</span><span class="p">())()</span>
        <span class="nx">record</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
        <span class="nx">record</span>
    <span class="p">}</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Association</span><span class="p">.</span><span class="nx">hasMany</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Association</span>
  <span class="nv">associationType: </span><span class="s1">&#39;hasMany&#39;</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span>
    <span class="vi">@propertyName = </span><span class="nx">$functionName</span><span class="p">(</span><span class="nx">@model</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="vi">@foreignKey = </span><span class="s2">&quot;#{helpers.underscore($functionName(@model))}_id&quot;</span>

  <span class="nv">getAccessor: </span><span class="nf">(self, model, label) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@amSetting</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nv">relatedModel = </span><span class="nx">self</span><span class="p">.</span><span class="nx">getRelatedModel</span><span class="p">()</span>

    <span class="k">if</span> <span class="nv">recordInAttributes = </span><span class="nx">self</span><span class="p">.</span><span class="nx">getFromAttributes</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">recordInAttributes</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nv">id = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

    <span class="nv">relatedRecords = </span><span class="nx">self</span><span class="p">.</span><span class="nx">setIndex</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
    <span class="vi">@amSetting = </span><span class="kc">true</span>
    <span class="nx">@set</span> <span class="nx">label</span><span class="p">,</span> <span class="nx">relatedRecords</span>
    <span class="vi">@amSetting = </span><span class="kc">false</span>
    <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">autoload</span> <span class="o">&amp;&amp;</span> <span class="nx">relatedRecords</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
      <span class="nx">relatedRecords</span><span class="p">.</span><span class="nx">load</span> <span class="nf">(error, records) -&gt;</span> <span class="k">throw</span> <span class="nx">error</span> <span class="k">if</span> <span class="nx">error</span>

    <span class="k">return</span> <span class="nx">relatedRecords</span>

  <span class="nv">apply: </span><span class="nf">(baseSaveError, base) -&gt;</span>
    <span class="k">if</span> <span class="nv">relations = </span><span class="nx">base</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">defaultAccessor</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">@label</span><span class="p">)</span>
      <span class="nx">relations</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">model</span><span class="p">.</span><span class="nx">set</span> <span class="nx">@foreignKey</span><span class="p">,</span> <span class="nx">base</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

  <span class="nv">encoder: </span><span class="o">-&gt;</span>
    <span class="nv">association = </span><span class="err">@</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nv">encode: </span><span class="nf">(relationSet, _, _, record) -&gt;</span>
        <span class="k">return</span> <span class="nx">unless</span> <span class="nx">association</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">saveInline</span>
        <span class="k">if</span> <span class="nx">relationSet</span><span class="o">?</span>
          <span class="nv">jsonArray = </span><span class="p">[]</span>
          <span class="nx">relationSet</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(relation) -&gt;</span>
            <span class="nv">relationJSON = </span><span class="nx">relation</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
            <span class="nx">relationJSON</span><span class="p">[</span><span class="nx">association</span><span class="p">.</span><span class="nx">foreignKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="nx">jsonArray</span><span class="p">.</span><span class="nx">push</span> <span class="nx">relationJSON</span>
        <span class="nx">jsonArray</span>

      <span class="nv">decode: </span><span class="nf">(data) -&gt;</span>
        <span class="nv">relations = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span>
        <span class="k">if</span> <span class="nv">relatedModel = </span><span class="nx">association</span><span class="p">.</span><span class="nx">getRelatedModel</span><span class="p">()</span>
          <span class="k">for</span> <span class="nx">jsonObject</span> <span class="k">in</span> <span class="nx">data</span>
            <span class="nv">record = </span><span class="k">new</span> <span class="nx">relatedModel</span><span class="p">(</span><span class="nx">jsonObject</span><span class="p">)</span>
            <span class="nv">record = </span><span class="nx">relatedModel</span><span class="p">.</span><span class="nx">_mapIdentity</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span>
            <span class="nx">relations</span><span class="p">.</span><span class="nx">add</span> <span class="nx">record</span>
        <span class="k">else</span>
          <span class="nx">developer</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;Can&#39;t decode model #{association.options.name} because it hasn&#39;t been loaded yet!&quot;</span>
        <span class="nx">relations</span>
    <span class="p">}</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Association</span><span class="p">.</span><span class="nx">Set</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span>
  <span class="nv">constructor: </span><span class="nf">(@key, @association) -&gt;</span> <span class="k">super</span><span class="p">()</span>
  <span class="nv">load: </span><span class="nf">(callback) -&gt;</span>
    <span class="nv">loadOptions = </span><span class="p">{}</span>
    <span class="nx">loadOptions</span><span class="p">[</span><span class="nx">@association</span><span class="p">.</span><span class="nx">foreignKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@key</span>
    <span class="nx">@association</span><span class="p">.</span><span class="nx">getRelatedModel</span><span class="p">().</span><span class="nx">load</span><span class="p">(</span><span class="nx">loadOptions</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="err">@</span><span class="p">))</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ValidationError</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nf">(attribute, message) -&gt;</span> <span class="k">super</span><span class="p">({</span><span class="nx">attribute</span><span class="p">,</span> <span class="nx">message</span><span class="p">})</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p><code>ErrorSet</code> is a simple subclass of <code>Set</code> which makes it a bit easier to
manage the errors on a model.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ErrorsSet</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>Define a default accessor to get the set of errors on a key</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@accessor</span> <span class="nf">(key) -&gt;</span> <span class="nx">@indexedBy</span><span class="p">(</span><span class="s1">&#39;attribute&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>Define a shorthand method for adding errors to a key.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">add: </span><span class="nf">(key, error) -&gt;</span> <span class="k">super</span><span class="p">(</span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ValidationError</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">error</span><span class="p">))</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Validator</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nf">(@options, mixins...) -&gt;</span>
    <span class="k">super</span> <span class="nx">mixins</span><span class="p">...</span>

  <span class="nv">validate: </span><span class="nf">(record) -&gt;</span> <span class="nx">developer</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;You must override validate in Batman.Validator subclasses.&quot;</span>
  <span class="nv">format: </span><span class="nf">(key, messageKey, interpolations) -&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;errors.format&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">attribute: </span><span class="nx">key</span><span class="p">,</span> <span class="nv">message: </span><span class="nx">t</span><span class="p">(</span><span class="s2">&quot;errors.messages.#{messageKey}&quot;</span><span class="p">,</span> <span class="nx">interpolations</span><span class="p">)})</span>

  <span class="vi">@options: </span><span class="nf">(options...) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
    <span class="k">if</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">options</span> <span class="k">then</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="k">else</span> <span class="vi">@_batman.options = </span><span class="nx">options</span>

  <span class="vi">@matches: </span><span class="nf">(options) -&gt;</span>
    <span class="nv">results = </span><span class="p">{}</span>
    <span class="nv">shouldReturn = </span><span class="kc">no</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">options</span>
      <span class="k">if</span> <span class="o">~</span><span class="nx">@_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
        <span class="nx">results</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
        <span class="nv">shouldReturn = </span><span class="kc">yes</span>
    <span class="k">return</span> <span class="nx">results</span> <span class="k">if</span> <span class="nx">shouldReturn</span>

<span class="nv">Validators = Batman.Validators = </span><span class="p">[</span>
  <span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">LengthValidator</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Validator</span>
    <span class="nx">@options</span> <span class="s1">&#39;minLength&#39;</span><span class="p">,</span> <span class="s1">&#39;maxLength&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;lengthWithin&#39;</span><span class="p">,</span> <span class="s1">&#39;lengthIn&#39;</span>

    <span class="nv">constructor: </span><span class="nf">(options) -&gt;</span>
      <span class="k">if</span> <span class="nv">range = </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">lengthIn</span> <span class="o">or</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lengthWithin</span><span class="p">)</span>
        <span class="nv">options.minLength = </span><span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nv">options.maxLength = </span><span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">delete</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lengthWithin</span>
        <span class="k">delete</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lengthIn</span>

      <span class="k">super</span>

    <span class="nv">validateEach: </span><span class="nf">(errors, record, key, callback) -&gt;</span>
      <span class="nv">options = </span><span class="nx">@options</span>
      <span class="nv">value = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">minLength</span> <span class="o">and</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">minLength</span>
        <span class="nx">errors</span><span class="p">.</span><span class="nx">add</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">@format</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="s1">&#39;too_short&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">count: </span><span class="nx">options</span><span class="p">.</span><span class="nx">minLength</span><span class="p">})</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">maxLength</span> <span class="o">and</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">maxLength</span>
        <span class="nx">errors</span><span class="p">.</span><span class="nx">add</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">@format</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="s1">&#39;too_long&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">count: </span><span class="nx">options</span><span class="p">.</span><span class="nx">maxLength</span><span class="p">})</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="nx">options</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">errors</span><span class="p">.</span><span class="nx">add</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">@format</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="s1">&#39;wrong_length&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">count: </span><span class="nx">options</span><span class="p">.</span><span class="nx">length</span><span class="p">})</span>
      <span class="nx">callback</span><span class="p">()</span>

  <span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">PresenceValidator</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Validator</span>
    <span class="nx">@options</span> <span class="s1">&#39;presence&#39;</span>
    <span class="nv">validateEach: </span><span class="nf">(errors, record, key, callback) -&gt;</span>
      <span class="nv">value = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">presence</span> <span class="o">and</span> <span class="o">!</span><span class="nx">value</span><span class="o">?</span>
        <span class="nx">errors</span><span class="p">.</span><span class="nx">add</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">@format</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="s1">&#39;blank&#39;</span><span class="p">)</span>
      <span class="nx">callback</span><span class="p">()</span>
<span class="p">]</span>

<span class="nx">$mixin</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">translate</span><span class="p">.</span><span class="nx">messages</span><span class="p">,</span>
  <span class="nv">errors:</span>
    <span class="nv">format: </span><span class="s2">&quot;%{attribute} %{message}&quot;</span>
    <span class="nv">messages:</span>
      <span class="nv">too_short: </span><span class="s2">&quot;must be at least %{count} characters&quot;</span>
      <span class="nv">too_long: </span><span class="s2">&quot;must be less than %{count} characters&quot;</span>
      <span class="nv">wrong_length: </span><span class="s2">&quot;must be %{count} characters&quot;</span>
      <span class="nv">blank: </span><span class="s2">&quot;can&#39;t be blank&quot;</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">StorageAdapter</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nf">(model) -&gt;</span>
    <span class="k">super</span><span class="p">(</span><span class="nv">model: </span><span class="nx">model</span><span class="p">)</span>

  <span class="nv">isStorageAdapter: </span><span class="kc">true</span>
  <span class="nv">modelKey: </span><span class="nf">(record) -&gt;</span>
    <span class="nv">model = </span><span class="nx">record</span><span class="o">?</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">||</span> <span class="nx">@model</span>
    <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;storageKey&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">$functionName</span><span class="p">(</span><span class="nx">model</span><span class="p">)))</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="err">@</span><span class="o">::</span><span class="p">)</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;readAll&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;destroy&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">time</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">]</span>
      <span class="nx">do</span> <span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">time</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">key = </span><span class="s2">&quot;#{time}#{helpers.capitalize(k)}&quot;</span>
        <span class="err">@</span><span class="o">::</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nf">(filter) -&gt;</span>
          <span class="nx">@_batman</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
          <span class="p">(</span><span class="nx">@_batman</span><span class="p">[</span><span class="s2">&quot;#{key}Filters&quot;</span><span class="p">]</span> <span class="o">||=</span> <span class="p">[]).</span><span class="nx">push</span> <span class="nx">filter</span>

  <span class="nv">before: </span><span class="nf">(keys..., callback) -&gt;</span>
    <span class="err">@</span><span class="p">[</span><span class="s2">&quot;before#{helpers.capitalize(k)}&quot;</span><span class="p">](</span><span class="nx">callback</span><span class="p">)</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">keys</span>

  <span class="nv">after: </span><span class="nf">(keys..., callback) -&gt;</span>
    <span class="err">@</span><span class="p">[</span><span class="s2">&quot;after#{helpers.capitalize(k)}&quot;</span><span class="p">](</span><span class="nx">callback</span><span class="p">)</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">keys</span>

  <span class="nv">_filterData: </span><span class="nf">(prefix, action, data...) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>Filter the data first with the beforeRead and then the beforeAll filters</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">(</span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;#{prefix}#{helpers.capitalize(action)}Filters&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="p">[])</span>
      <span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;#{prefix}AllFilters&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="p">[])</span>
      <span class="p">.</span><span class="nx">reduce</span><span class="p">(</span> <span class="p">(</span><span class="nx">filteredData</span><span class="p">,</span> <span class="nx">filter</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">filter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">filteredData</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">data</span><span class="p">)</span>

  <span class="nv">getRecordFromData: </span><span class="nf">(data) -&gt;</span>
    <span class="nv">record = </span><span class="k">new</span> <span class="nx">@model</span><span class="p">()</span>
    <span class="nx">record</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="nx">record</span>

<span class="nv">$passError = </span><span class="nf">(f) -&gt;</span>
  <span class="k">return</span> <span class="nf">(filterables) -&gt;</span>
    <span class="k">if</span> <span class="nx">filterables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">filterables</span>
    <span class="k">else</span>
      <span class="nv">err = </span><span class="nx">filterables</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
      <span class="nv">filterables = </span><span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">filterables</span><span class="p">)</span>
      <span class="nx">filterables</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="nx">filterables</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">LocalStorage</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">StorageAdapter</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
      <span class="k">return</span> <span class="kc">null</span>
    <span class="k">super</span>
    <span class="vi">@storage = </span><span class="nx">localStorage</span>
    <span class="k">return</span>

  <span class="nv">storageRegExp: </span><span class="nf">(record) -&gt;</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;^#{@modelKey(record)}(\\d+)$&quot;</span><span class="p">)</span>

  <span class="nv">idForRecord: </span><span class="nf">(record) -&gt;</span>
    <span class="nv">re = </span><span class="nx">@storageRegExp</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span>
    <span class="nv">nextId = </span><span class="mi">1</span>
    <span class="nx">@_forAllRecords</span> <span class="nf">(k, v) -&gt;</span>
      <span class="k">if</span> <span class="nv">matches = </span><span class="nx">re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
        <span class="nv">nextId = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">nextId</span><span class="p">,</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">nextId</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">before</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nx">$passError</span> <span class="nf">([record, options]) -&gt;</span>
    <span class="p">[</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">record</span><span class="p">),</span> <span class="nx">options</span><span class="p">]</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">after</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="nx">$passError</span> <span class="nf">([record, attributes, options]) -&gt;</span>
    <span class="p">[</span><span class="nx">record</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)),</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">]</span>

  <span class="nv">_forAllRecords: </span><span class="nf">(f) -&gt;</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@storage</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
      <span class="nv">k = </span><span class="nx">@storage</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
      <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">@storage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">k</span><span class="p">))</span>

  <span class="nv">getRecordFromData: </span><span class="nf">(data) -&gt;</span>
    <span class="nv">record = </span><span class="k">super</span>
    <span class="vi">@nextId = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">@nextId</span><span class="p">,</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">record</span>

  <span class="nv">update: </span><span class="nf">(record, options, callback) -&gt;</span>
    <span class="p">[</span><span class="nx">err</span><span class="p">,</span> <span class="nx">recordToSave</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">err</span>
      <span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">id</span><span class="o">?</span>
        <span class="nx">@storage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="nx">@modelKey</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span> <span class="o">+</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">recordToSave</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get record primary key.&quot;</span><span class="p">)</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">options</span><span class="p">)...)</span>

  <span class="nv">create: </span><span class="nf">(record, options, callback) -&gt;</span>
    <span class="p">[</span><span class="nx">err</span><span class="p">,</span> <span class="nx">recordToSave</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">err</span>
      <span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">record</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">@idForRecord</span><span class="p">(</span><span class="nx">record</span><span class="p">))</span>
      <span class="k">if</span> <span class="nx">id</span><span class="o">?</span>
        <span class="nv">key = </span><span class="nx">@modelKey</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span> <span class="o">+</span> <span class="nx">id</span>
        <span class="k">if</span> <span class="nx">@storage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
          <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t create because the record already exists!&quot;</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">@storage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">recordToSave</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t set record primary key on create!&quot;</span><span class="p">)</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">options</span><span class="p">)...)</span>

  <span class="nv">read: </span><span class="nf">(record, options, callback) -&gt;</span>
    <span class="p">[</span><span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">err</span>
      <span class="k">if</span> <span class="nx">id</span><span class="o">?</span>
        <span class="nv">attrs = </span><span class="nx">@storage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">@modelKey</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span> <span class="o">+</span> <span class="nx">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">attrs</span>
          <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find record!&quot;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get record primary key.&quot;</span><span class="p">)</span>

    <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)...)</span>

  <span class="nv">readAll: </span><span class="nf">(proto, options, callback) -&gt;</span>
    <span class="nv">records = </span><span class="p">[]</span>
    <span class="p">[</span><span class="nx">err</span><span class="p">,</span> <span class="nx">options</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;readAll&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">err</span>
      <span class="nv">re = </span><span class="nx">@storageRegExp</span><span class="p">(</span><span class="nx">proto</span><span class="p">)</span>
      <span class="nx">@_forAllRecords</span> <span class="nf">(storageKey, data) -&gt;</span>
        <span class="k">if</span> <span class="nv">keyMatches = </span><span class="nx">re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">storageKey</span><span class="p">)</span>
          <span class="nx">records</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span><span class="nx">data</span><span class="p">,</span> <span class="nv">id: </span><span class="nx">keyMatches</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>

    <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;readAll&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">records</span><span class="p">,</span> <span class="nx">options</span><span class="p">)...)</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">after</span> <span class="s1">&#39;readAll&#39;</span><span class="p">,</span> <span class="nx">$passError</span> <span class="nf">([allAttributes, options]) -&gt;</span>
    <span class="nv">allAttributes = </span><span class="k">for</span> <span class="nx">attributes</span> <span class="k">in</span> <span class="nx">allAttributes</span>
      <span class="nv">data = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
      <span class="nx">data</span><span class="p">[</span><span class="nx">@model</span><span class="p">.</span><span class="nx">primaryKey</span><span class="p">]</span> <span class="o">||=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
      <span class="nx">data</span>

    <span class="p">[</span><span class="nx">allAttributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">]</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">after</span> <span class="s1">&#39;readAll&#39;</span><span class="p">,</span> <span class="nx">$passError</span> <span class="nf">([allAttributes, options]) -&gt;</span>
    <span class="nv">matches = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">data</span> <span class="k">in</span> <span class="nx">allAttributes</span>
      <span class="nv">match = </span><span class="kc">true</span>
      <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">options</span>
        <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">v</span>
          <span class="nv">match = </span><span class="kc">false</span>
          <span class="k">break</span>
      <span class="k">if</span> <span class="nx">match</span>
        <span class="nx">matches</span><span class="p">.</span><span class="nx">push</span> <span class="nx">data</span>
    <span class="p">[</span><span class="nx">matches</span><span class="p">,</span> <span class="nx">options</span><span class="p">]</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">after</span> <span class="s1">&#39;readAll&#39;</span><span class="p">,</span> <span class="nx">$passError</span> <span class="nf">([filteredAttributes, options]) -&gt;</span>
    <span class="p">[</span><span class="nx">@getRecordFromData</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="k">for</span> <span class="nx">data</span> <span class="k">in</span> <span class="nx">filteredAttributes</span><span class="p">,</span> <span class="nx">filteredAttributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">]</span>

  <span class="nv">destroy: </span><span class="nf">(record, options, callback) -&gt;</span>
    <span class="p">[</span><span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_filterData</span> <span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">options</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">err</span>
      <span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">id</span><span class="o">?</span>
        <span class="nv">key = </span><span class="nx">@modelKey</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span> <span class="o">+</span> <span class="nx">id</span>
        <span class="k">if</span> <span class="nx">@storage</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">key</span>
          <span class="nx">@storage</span><span class="p">.</span><span class="nx">removeItem</span> <span class="nx">key</span>
        <span class="k">else</span>
          <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t delete nonexistant record!&quot;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t delete record without an primary key!&quot;</span><span class="p">)</span>

    <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">options</span><span class="p">)...)</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">RestStorage</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">StorageAdapter</span>
  <span class="nv">defaultOptions:</span>
    <span class="nv">type: </span><span class="s1">&#39;json&#39;</span>

  <span class="nv">recordJsonNamespace: </span><span class="kc">false</span>
  <span class="nv">collectionJsonNamespace: </span><span class="kc">false</span>
  <span class="nv">serializeAsForm: </span><span class="kc">true</span>

  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span>
    <span class="vi">@defaultOptions = </span><span class="nx">$mixin</span> <span class="p">{},</span> <span class="nx">@defaultOptions</span>

  <span class="nv">recordJsonNamespace: </span><span class="nf">(record) -&gt;</span>
    <span class="nx">helpers</span><span class="p">.</span><span class="nx">singularize</span><span class="p">(</span><span class="nx">@modelKey</span><span class="p">(</span><span class="nx">record</span><span class="p">))</span>
  <span class="nv">collectionJsonNamespace: </span><span class="nf">(proto) -&gt;</span>
    <span class="nx">helpers</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">@modelKey</span><span class="p">(</span><span class="nx">proto</span><span class="p">))</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">before</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nx">$passError</span> <span class="nf">([record, options]) -&gt;</span>
    <span class="nv">json = </span><span class="nx">record</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
    <span class="nv">record = </span><span class="k">if</span> <span class="nv">namespace = </span><span class="nx">@recordJsonNamespace</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span>
      <span class="nv">x = </span><span class="p">{}</span>
      <span class="nx">x</span><span class="p">[</span><span class="nx">namespace</span><span class="p">]</span> <span class="o">=</span> <span class="nx">json</span>
      <span class="nx">x</span>
    <span class="k">else</span>
      <span class="nx">json</span>
    <span class="nv">record = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">@serializeAsForm</span>
    <span class="p">[</span><span class="nx">record</span><span class="p">,</span> <span class="nx">options</span><span class="p">]</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">after</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;readAll&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="nf">([error, record, data, options]) -&gt;</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">error</span>
      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">data</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
        <span class="k">try</span>
          <span class="nv">data = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
        <span class="k">catch</span> <span class="nx">e</span>
          <span class="nv">error = </span><span class="nx">e</span>
    <span class="p">[</span><span class="nx">error</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">]</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">after</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nx">$passError</span> <span class="nf">([record, data, options]) -&gt;</span>
    <span class="nv">namespace = </span><span class="nx">@recordJsonNamespace</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span>
    <span class="nv">data = </span><span class="nx">data</span><span class="p">[</span><span class="nx">namespace</span><span class="p">]</span> <span class="k">if</span> <span class="nx">namespace</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="nx">namespace</span><span class="p">]</span><span class="o">?</span>
    <span class="p">[</span><span class="nx">record</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">]</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">after</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nx">$passError</span> <span class="nf">([record, data, options]) -&gt;</span>
    <span class="nx">record</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="p">[</span><span class="nx">record</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">]</span>

  <span class="nv">optionsForRecord: </span><span class="nf">(record, recordOptions, callback) -&gt;</span>
    <span class="k">if</span> <span class="nx">record</span><span class="p">.</span><span class="nx">url</span>
      <span class="nv">url = </span><span class="k">if</span> <span class="k">typeof</span> <span class="nx">record</span><span class="p">.</span><span class="nx">url</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="k">then</span> <span class="nx">record</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="nx">recordOptions</span><span class="p">)</span> <span class="k">else</span> <span class="nx">record</span><span class="p">.</span><span class="nx">url</span>
    <span class="k">else</span>
      <span class="nv">url = </span><span class="k">if</span> <span class="nx">record</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">url</span>
        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">record</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">url</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
          <span class="nx">record</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="nx">recordOptions</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">record</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">url</span>
      <span class="k">else</span>
        <span class="s2">&quot;/#{@modelKey(record)}&quot;</span>

      <span class="k">if</span> <span class="nx">recordOptions</span><span class="p">.</span><span class="nx">idRequired</span>
        <span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">id</span><span class="o">?</span>
          <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get record primary key!&quot;</span><span class="p">))</span>
          <span class="k">return</span>
        <span class="nv">url = </span><span class="nx">url</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">id</span>

    <span class="nx">unless</span> <span class="nx">url</span>
      <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get model url!&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">$mixin</span><span class="p">({},</span> <span class="nx">@defaultOptions</span><span class="p">,</span> <span class="p">{</span><span class="nx">url</span><span class="p">})</span>

  <span class="nv">optionsForCollection: </span><span class="nf">(model, recordsOptions, callback) -&gt;</span>
    <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">url</span>
      <span class="nv">url = </span><span class="k">if</span> <span class="k">typeof</span> <span class="nx">model</span><span class="p">.</span><span class="nx">url</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="k">then</span> <span class="nx">model</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="nx">recordsOptions</span><span class="p">)</span> <span class="k">else</span> <span class="nx">model</span><span class="p">.</span><span class="nx">url</span>
    <span class="k">else</span>
      <span class="nv">url = </span><span class="s2">&quot;/#{@modelKey(model::)}&quot;</span>

    <span class="nx">unless</span> <span class="nx">url</span>
      <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get collection url!&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">$mixin</span> <span class="p">{},</span> <span class="nx">@defaultOptions</span><span class="p">,</span> <span class="p">{</span><span class="nx">url</span><span class="p">,</span> <span class="nv">data: </span><span class="nx">$mixin</span><span class="p">({},</span> <span class="nx">@defaultOptions</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">recordsOptions</span><span class="p">)}</span>

  <span class="nv">create: </span><span class="nf">(record, recordOptions, callback) -&gt;</span>
    <span class="nx">@optionsForRecord</span> <span class="nx">record</span><span class="p">,</span> <span class="p">{</span><span class="nv">idRequired: </span><span class="kc">false</span><span class="p">},</span> <span class="nf">(err, options) -&gt;</span>
      <span class="p">[</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">recordOptions</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>

      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span> <span class="nx">$mixin</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nv">data: </span><span class="nx">data</span>
        <span class="nv">method: </span><span class="s1">&#39;POST&#39;</span>
        <span class="nv">success: </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">recordOptions</span><span class="p">)...)</span>
        <span class="nv">error: </span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">),</span> <span class="nx">recordOptions</span><span class="p">)...)</span>

  <span class="nv">update: </span><span class="nf">(record, recordOptions, callback) -&gt;</span>
    <span class="nx">@optionsForRecord</span> <span class="nx">record</span><span class="p">,</span> <span class="p">{</span><span class="nv">idRequired: </span><span class="kc">true</span><span class="p">},</span> <span class="nf">(err, options) -&gt;</span>
      <span class="p">[</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">recordOptions</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>

      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span> <span class="nx">$mixin</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nv">data: </span><span class="nx">data</span>
        <span class="nv">method: </span><span class="s1">&#39;PUT&#39;</span>
        <span class="nv">success: </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">recordOptions</span><span class="p">)...)</span>
        <span class="nv">error: </span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">),</span> <span class="nx">recordOptions</span><span class="p">)...)</span>

  <span class="nv">read: </span><span class="nf">(record, recordOptions, callback) -&gt;</span>
    <span class="nx">@optionsForRecord</span> <span class="nx">record</span><span class="p">,</span> <span class="p">{</span><span class="nv">idRequired: </span><span class="kc">true</span><span class="p">},</span> <span class="nf">(err, options) -&gt;</span>
      <span class="p">[</span><span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">recordOptions</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">recordOptions</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>

      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span> <span class="nx">$mixin</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nv">data: </span><span class="nx">recordOptions</span>
        <span class="nv">method: </span><span class="s1">&#39;GET&#39;</span>
        <span class="nv">success: </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">recordOptions</span><span class="p">)...)</span>
        <span class="nv">error: </span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">),</span> <span class="nx">recordOptions</span><span class="p">)...)</span>

  <span class="nv">readAll: </span><span class="nf">(proto, recordsOptions, callback) -&gt;</span>
    <span class="nx">@optionsForCollection</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">constructor</span><span class="p">,</span> <span class="nx">recordsOptions</span><span class="p">,</span> <span class="nf">(err, options) -&gt;</span>
      <span class="p">[</span><span class="nx">err</span><span class="p">,</span> <span class="nx">recordsOptions</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;readAll&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">recordsOptions</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">if</span> <span class="nx">recordsOptions</span> <span class="o">&amp;&amp;</span> <span class="nx">recordsOptions</span><span class="p">.</span><span class="nx">url</span>
        <span class="nv">options.url = </span><span class="nx">recordsOptions</span><span class="p">.</span><span class="nx">url</span>
        <span class="k">delete</span> <span class="nx">recordsOptions</span><span class="p">.</span><span class="nx">url</span>

      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span> <span class="nx">$mixin</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nv">data: </span><span class="nx">recordsOptions</span>
        <span class="nv">method: </span><span class="s1">&#39;GET&#39;</span>
        <span class="nv">success: </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;readAll&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">proto</span><span class="p">,</span> <span class="nx">recordsOptions</span><span class="p">)...)</span>
        <span class="nv">error: </span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;readAll&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">),</span> <span class="nx">proto</span><span class="p">,</span> <span class="nx">recordsOptions</span><span class="p">)...)</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">after</span> <span class="s1">&#39;readAll&#39;</span><span class="p">,</span> <span class="nx">$passError</span> <span class="nf">([data, proto, options]) -&gt;</span>
    <span class="nv">namespace = </span><span class="nx">@collectionJsonNamespace</span><span class="p">(</span><span class="nx">proto</span><span class="p">)</span>
    <span class="nv">recordData = </span><span class="k">if</span> <span class="nx">namespace</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="nx">namespace</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nx">data</span><span class="p">[</span><span class="nx">namespace</span><span class="p">]</span> <span class="k">else</span> <span class="nx">data</span>
    <span class="p">[</span><span class="nx">recordData</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">proto</span><span class="p">,</span> <span class="nx">options</span><span class="p">]</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">after</span> <span class="s1">&#39;readAll&#39;</span><span class="p">,</span> <span class="nx">$passError</span> <span class="nf">([recordData, serverData, proto, options]) -&gt;</span>
    <span class="p">[</span><span class="nx">@getRecordFromData</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="k">for</span> <span class="nx">attributes</span> <span class="k">in</span> <span class="nx">recordData</span><span class="p">,</span> <span class="nx">serverData</span><span class="p">,</span> <span class="nx">proto</span><span class="p">,</span> <span class="nx">options</span><span class="p">]</span>

  <span class="nv">destroy: </span><span class="nf">(record, recordOptions, callback) -&gt;</span>
    <span class="nx">@optionsForRecord</span> <span class="nx">record</span><span class="p">,</span> <span class="p">{</span><span class="nv">idRequired: </span><span class="kc">true</span><span class="p">},</span> <span class="nf">(err, options) -&gt;</span>
      <span class="p">[</span><span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">recordOptions</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">recordOptions</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>

      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span> <span class="nx">$mixin</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nv">method: </span><span class="s1">&#39;DELETE&#39;</span>
        <span class="nv">success: </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">recordOptions</span><span class="p">)...)</span>
        <span class="nv">error: </span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">@_filterData</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">),</span> <span class="nx">recordOptions</span><span class="p">)...)</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <h2>Views</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ViewSourceCache</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span>
    <span class="vi">@sources = </span><span class="p">{}</span>
    <span class="vi">@requests = </span><span class="p">{}</span>

  <span class="nv">propertyClass: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span>

  <span class="nx">@accessor</span>
    <span class="nv">get: </span><span class="nf">(path) -&gt;</span>
      <span class="nv">path = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Navigator</span><span class="p">.</span><span class="nx">normalizePath</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">@sources</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@sources</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">unless</span> <span class="nx">@requests</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span><span class="o">?</span>
        <span class="vi">@requests = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span>
          <span class="nv">url: </span><span class="nx">path</span> <span class="o">+</span> <span class="s1">&#39;.html&#39;</span>
          <span class="nv">type: </span><span class="s1">&#39;html&#39;</span>
          <span class="nv">success: </span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@set</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>
          <span class="nv">error: </span><span class="nf">(response) -&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Could not load view from #{path}&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">undefined</span>
    <span class="nv">set: </span><span class="nf">(k,v) -&gt;</span> <span class="nx">@sources</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>

  <span class="nv">prefetch: </span><span class="nf">(path) -&gt;</span>
    <span class="nx">@get</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>A <code>Batman.View</code> can function two ways: a mechanism to load and/or parse html files
or a root of a subclass hierarchy to create rich UI classes, like in Cocoa.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@contexts = </span><span class="p">[]</span>
    <span class="k">super</span></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>Support both <code>options.context</code> and <code>options.contexts</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">context = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">)</span>
      <span class="nx">@contexts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">context</span>
      <span class="nx">@unset</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>Start the rendering by asking for the node</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">node = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">)</span>
      <span class="nx">@render</span> <span class="nx">node</span>
    <span class="k">else</span>
      <span class="nx">@observe</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@render</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>

  <span class="vi">@sourceCache: </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ViewSourceCache</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>Set the source attribute to an html file to have that file loaded.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">source: </span><span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>Set the html to a string of html to have that html parsed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">html: </span><span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>Set an existing DOM node to parse immediately.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">node: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>Fires once a node is parsed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="err">@</span><span class="o">::</span><span class="nx">event</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">).</span><span class="nv">oneShot = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>Where to look for views on the server</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">prefix: </span><span class="s1">&#39;views&#39;</span>

  <span class="nx">@accessor</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="o">-&gt;</span>
      <span class="k">return</span> <span class="nx">@html</span> <span class="k">if</span> <span class="nx">@html</span> <span class="o">&amp;&amp;</span> <span class="nx">@html</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">source = </span><span class="nx">@get</span> <span class="s1">&#39;source&#39;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">source</span>
      <span class="nv">path = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Navigator</span><span class="p">.</span><span class="nx">normalizePath</span><span class="p">(</span><span class="nx">@prefix</span><span class="p">,</span> <span class="nx">source</span><span class="p">)</span>
      <span class="vi">@html = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">sourceCache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nv">set: </span><span class="nf">(_, html) -&gt;</span> <span class="vi">@html = </span><span class="nx">html</span>

  <span class="nx">@accessor</span> <span class="s1">&#39;node&#39;</span>
    <span class="nv">get: </span><span class="o">-&gt;</span>
      <span class="nx">unless</span> <span class="nx">@node</span>
        <span class="nv">html = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">unless</span> <span class="nx">html</span> <span class="o">&amp;&amp;</span> <span class="nx">html</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="vi">@hasContainer = </span><span class="kc">true</span>
        <span class="vi">@node = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s1">&#39;div&#39;</span>
        <span class="nx">$setInnerHTML</span><span class="p">(</span><span class="nx">@node</span><span class="p">,</span> <span class="nx">html</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">@node</span>
    <span class="nv">set: </span><span class="nf">(_, node) -&gt;</span> <span class="vi">@node = </span><span class="nx">node</span>

  <span class="nv">render: </span><span class="nf">(node) -&gt;</span>
    <span class="nx">@event</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">).</span><span class="nx">resetOneShot</span><span class="p">()</span>
    <span class="nx">@_renderer</span><span class="o">?</span><span class="p">.</span><span class="nx">forgetAll</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>We use a renderer with the continuation style rendering engine to not
block user interaction for too long during the render.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">node</span>
      <span class="vi">@_renderer = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Renderer</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">@contexts</span><span class="p">)</span>
      <span class="nx">@_renderer</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;rendered&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@fire</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <h2>DOM Helpers</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <p><code>Batman.Renderer</code> will take a node and parse all recognized data attributes out of it and its children.
It is a continuation style parser, designed not to block for longer than 50ms at a time if the document
fragment is particularly long.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Renderer</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">deferEvery: </span><span class="mi">50</span>

  <span class="nv">constructor: </span><span class="nf">(@node, callback, contexts = []) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="nx">@on</span><span class="p">(</span><span class="s1">&#39;parsed&#39;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="k">if</span> <span class="nx">callback</span><span class="o">?</span>
    <span class="vi">@context = </span><span class="k">if</span> <span class="nx">contexts</span> <span class="k">instanceof</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">RenderContext</span> <span class="k">then</span> <span class="nx">contexts</span> <span class="k">else</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">RenderContext</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">contexts</span><span class="p">...)</span>
    <span class="vi">@immediate = </span><span class="nx">$setImmediate</span> <span class="nx">@start</span>

  <span class="nv">start: </span><span class="o">=&gt;</span>
    <span class="vi">@startTime = </span><span class="k">new</span> <span class="nb">Date</span>
    <span class="nx">@parseNode</span> <span class="nx">@node</span>

  <span class="nv">resume: </span><span class="o">=&gt;</span>
    <span class="vi">@startTime = </span><span class="k">new</span> <span class="nb">Date</span>
    <span class="nx">@parseNode</span> <span class="nx">@resumeNode</span>

  <span class="nv">finish: </span><span class="o">-&gt;</span>
    <span class="vi">@startTime = </span><span class="kc">null</span>
    <span class="nx">@prevent</span> <span class="s1">&#39;stopped&#39;</span>
    <span class="nx">@fire</span> <span class="s1">&#39;parsed&#39;</span>
    <span class="nx">@fire</span> <span class="s1">&#39;rendered&#39;</span>

  <span class="nv">stop: </span><span class="o">-&gt;</span>
    <span class="nx">$clearImmediate</span> <span class="nx">@immediate</span>
    <span class="nx">@fire</span> <span class="s1">&#39;stopped&#39;</span>

  <span class="nv">forgetAll: </span><span class="o">-&gt;</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;parsed&#39;</span><span class="p">,</span> <span class="s1">&#39;rendered&#39;</span><span class="p">,</span> <span class="s1">&#39;stopped&#39;</span><span class="p">]</span>
    <span class="err">@</span><span class="o">::</span><span class="nx">event</span><span class="p">(</span><span class="nx">k</span><span class="p">).</span><span class="nv">oneShot = </span><span class="kc">true</span>

  <span class="nv">bindingRegexp = </span><span class="sr">/^data\-(.*)/</span>
  <span class="nv">sortBindings = </span><span class="nf">(a, b) -&gt;</span>
    <span class="k">if</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;foreach&#39;</span>
      <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;foreach&#39;</span>
      <span class="mi">1</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;formfor&#39;</span>
      <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;formfor&#39;</span>
      <span class="mi">1</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bind&#39;</span>
      <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bind&#39;</span>
      <span class="mi">1</span>
    <span class="k">else</span>
      <span class="mi">0</span>

  <span class="nv">parseNode: </span><span class="nf">(node) -&gt;</span>
    <span class="k">if</span> <span class="nx">@deferEvery</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span> <span class="o">-</span> <span class="nx">@startTime</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">@deferEvery</span>
      <span class="vi">@resumeNode = </span><span class="nx">node</span>
      <span class="vi">@timeout = </span><span class="nx">$setImmediate</span> <span class="nx">@resume</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span> <span class="o">and</span> <span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span>
      <span class="nv">bindings = </span><span class="k">for</span> <span class="nx">attr</span> <span class="k">in</span> <span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span>
        <span class="nv">name = </span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">bindingRegexp</span><span class="p">)</span><span class="o">?</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">continue</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">name</span>
        <span class="k">if</span> <span class="o">~</span><span class="p">(</span><span class="nv">varIndex = </span><span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span>
          <span class="p">[</span><span class="nx">name</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">varIndex</span><span class="p">),</span> <span class="nx">name</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">varIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">value</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="p">[</span><span class="nx">name</span><span class="p">,</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">value</span><span class="p">]</span>

      <span class="k">for</span> <span class="nx">readerArgs</span> <span class="k">in</span> <span class="nx">bindings</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">sortBindings</span><span class="p">)</span>
        <span class="nv">key = </span><span class="nx">readerArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">result = </span><span class="k">if</span> <span class="nx">readerArgs</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">readers</span><span class="p">[</span><span class="nx">readerArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">?</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">@context</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">[</span><span class="nx">readerArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">?</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">readerArgs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">@context</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span>

        <span class="k">if</span> <span class="nx">result</span> <span class="o">is</span> <span class="kc">false</span>
          <span class="nv">skipChildren = </span><span class="kc">true</span>
          <span class="k">break</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">result</span> <span class="k">instanceof</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">RenderContext</span>
          <span class="nv">oldContext = </span><span class="nx">@context</span>
          <span class="vi">@context = </span><span class="nx">result</span>
          <span class="nx">$onParseExit</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="vi">@context = </span><span class="nx">oldContext</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">nextNode = </span><span class="nx">@nextNode</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">skipChildren</span><span class="p">))</span> <span class="k">then</span> <span class="nx">@parseNode</span><span class="p">(</span><span class="nx">nextNode</span><span class="p">)</span> <span class="k">else</span> <span class="nx">@finish</span><span class="p">()</span>

  <span class="nv">nextNode: </span><span class="nf">(node, skipChildren) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">skipChildren</span>
      <span class="nv">children = </span><span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span>
      <span class="k">return</span> <span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">children</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span>

    <span class="nv">sibling = </span><span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span> <span class="c1"># Grab the reference before onParseExit may remove the node</span>
    <span class="nx">$onParseExit</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">forEach</span> <span class="nf">(callback) -&gt;</span> <span class="nx">callback</span><span class="p">()</span>
    <span class="nx">$forgetParseExit</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@node</span> <span class="o">==</span> <span class="nx">node</span>
    <span class="k">return</span> <span class="nx">sibling</span> <span class="k">if</span> <span class="nx">sibling</span>

    <span class="nv">nextParent = </span><span class="nx">node</span>
    <span class="k">while</span> <span class="nv">nextParent = </span><span class="nx">nextParent</span><span class="p">.</span><span class="nx">parentNode</span>
      <span class="nx">$onParseExit</span><span class="p">(</span><span class="nx">nextParent</span><span class="p">).</span><span class="nx">forEach</span> <span class="nf">(callback) -&gt;</span> <span class="nx">callback</span><span class="p">()</span>
      <span class="nx">$forgetParseExit</span><span class="p">(</span><span class="nx">nextParent</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@node</span> <span class="o">==</span> <span class="nx">nextParent</span>

      <span class="nv">parentSibling = </span><span class="nx">nextParent</span><span class="p">.</span><span class="nx">nextSibling</span>
      <span class="k">return</span> <span class="nx">parentSibling</span> <span class="k">if</span> <span class="nx">parentSibling</span>

    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <p>The RenderContext class manages the stack of contexts accessible to a view during rendering.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">RenderContext</span>
  <span class="vi">@start: </span><span class="nf">(contexts...) -&gt;</span>
    <span class="nv">node = </span><span class="k">new</span> <span class="err">@</span><span class="p">(</span><span class="nb">window</span><span class="p">)</span>
    <span class="nx">contexts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span> <span class="k">if</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span>
    <span class="k">while</span> <span class="nv">context = </span><span class="nx">contexts</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
      <span class="nv">node = </span><span class="nx">node</span><span class="p">.</span><span class="nx">descend</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
    <span class="nx">node</span>

  <span class="nv">constructor: </span><span class="nf">(@object, @parent) -&gt;</span>

  <span class="nv">findKey: </span><span class="nf">(key) -&gt;</span>
    <span class="nv">base = </span><span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span>
    <span class="nv">currentNode = </span><span class="err">@</span>
    <span class="k">while</span> <span class="nx">currentNode</span>
      <span class="k">if</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">get</span><span class="o">?</span>
        <span class="nv">val = </span><span class="nx">currentNode</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">base</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">val = </span><span class="nx">currentNode</span><span class="p">.</span><span class="nx">object</span><span class="p">[</span><span class="nx">base</span><span class="p">]</span>

      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">val</span> <span class="o">isnt</span> <span class="s1">&#39;undefined&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p>we need to pass the check if the basekey exists, even if the intermediary keys do not.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="p">[</span><span class="nx">$get</span><span class="p">(</span><span class="nx">currentNode</span><span class="p">.</span><span class="nx">object</span><span class="p">,</span> <span class="nx">key</span><span class="p">),</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">object</span><span class="p">]</span>
      <span class="nv">currentNode = </span><span class="nx">currentNode</span><span class="p">.</span><span class="nx">parent</span>

    <span class="k">return</span> <span class="p">[</span><span class="nx">container</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span> <span class="nx">container</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <p>Below are the three primitives that all the <code>Batman.DOM</code> helpers are composed of.
<code>descend</code> takes an <code>object</code>, and optionally a <code>scopedKey</code>. It creates a new <code>RenderContext</code> leaf node
in the tree with either the object available on the stack or the object available at the <code>scopedKey</code>
on the stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">descend: </span><span class="nf">(object, scopedKey) -&gt;</span>
    <span class="k">if</span> <span class="nx">scopedKey</span>
      <span class="nv">oldObject = </span><span class="nx">object</span>
      <span class="nv">object = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span><span class="p">()</span>
      <span class="nx">object</span><span class="p">[</span><span class="nx">scopedKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">oldObject</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">@constructor</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <p><code>descendWithKey</code> takes a <code>key</code> and optionally a <code>scopedKey</code>. It creates a new <code>RenderContext</code> leaf node
with the runtime value of the <code>key</code> available on the stack or under the <code>scopedKey</code> if given. This
differs from a normal <code>descend</code> in that it looks up the <code>key</code> at runtime (in the parent <code>RenderContext</code>)
and will correctly reflect changes if the value at the <code>key</code> changes. A normal <code>descend</code> takes a concrete
reference to an object which never changes.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">descendWithKey: </span><span class="nf">(key, scopedKey) -&gt;</span>
   <span class="nv">proxy = </span><span class="k">new</span> <span class="nx">ContextProxy</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
   <span class="k">return</span> <span class="nx">@descend</span><span class="p">(</span><span class="nx">proxy</span><span class="p">,</span> <span class="nx">scopedKey</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <p><code>chain</code> flattens a <code>RenderContext</code>'s path to the root.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">chain: </span><span class="o">-&gt;</span>
    <span class="nv">x = </span><span class="p">[]</span>
    <span class="nv">parent = </span><span class="k">this</span>
    <span class="k">while</span> <span class="nx">parent</span>
      <span class="nx">x</span><span class="p">.</span><span class="nx">push</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">object</span>
      <span class="nv">parent = </span><span class="nx">parent</span><span class="p">.</span><span class="nx">parent</span>
    <span class="nx">x</span></pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <p><code>ContextProxy</code> is a simple class which assists in pushing dynamic contexts onto the <code>RenderContext</code> tree.
This happens when a <code>data-context</code> is descended into, for each iteration in a <code>data-foreach</code>,
and in other specific HTML bindings like <code>data-formfor</code>. <code>ContextProxy</code>s use accessors so that if the
value of the object they proxy changes, the changes will be propagated to any thing observing the <code>ContextProxy</code>.
This is good because it allows <code>data-context</code> to take keys which will change, filtered keys, and even filters
which take keypath arguments. It will calculate the context to descend into when any of those keys change
because it preserves the property of a binding, and importantly it exposes a friendly <code>Batman.Object</code>
interface for the rest of the <code>Binding</code> code to work with.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@ContextProxy = </span><span class="k">class</span> <span class="nx">ContextProxy</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
    <span class="nv">isContextProxy: </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <p>Reveal the binding's final value.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@accessor</span> <span class="s1">&#39;proxiedObject&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">@binding</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;filteredValue&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <p>Proxy all gets to the proxied object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@accessor</span>
      <span class="nv">get: </span><span class="nf">(key) -&gt;</span> <span class="nx">@get</span><span class="p">(</span><span class="s2">&quot;proxiedObject.#{key}&quot;</span><span class="p">)</span>
      <span class="nv">set: </span><span class="nf">(key, value) -&gt;</span> <span class="nx">@set</span><span class="p">(</span><span class="s2">&quot;proxiedObject.#{key}&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
      <span class="nv">unset: </span><span class="nf">(key) -&gt;</span> <span class="nx">@unset</span><span class="p">(</span><span class="s2">&quot;proxiedObject.#{key}&quot;</span><span class="p">)</span>

    <span class="nv">constructor: </span><span class="nf">(@renderContext, @keyPath, @localKey) -&gt;</span>
      <span class="vi">@binding = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractBinding</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">@keyPath</span><span class="p">,</span> <span class="nx">@renderContext</span><span class="p">)</span>

<span class="nv">Batman.DOM = </span><span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <p><code>Batman.DOM.readers</code> contains the functions used for binding a node's value or innerHTML, showing/hiding nodes,
and any other <code>data-#{name}=""</code> style DOM directives.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readers: </span><span class="p">{</span>
    <span class="nv">target: </span><span class="nf">(node, key, context, renderer) -&gt;</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">readers</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">renderer</span><span class="p">,</span> <span class="s1">&#39;nodeChange&#39;</span><span class="p">)</span>
      <span class="kc">true</span>

    <span class="nv">source: </span><span class="nf">(node, key, context, renderer) -&gt;</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">readers</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">renderer</span><span class="p">,</span> <span class="s1">&#39;dataChange&#39;</span><span class="p">)</span>
      <span class="kc">true</span>

    <span class="nv">bind: </span><span class="nf">(node, key, context, renderer, only) -&gt;</span>
      <span class="nv">bindingClass = </span><span class="kc">false</span>
      <span class="k">switch</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
        <span class="k">when</span> <span class="s1">&#39;input&#39;</span>
          <span class="k">switch</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
            <span class="k">when</span> <span class="s1">&#39;checkbox&#39;</span>
              <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;checked&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">renderer</span><span class="p">,</span> <span class="nx">only</span><span class="p">)</span>
              <span class="k">return</span> <span class="kc">true</span>
            <span class="k">when</span> <span class="s1">&#39;radio&#39;</span>
              <span class="nv">bindingClass = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">RadioBinding</span>
            <span class="k">when</span> <span class="s1">&#39;file&#39;</span>
              <span class="nv">bindingClass = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">FileBinding</span>
        <span class="k">when</span> <span class="s1">&#39;select&#39;</span>
          <span class="nv">bindingClass = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">SelectBinding</span>
      <span class="nx">bindingClass</span> <span class="o">||=</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">Binding</span>
      <span class="k">new</span> <span class="nx">bindingClass</span><span class="p">(</span><span class="nx">arguments</span><span class="p">...)</span>
      <span class="kc">true</span>

    <span class="nv">context: </span><span class="nf">(node, key, context, renderer) -&gt;</span> <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">descendWithKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>

    <span class="nv">mixin: </span><span class="nf">(node, key, context, renderer) -&gt;</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">MixinBinding</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">descend</span><span class="p">(</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">mixins</span><span class="p">),</span> <span class="nx">renderer</span><span class="p">)</span>
      <span class="kc">true</span>

    <span class="nv">showif: </span><span class="nf">(node, key, context, parentRenderer, invert) -&gt;</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">ShowHideBinding</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">parentRenderer</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">invert</span><span class="p">)</span>
      <span class="kc">true</span>

    <span class="nv">hideif: </span><span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">readers</span><span class="p">.</span><span class="nx">showif</span><span class="p">(</span><span class="nx">arguments</span><span class="p">...,</span> <span class="kc">yes</span><span class="p">)</span>

    <span class="nv">route: </span><span class="nf">(node, key, context) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <p>you must specify the / in front to route directly to hash route</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;/&#39;</span>
        <span class="nv">url = </span><span class="nx">key</span>
      <span class="k">else</span>
        <span class="nv">isHash = </span><span class="nx">key</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">action</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">isHash</span> <span class="k">then</span> <span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="nx">dispatcher</span><span class="p">,</span> <span class="nx">app</span><span class="p">]</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">findKey</span> <span class="s1">&#39;dispatcher&#39;</span>
        <span class="p">[</span><span class="nx">model</span><span class="p">,</span> <span class="nx">container</span><span class="p">]</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">findKey</span> <span class="nx">key</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">isHash</span>

        <span class="nx">dispatcher</span> <span class="o">||=</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span><span class="p">.</span><span class="nx">dispatcher</span>

        <span class="k">if</span> <span class="nx">isHash</span>
          <span class="nv">url = </span><span class="nx">dispatcher</span><span class="p">.</span><span class="nx">findUrl</span> <span class="nv">controller: </span><span class="nx">key</span><span class="p">,</span> <span class="nv">action: </span><span class="nx">action</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Model</span>
          <span class="nx">action</span> <span class="o">||=</span> <span class="s1">&#39;show&#39;</span>
          <span class="nv">name = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">$functionName</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">constructor</span><span class="p">)))</span>
          <span class="nv">url = </span><span class="nx">dispatcher</span><span class="p">.</span><span class="nx">findUrl</span><span class="p">({</span><span class="nv">resource: </span><span class="nx">name</span><span class="p">,</span> <span class="nv">id: </span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="nv">action: </span><span class="nx">action</span><span class="p">})</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">model</span><span class="o">?</span><span class="p">.</span><span class="nx">prototype</span> <span class="c1"># TODO write test for else case</span>
          <span class="nx">action</span> <span class="o">||=</span> <span class="s1">&#39;index&#39;</span>
          <span class="nv">name = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">$functionName</span><span class="p">(</span><span class="nx">model</span><span class="p">)))</span>
          <span class="nv">url = </span><span class="nx">dispatcher</span><span class="p">.</span><span class="nx">findUrl</span><span class="p">({</span><span class="nv">resource: </span><span class="nx">name</span><span class="p">,</span> <span class="nv">action: </span><span class="nx">action</span><span class="p">})</span>

      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">url</span>

      <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;A&#39;</span>
        <span class="nv">node.href = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Navigator</span><span class="p">.</span><span class="nx">defaultClass</span><span class="p">()</span><span class="o">::</span><span class="nx">linkTo</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>

      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">click</span> <span class="nx">node</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">$redirect</span> <span class="nx">url</span>
      <span class="kc">true</span>

    <span class="nv">partial: </span><span class="nf">(node, path, context, renderer) -&gt;</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">partial</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">renderer</span>
      <span class="kc">true</span>

    <span class="nv">defineview: </span><span class="nf">(node, name, context, renderer) -&gt;</span>
      <span class="nx">$onParseExit</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">$removeNode</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">sourceCache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Navigator</span><span class="p">.</span><span class="nx">normalizePath</span><span class="p">(</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span><span class="o">::</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">name</span><span class="p">),</span> <span class="nx">node</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">)</span>
      <span class="kc">false</span>

    <span class="nv">yield: </span><span class="nf">(node, key) -&gt;</span>
      <span class="nx">$setImmediate</span> <span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">yield</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">node</span>
      <span class="kc">true</span>
    <span class="nv">contentfor: </span><span class="nf">(node, key) -&gt;</span>
      <span class="nx">$setImmediate</span> <span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">contentFor</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">node</span>
      <span class="kc">true</span>
    <span class="nv">replace: </span><span class="nf">(node, key) -&gt;</span>
      <span class="nx">$setImmediate</span> <span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">node</span>
      <span class="kc">true</span>
  <span class="p">}</span>
  <span class="nv">_yieldContents: </span><span class="p">{}</span>  <span class="c1"># name/content pairs of content to be yielded</span>
  <span class="nv">_yields: </span><span class="p">{}</span>         <span class="c1"># name/container pairs of yielding nodes</span></pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <p><code>Batman.DOM.attrReaders</code> contains all the DOM directives which take an argument in their name, in the
<code>data-dosomething-argument="keypath"</code> style. This means things like foreach, binding attributes like
disabled or anything arbitrary, descending into a context, binding specific classes, or binding to events.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">attrReaders: </span><span class="p">{</span>
    <span class="nv">_parseAttribute: </span><span class="nf">(value) -&gt;</span>
      <span class="k">if</span> <span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;false&#39;</span> <span class="k">then</span> <span class="nv">value = </span><span class="kc">false</span>
      <span class="k">if</span> <span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;true&#39;</span> <span class="k">then</span> <span class="nv">value = </span><span class="kc">true</span>
      <span class="nx">value</span>

    <span class="nv">source: </span><span class="nf">(node, attr, key, context, renderer) -&gt;</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">renderer</span><span class="p">,</span> <span class="s1">&#39;dataChange&#39;</span>

    <span class="nv">bind: </span><span class="nf">(node, attr, key, context, renderer, only) -&gt;</span>
      <span class="nv">bindingClass = </span><span class="k">switch</span> <span class="nx">attr</span>
        <span class="k">when</span> <span class="s1">&#39;checked&#39;</span><span class="p">,</span> <span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="s1">&#39;selected&#39;</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">CheckedBinding</span>
        <span class="k">when</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;href&#39;</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">NodeAttributeBinding</span>
        <span class="k">when</span> <span class="s1">&#39;class&#39;</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">ClassBinding</span>
        <span class="k">when</span> <span class="s1">&#39;style&#39;</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">StyleBinding</span>
        <span class="k">else</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AttributeBinding</span>
      <span class="k">new</span> <span class="nx">bindingClass</span><span class="p">(</span><span class="nx">arguments</span><span class="p">...)</span>
      <span class="kc">true</span>

    <span class="nv">context: </span><span class="nf">(node, contextName, key, context) -&gt;</span> <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">descendWithKey</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">contextName</span><span class="p">)</span>

    <span class="nv">event: </span><span class="nf">(node, eventName, key, context) -&gt;</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">EventBinding</span><span class="p">(</span><span class="nx">arguments</span><span class="p">...)</span>
      <span class="kc">true</span>

    <span class="nv">addclass: </span><span class="nf">(node, className, key, context, parentRenderer, invert) -&gt;</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AddClassBinding</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">className</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">parentRenderer</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">invert</span><span class="p">)</span>
      <span class="kc">true</span>

    <span class="nv">removeclass: </span><span class="nf">(node, className, key, context, parentRenderer) -&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">.</span><span class="nx">addclass</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">className</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">parentRenderer</span><span class="p">,</span> <span class="kc">yes</span>

    <span class="nv">foreach: </span><span class="nf">(node, iteratorName, key, context, parentRenderer) -&gt;</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">IteratorBinding</span><span class="p">(</span><span class="nx">arguments</span><span class="p">...)</span>
      <span class="kc">false</span> <span class="c1"># Return false so the Renderer doesn&#39;t descend into this node&#39;s children.</span>

    <span class="nv">formfor: </span><span class="nf">(node, localName, key, context) -&gt;</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">submit</span> <span class="nx">node</span><span class="p">,</span> <span class="nf">(node, e) -&gt;</span> <span class="nx">$preventDefault</span> <span class="nx">e</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">descendWithKey</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">localName</span><span class="p">)</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <p><code>Batman.DOM.events</code> contains the helpers used for binding to events. These aren't called by
DOM directives, but are used to handle specific events by the <code>data-event-#{name}</code> helper.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">events: </span><span class="p">{</span>
    <span class="nv">click: </span><span class="nf">(node, callback, eventName = &#39;click&#39;) -&gt;</span>
      <span class="nx">$addEventListener</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
        <span class="nx">callback</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>
        <span class="nx">$preventDefault</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

      <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;A&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">node</span><span class="p">.</span><span class="nx">href</span>
        <span class="nv">node.href = </span><span class="s1">&#39;#&#39;</span>

      <span class="nx">node</span>

    <span class="nv">doubleclick: </span><span class="nf">(node, callback) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <p>The actual DOM event is called <code>dblclick</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">click</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="s1">&#39;dblclick&#39;</span>

    <span class="nv">change: </span><span class="nf">(node, callback) -&gt;</span>
      <span class="nv">eventNames = </span><span class="k">switch</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
        <span class="k">when</span> <span class="s1">&#39;TEXTAREA&#39;</span> <span class="k">then</span> <span class="p">[</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">]</span>
        <span class="k">when</span> <span class="s1">&#39;INPUT&#39;</span>
          <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;TEXT&#39;</span>
            <span class="nv">oldCallback = </span><span class="nx">callback</span>
            <span class="nv">callback = </span><span class="nf">(e) -&gt;</span>
              <span class="k">return</span> <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;keyup&#39;</span> <span class="o">&amp;&amp;</span> <span class="mi">13</span> <span class="o">&lt;=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">&lt;=</span> <span class="mi">14</span>
              <span class="nx">oldCallback</span><span class="p">(</span><span class="nx">arguments</span><span class="p">...)</span>
            <span class="p">[</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">]</span>
          <span class="k">else</span>
            <span class="p">[</span><span class="s1">&#39;change&#39;</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;change&#39;</span><span class="p">]</span>

      <span class="k">for</span> <span class="nx">eventName</span> <span class="k">in</span> <span class="nx">eventNames</span>
        <span class="nx">$addEventListener</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
          <span class="nx">callback</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>

    <span class="nv">submit: </span><span class="nf">(node, callback) -&gt;</span>
      <span class="k">if</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">nodeIsEditable</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
        <span class="nx">$addEventListener</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
          <span class="k">if</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">keyCode</span> <span class="o">is</span> <span class="mi">13</span> <span class="o">||</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">which</span> <span class="o">is</span> <span class="mi">13</span> <span class="o">||</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">keyIdentifier</span> <span class="o">is</span> <span class="s1">&#39;Enter&#39;</span> <span class="o">||</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">key</span> <span class="o">is</span> <span class="s1">&#39;Enter&#39;</span>
            <span class="nx">$preventDefault</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nx">callback</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>
      <span class="k">else</span>
        <span class="nx">$addEventListener</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span>
          <span class="nx">$preventDefault</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="nx">callback</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>

      <span class="nx">node</span>

    <span class="nv">other: </span><span class="nf">(node, eventName, callback) -&gt;</span> <span class="nx">$addEventListener</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nf">(args...) -&gt;</span> <span class="nx">callback</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <p><code>yield</code> and <code>contentFor</code> are used to declare partial views and then pull them in elsewhere.
<code>replace</code> is used to replace yielded content.
This can be used for abstraction as well as repetition.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">yield: </span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nv">_replaceContent = </span><span class="o">!</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;yielded&#39;</span><span class="p">))</span> <span class="o">-&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yields</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span></pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <p>render any content for this yield</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">contents = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yieldContents</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">_replaceContent</span>
        <span class="nx">$setInnerHTML</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">true</span>
      <span class="k">for</span> <span class="nx">content</span> <span class="k">in</span> <span class="nx">contents</span> <span class="k">when</span> <span class="o">!</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="s1">&#39;yielded&#39;</span><span class="p">)</span>
        <span class="nv">content = </span><span class="nx">content</span><span class="p">.</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="k">if</span> <span class="nx">$isChildOf</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span>
        <span class="nx">$appendChild</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="kc">true</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="s1">&#39;yielded&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <p>delete references to the rendered content nodes and mark the node as yielded</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">delete</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yieldContents</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;yielded&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>

  <span class="nv">contentFor: </span><span class="nf">(name, node, _replaceContent) -&gt;</span>
    <span class="nv">contents = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yieldContents</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">contents</span> <span class="k">then</span> <span class="nx">contents</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="k">else</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yieldContents</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">node</span><span class="p">]</span>

    <span class="k">if</span> <span class="nv">yieldingNode = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yields</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">yield</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">yieldingNode</span><span class="p">,</span> <span class="nx">_replaceContent</span>

  <span class="nv">replace: </span><span class="nf">(name, node) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">contentFor</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="kc">true</span>

  <span class="nv">partial: </span><span class="nf">(container, path, context, renderer) -&gt;</span>
    <span class="nx">renderer</span><span class="p">.</span><span class="nx">prevent</span> <span class="s1">&#39;rendered&#39;</span>

    <span class="nv">view = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span>
      <span class="nv">source: </span><span class="nx">path</span>
      <span class="nv">contexts: </span><span class="nx">context</span><span class="p">.</span><span class="nx">chain</span><span class="p">()</span>
    <span class="nx">view</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">$setInnerHTML</span> <span class="nx">container</span><span class="p">,</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <p>Render the partial content into the data-partial node
Text nodes move when they are appended, so copy childNodes</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">children = </span><span class="p">(</span><span class="nx">node</span> <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">view</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">).</span><span class="nx">childNodes</span><span class="p">)</span>
      <span class="nx">$appendChild</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">child</span><span class="p">)</span> <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">children</span>
      <span class="nx">renderer</span><span class="p">.</span><span class="nx">allowAndFire</span> <span class="s1">&#39;rendered&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <p>Adds a binding or binding-like object to the <code>bindings</code> set in a node's
data, so that upon node removal we can unset the binding and any other objects
it retains.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">trackBinding: $trackBinding = </span><span class="nf">(binding, node) -&gt;</span>
    <span class="k">if</span> <span class="nv">bindings = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;bindings&#39;</span>
      <span class="nx">bindings</span><span class="p">.</span><span class="nx">add</span> <span class="nx">binding</span>
    <span class="k">else</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;bindings&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span><span class="p">(</span><span class="nx">binding</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p>Removes listeners and bindings tied to <code>node</code>, allowing it to be cleared
or removed without leaking memory</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unbindNode: $unbindNode = </span><span class="nf">(node) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <p>break down all bindings</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">bindings = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;bindings&#39;</span>
      <span class="nx">bindings</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(binding) -&gt;</span> <span class="nx">binding</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-162">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-162">&#182;</a>               </div>               <p>remove all event listeners</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">listeners = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;listeners&#39;</span>
      <span class="k">for</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">eventListeners</span> <span class="k">of</span> <span class="nx">listeners</span>
        <span class="nx">eventListeners</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(listener) -&gt;</span>
          <span class="nx">$removeEventListener</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">listener</span></pre></div>             </td>           </tr>                               <tr id="section-163">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-163">&#182;</a>               </div>               <p>remove all bindings and other data associated with this node</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Batman</span><span class="p">.</span><span class="nx">removeData</span> <span class="nx">node</span>                   <span class="c1"># external data (Batman.data)</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">removeData</span> <span class="nx">node</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">true</span>  <span class="c1"># internal data (Batman._data)</span></pre></div>             </td>           </tr>                               <tr id="section-164">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-164">&#182;</a>               </div>               <p>Unbinds the tree rooted at <code>node</code>.
When set to <code>false</code>, <code>unbindRoot</code> skips the <code>node</code> before unbinding all of its children.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unbindTree: $unbindTree = </span><span class="nf">(node, unbindRoot = true) -&gt;</span>
    <span class="nx">$unbindNode</span> <span class="nx">node</span> <span class="k">if</span> <span class="nx">unbindRoot</span>
    <span class="nx">$unbindTree</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span></pre></div>             </td>           </tr>                               <tr id="section-165">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-165">&#182;</a>               </div>               <p>Memory-safe setting of a node's innerHTML property</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setInnerHTML: $setInnerHTML = </span><span class="nf">(node, html, args...) -&gt;</span>
    <span class="nx">hide</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span> <span class="k">when</span> <span class="nv">hide = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="s1">&#39;hide&#39;</span><span class="p">)</span>
    <span class="nx">$unbindTree</span> <span class="nx">node</span><span class="p">,</span> <span class="kc">false</span>
    <span class="nx">node</span><span class="o">?</span><span class="p">.</span><span class="nv">innerHTML = </span><span class="nx">html</span></pre></div>             </td>           </tr>                               <tr id="section-166">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-166">&#182;</a>               </div>               <p>Memory-safe removal of a node from the DOM</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">removeNode: $removeNode = </span><span class="nf">(node) -&gt;</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="o">?</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">node</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">didRemoveNode</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>

  <span class="nv">appendChild: $appendChild = </span><span class="nf">(parent, child, args...) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="nx">parent</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span>

  <span class="nv">insertBefore: $insertBefore = </span><span class="nf">(parentNode, newNode, referenceNode = null) -&gt;</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">referenceNode</span> <span class="o">or</span> <span class="nx">parentNode</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">0</span>
      <span class="nx">$appendChild</span> <span class="nx">parentNode</span><span class="p">,</span> <span class="nx">newNode</span>
    <span class="k">else</span>
      <span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span> <span class="nx">newNode</span><span class="p">,</span> <span class="nx">referenceNode</span>

  <span class="nv">valueForNode: </span><span class="nf">(node, value = &#39;&#39;) -&gt;</span>
    <span class="nv">isSetting = </span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">switch</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
      <span class="k">when</span> <span class="s1">&#39;INPUT&#39;</span>
        <span class="k">if</span> <span class="nx">isSetting</span> <span class="k">then</span> <span class="p">(</span><span class="nv">node.value = </span><span class="nx">value</span><span class="p">)</span> <span class="k">else</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span>
      <span class="k">when</span> <span class="s1">&#39;TEXTAREA&#39;</span>
        <span class="k">if</span> <span class="nx">isSetting</span>
          <span class="nv">node.innerHTML = node.value = </span><span class="nx">value</span>
        <span class="k">else</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">innerHTML</span>
      <span class="k">when</span> <span class="s1">&#39;SELECT&#39;</span>
        <span class="nv">node.value = </span><span class="nx">value</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">isSetting</span>
          <span class="nx">$setInnerHTML</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">value</span>
        <span class="k">else</span> <span class="nx">node</span><span class="p">.</span><span class="nx">innerHTML</span>

  <span class="nv">nodeIsEditable: </span><span class="nf">(node) -&gt;</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;INPUT&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXTAREA&#39;</span><span class="p">,</span> <span class="s1">&#39;SELECT&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-167">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-167">&#182;</a>               </div>               <p>`$addEventListener uses attachEvent when necessary</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">addEventListener: $addEventListener = </span><span class="nf">(node, eventName, callback) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-168">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-168">&#182;</a>               </div>               <p>store the listener in Batman.data</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nv">listeners = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;listeners&#39;</span>
      <span class="nv">listeners = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;listeners&#39;</span><span class="p">,</span> <span class="p">{}</span>
    <span class="nx">unless</span> <span class="nx">listeners</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span>
      <span class="nx">listeners</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span>
    <span class="nx">listeners</span><span class="p">[</span><span class="nx">eventName</span><span class="p">].</span><span class="nx">add</span> <span class="nx">callback</span>

    <span class="k">if</span> <span class="nx">$hasAddEventListener</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="kc">false</span>
    <span class="k">else</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">attachEvent</span> <span class="s2">&quot;on#{eventName}&quot;</span><span class="p">,</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-169">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-169">&#182;</a>               </div>               <p><code>$removeEventListener</code> uses detachEvent when necessary</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">removeEventListener: $removeEventListener = </span><span class="nf">(node, eventName, callback) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-170">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-170">&#182;</a>               </div>               <p>remove the listener from Batman.data</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">listeners = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;listeners&#39;</span>
      <span class="k">if</span> <span class="nv">eventListeners = </span><span class="nx">listeners</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span>
        <span class="nx">eventListeners</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">callback</span>

    <span class="k">if</span> <span class="nx">$hasAddEventListener</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">removeEventListener</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="kc">false</span>
    <span class="k">else</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">detachEvent</span> <span class="s1">&#39;on&#39;</span><span class="o">+</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">callback</span>

  <span class="nv">hasAddEventListener: $hasAddEventListener = </span><span class="o">!!</span><span class="nb">window</span><span class="o">?</span><span class="p">.</span><span class="nx">addEventListener</span>

  <span class="nv">didRemoveNode: </span><span class="nf">(node) -&gt;</span> <span class="nx">$unbindTree</span> <span class="nx">node</span>

  <span class="nv">onParseExit: $onParseExit = </span><span class="nf">(node, callback) -&gt;</span>
    <span class="nv">set = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;onParseExit&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;onParseExit&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span><span class="p">)</span>
    <span class="nx">set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">callback</span> <span class="k">if</span> <span class="nx">callback</span><span class="o">?</span>
    <span class="nx">set</span>

  <span class="nv">forgetParseExit: $forgetParseExit = </span><span class="nf">(node, callback) -&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">removeData</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;onParseExit&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-171">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-171">&#182;</a>               </div>               <p>Bindings are shortlived objects which manage the observation of any keypaths a <code>data</code> attribute depends on.
Bindings parse any keypaths which are filtered and use an accessor to apply the filters, and thus enjoy
the automatic trigger and dependency system that Batman.Objects use. Every, and I really mean every method
which uses filters has to be defined in terms of a new binding. This is so that the proper order of
objects is traversed and any observers are properly attached.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span></pre></div>             </td>           </tr>                               <tr id="section-172">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-172">&#182;</a>               </div>               <p>A beastly regular expression for pulling keypaths out of the JSON arguments to a filter.
It makes the following matches:</p>

<ul>
<li><code>foo</code> and <code>baz.qux</code> in <code>foo, "bar", baz.qux</code></li>
<li><code>foo.bar.baz</code> in <code>true, false, "true", "false", foo.bar.baz</code></li>
<li><code>true.bar</code> in <code>2, true.bar</code></li>
<li><code>truesay</code> in truesay</li>
<li>no matches in <code>"bar", 2, {"x":"y", "Z": foo.bar.baz}, "baz"</code></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">keypath_rx = </span><span class="err">///</span>
    <span class="p">(</span><span class="o">^|</span><span class="p">,)</span>             <span class="c1"># Match either the start of an arguments list or the start of a space inbetween commas.</span>
    <span class="err">\</span><span class="nx">s</span><span class="o">*</span>               <span class="c1"># Be insensitive to whitespace between the comma and the actual arguments.</span>
    <span class="p">(</span><span class="o">?!</span>               <span class="c1"># Use a lookahead to ensure we aren&#39;t matching true or false:</span>
      <span class="p">(</span><span class="o">?:</span><span class="kc">true</span><span class="o">|</span><span class="kc">false</span><span class="p">)</span>  <span class="c1"># Match either true or false ...</span>
      <span class="err">\</span><span class="nx">s</span><span class="o">*</span>             <span class="c1"># and make sure that there&#39;s nothing else that comes after the true or false ...</span>
      <span class="p">(</span><span class="o">?:</span><span class="nx">$</span><span class="o">|</span><span class="p">,)</span>         <span class="c1"># before the end of this argument in the list.</span>
    <span class="p">)</span>
    <span class="p">(</span>
      <span class="p">[</span><span class="nx">a</span><span class="o">-</span><span class="nx">zA</span><span class="o">-</span><span class="nx">Z</span><span class="p">][</span><span class="err">\</span><span class="nx">w</span><span class="err">\</span><span class="p">.]</span><span class="o">*</span> <span class="c1"># Now that true and false can&#39;t be matched, match a dot delimited list of keys.</span>
      <span class="p">[</span><span class="err">\</span><span class="o">?</span><span class="err">\</span><span class="o">!</span><span class="p">]</span><span class="o">?</span>         <span class="c1"># Allow ? and ! at the end of a keypath to support Ruby&#39;s methods</span>
    <span class="p">)</span>
    <span class="err">\</span><span class="nx">s</span><span class="o">*</span>               <span class="c1"># Be insensitive to whitespace before the next comma or end of the filter arguments list.</span>
    <span class="p">(</span><span class="o">?=</span><span class="nx">$</span><span class="o">|</span><span class="p">,)</span>             <span class="c1"># Match either the next comma or the end of the filter arguments list.</span>
    <span class="o">/</span><span class="err">//g</span></pre></div>             </td>           </tr>                               <tr id="section-173">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-173">&#182;</a>               </div>               <p>A less beastly pair of regular expressions for pulling out the [] syntax <code>get</code>s in a binding string, and
dotted names that follow them.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get_dot_rx = </span><span class="sr">/(?:\]\.)(.+?)(?=[\[\.]|\s*\||$)/</span>
  <span class="nv">get_rx = </span><span class="sr">/(?!^\s*)\[(.*?)\]/g</span>

  <span class="nv">deProxy = </span><span class="nf">(object) -&gt;</span> <span class="k">if</span> <span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">RenderContext</span><span class="p">.</span><span class="nx">ContextProxy</span> <span class="k">then</span> <span class="nx">object</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;proxiedObject&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nx">object</span></pre></div>             </td>           </tr>                               <tr id="section-174">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-174">&#182;</a>               </div>               <p>The <code>filteredValue</code> which calculates the final result by reducing the initial value through all the filters.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@accessor</span> <span class="s1">&#39;filteredValue&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nv">unfilteredValue = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;unfilteredValue&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">@filterFunctions</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">developer.currentFilterStack = </span><span class="nx">@renderContext</span>

      <span class="nv">result = </span><span class="nx">@filterFunctions</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">value</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-175">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-175">&#182;</a>               </div>               <p>Get any argument keypaths from the context stored at parse time.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">args = </span><span class="nx">@filterArguments</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">map</span> <span class="nf">(argument) -&gt;</span>
          <span class="k">if</span> <span class="nx">argument</span><span class="p">.</span><span class="nx">_keypath</span>
            <span class="nx">$get</span><span class="p">(</span><span class="nx">argument</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span> <span class="nx">argument</span><span class="p">.</span><span class="nx">_keypath</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="nx">argument</span></pre></div>             </td>           </tr>                               <tr id="section-176">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-176">&#182;</a>               </div>               <p>Apply the filter.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">value</span>
        <span class="nv">args = </span><span class="nx">args</span><span class="p">.</span><span class="nx">map</span> <span class="nx">deProxy</span>
        <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@renderContext</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">unfilteredValue</span><span class="p">)</span>
      <span class="nv">developer.currentFilterStack = </span><span class="kc">null</span>
      <span class="nx">result</span>
    <span class="k">else</span>
      <span class="nx">deProxy</span><span class="p">(</span><span class="nx">unfilteredValue</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-177">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-177">&#182;</a>               </div>               <p>The <code>unfilteredValue</code> is whats evaluated each time any dependents change.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@accessor</span> <span class="s1">&#39;unfilteredValue&#39;</span><span class="p">,</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-178">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-178">&#182;</a>               </div>               <p>If we're working with an <code>@key</code> and not an <code>@value</code>, find the context the key belongs to so we can
hold a reference to it for passing to the <code>dataChange</code> and <code>nodeChange</code> observers.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">k = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
      <span class="nx">@get</span><span class="p">(</span><span class="s2">&quot;keyContext.#{k}&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-179">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-179">&#182;</a>               </div>               <p>The <code>keyContext</code> accessor is</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@accessor</span> <span class="s1">&#39;keyContext&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">@renderContext</span><span class="p">.</span><span class="nx">findKey</span><span class="p">(</span><span class="nx">@key</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

  <span class="nv">bindImmediately: </span><span class="kc">true</span>

  <span class="nv">constructor: </span><span class="nf">(@node, @keyPath, @renderContext, @renderer, @only = false) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">trackBinding</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">@node</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@node</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-180">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-180">&#182;</a>               </div>               <p>Pull out the <code>@key</code> and filter from the <code>@keyPath</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@parseFilter</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-181">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-181">&#182;</a>               </div>               <p>Observe the node and the data.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@bind</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@bindImmediately</span>

  <span class="nv">bind: </span><span class="o">-&gt;</span>
    <span class="nv">shouldSet = </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-182">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-182">&#182;</a>               </div>               <p>And attach them.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@node</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="nx">@only</span> <span class="k">in</span> <span class="p">[</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;nodeChange&#39;</span><span class="p">]</span> <span class="o">and</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">nodeIsEditable</span><span class="p">(</span><span class="nx">@node</span><span class="p">)</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">change</span> <span class="nx">@node</span><span class="p">,</span> <span class="o">=&gt;</span>
        <span class="nv">shouldSet = </span><span class="kc">no</span>
        <span class="nx">@nodeChange</span><span class="o">?</span><span class="p">(</span><span class="nx">@node</span><span class="p">,</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;keyContext&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">@value</span><span class="p">)</span>
        <span class="nv">shouldSet = </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-183">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-183">&#182;</a>               </div>               <p>Observe the value of this binding's <code>filteredValue</code> and fire it immediately to update the node.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@only</span> <span class="k">in</span> <span class="p">[</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;dataChange&#39;</span><span class="p">]</span>
      <span class="nx">@observeAndFire</span> <span class="s1">&#39;filteredValue&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">shouldSet</span>
          <span class="nx">@dataChange</span><span class="o">?</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">@node</span><span class="p">)</span>

  <span class="nv">destroy: </span><span class="o">-&gt;</span>
    <span class="nx">@forget</span><span class="p">()</span>
    <span class="nx">@_batman</span><span class="p">.</span><span class="nx">properties</span><span class="o">?</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(key, property) -&gt;</span> <span class="nx">property</span><span class="p">.</span><span class="nx">die</span><span class="p">()</span>

  <span class="nv">parseFilter: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-184">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-184">&#182;</a>               </div>               <p>Store the function which does the filtering and the arguments (all except the actual value to apply the
filter to) in these arrays.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@filterFunctions = </span><span class="p">[]</span>
    <span class="vi">@filterArguments = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-185">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-185">&#182;</a>               </div>               <p>Rewrite [] style gets, replace quotes to be JSON friendly, and split the string by pipes to see if there are any filters.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">keyPath = </span><span class="nx">@keyPath</span>
    <span class="nv">keyPath = </span><span class="nx">keyPath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">get_dot_rx</span><span class="p">,</span> <span class="s2">&quot;][&#39;$1&#39;]&quot;</span><span class="p">)</span> <span class="k">while</span> <span class="nx">get_dot_rx</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">keyPath</span><span class="p">)</span>  <span class="c1"># Stupid lack of lookbehind assertions...</span>
    <span class="nv">filters = </span><span class="nx">keyPath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">get_rx</span><span class="p">,</span> <span class="s2">&quot; | get $1 &quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&#39;/g</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="sr">/(?!&quot;)\s+\|\s+(?!&quot;)/</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-186">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-186">&#182;</a>               </div>               <p>The key will is always the first token before the pipe.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">try</span>
      <span class="nv">key = </span><span class="nx">@parseSegment</span><span class="p">(</span><span class="nv">orig = </span><span class="nx">filters</span><span class="p">.</span><span class="nx">shift</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">catch</span> <span class="nx">e</span>
      <span class="nx">developer</span><span class="p">.</span><span class="nx">warn</span> <span class="nx">e</span>
      <span class="nx">developer</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;Error! Couldn&#39;t parse keypath in \&quot;#{orig}\&quot;. Parsing error above.&quot;</span>
    <span class="k">if</span> <span class="nx">key</span> <span class="o">and</span> <span class="nx">key</span><span class="p">.</span><span class="nx">_keypath</span>
      <span class="vi">@key = </span><span class="nx">key</span><span class="p">.</span><span class="nx">_keypath</span>
    <span class="k">else</span>
      <span class="vi">@value = </span><span class="nx">key</span>

    <span class="k">if</span> <span class="nx">filters</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">while</span> <span class="nv">filterString = </span><span class="nx">filters</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-187">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-187">&#182;</a>               </div>               <p>For each filter, get the name and the arguments by splitting on the first space.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">split = </span><span class="nx">filterString</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">~</span><span class="nx">split</span>
          <span class="nv">filterName = </span><span class="nx">filterString</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">split</span><span class="p">)</span>
          <span class="nv">args = </span><span class="nx">filterString</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">split</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nv">filterName = </span><span class="nx">filterString</span></pre></div>             </td>           </tr>                               <tr id="section-188">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-188">&#182;</a>               </div>               <p>If the filter exists, grab it.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nv">filter = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Filters</span><span class="p">[</span><span class="nx">filterName</span><span class="p">]</span>
          <span class="nx">@filterFunctions</span><span class="p">.</span><span class="nx">push</span> <span class="nx">filter</span></pre></div>             </td>           </tr>                               <tr id="section-189">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-189">&#182;</a>               </div>               <p>Get the arguments for the filter by parsing the args as JSON, or
just pushing an placeholder array</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">args</span>
            <span class="k">try</span>
              <span class="nx">@filterArguments</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@parseSegment</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span>
            <span class="k">catch</span> <span class="nx">e</span>
              <span class="nx">developer</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;Bad filter arguments \&quot;#{args}\&quot;!&quot;</span>
          <span class="k">else</span>
            <span class="nx">@filterArguments</span><span class="p">.</span><span class="nx">push</span> <span class="p">[]</span>
        <span class="k">else</span>
          <span class="nx">developer</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;Unrecognized filter &#39;#{filterName}&#39; in key \&quot;#{@keyPath}\&quot;!&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-190">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-190">&#182;</a>               </div>               <p>Map over each array of arguments to grab the context for any keypaths.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@filterArguments = </span><span class="nx">@filterArguments</span><span class="p">.</span><span class="nx">map</span> <span class="p">(</span><span class="nx">argumentList</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">argumentList</span><span class="p">.</span><span class="nx">map</span> <span class="p">(</span><span class="nx">argument</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="k">if</span> <span class="nx">argument</span><span class="p">.</span><span class="nx">_keypath</span></pre></div>             </td>           </tr>                               <tr id="section-191">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-191">&#182;</a>               </div>               <p>Discard the value (for the time being) and store the context for the keypath in <code>context</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">[</span><span class="nx">_</span><span class="p">,</span> <span class="nx">argument</span><span class="p">.</span><span class="nx">context</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@renderContext</span><span class="p">.</span><span class="nx">findKey</span> <span class="nx">argument</span><span class="p">.</span><span class="nx">_keypath</span>
          <span class="nx">argument</span></pre></div>             </td>           </tr>                               <tr id="section-192">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-192">&#182;</a>               </div>               <p>Turn a piece of a <code>data</code> keypath into a usable javascript object.
 + replacing keypaths using the above regular expression
 + wrapping the <code>,</code> delimited list in square brackets
 + and <code>JSON.parse</code>ing them as an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">parseSegment: </span><span class="nf">(segment) -&gt;</span>
    <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">keypath_rx</span><span class="p">,</span> <span class="s2">&quot;$1{\&quot;_keypath\&quot;: \&quot;$2\&quot;}&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span> <span class="p">)</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractAttributeBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractBinding</span>
  <span class="nv">constructor: </span><span class="nf">(node, @attributeName, args...) -&gt;</span> <span class="k">super</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">args</span><span class="p">...)</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractCollectionBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractAttributeBinding</span>

  <span class="nv">bindCollection: </span><span class="nf">(newCollection) -&gt;</span>
    <span class="nx">unless</span> <span class="nx">newCollection</span> <span class="o">==</span> <span class="nx">@collection</span>
      <span class="nx">@unbindCollection</span><span class="p">()</span>
      <span class="vi">@collection = </span><span class="nx">newCollection</span>
      <span class="k">if</span> <span class="nx">@collection</span>
        <span class="k">if</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">isObservable</span> <span class="o">&amp;&amp;</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">toArray</span>
          <span class="nx">@collection</span><span class="p">.</span><span class="nx">observe</span> <span class="s1">&#39;toArray&#39;</span><span class="p">,</span> <span class="nx">@handleArrayChanged</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">isEventEmitter</span>
          <span class="nx">@collection</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;itemsWereAdded&#39;</span><span class="p">,</span> <span class="nx">@handleItemsWereAdded</span>
          <span class="nx">@collection</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;itemsWereRemoved&#39;</span><span class="p">,</span> <span class="nx">@handleItemsWereRemoved</span>
        <span class="k">else</span>
          <span class="k">return</span> <span class="kc">false</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="k">return</span> <span class="kc">false</span>

  <span class="nv">unbindCollection: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@collection</span>
      <span class="k">if</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">isObservable</span> <span class="o">&amp;&amp;</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">toArray</span>
        <span class="nx">@collection</span><span class="p">.</span><span class="nx">forget</span><span class="p">(</span><span class="s1">&#39;toArray&#39;</span><span class="p">,</span> <span class="nx">@handleArrayChanged</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">isEventEmitter</span>
        <span class="nx">@collection</span><span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s1">&#39;itemsWereAdded&#39;</span><span class="p">).</span><span class="nx">removeHandler</span><span class="p">(</span><span class="nx">@handleItemsWereAdded</span><span class="p">)</span>
        <span class="nx">@collection</span><span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s1">&#39;itemsWereRemoved&#39;</span><span class="p">).</span><span class="nx">removeHandler</span><span class="p">(</span><span class="nx">@handleItemsWereRemoved</span><span class="p">)</span>

  <span class="nv">handleItemsWereAdded: </span><span class="o">-&gt;</span>
  <span class="nv">handleItemsWereRemoved: </span><span class="o">-&gt;</span>
  <span class="nv">handleArrayChanged: </span><span class="o">-&gt;</span>

  <span class="nv">destroy: </span><span class="o">-&gt;</span>
    <span class="nx">@unbindCollection</span><span class="p">()</span>
    <span class="k">super</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">Binding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractBinding</span>
  <span class="nv">nodeChange: </span><span class="nf">(node, context) -&gt;</span>
    <span class="k">if</span> <span class="nx">@key</span> <span class="o">&amp;&amp;</span> <span class="nx">@filterFunctions</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;keyContext&#39;</span><span class="p">).</span><span class="nx">set</span> <span class="nx">@key</span><span class="p">,</span> <span class="nx">@node</span><span class="p">.</span><span class="nx">value</span>

  <span class="nv">dataChange: </span><span class="nf">(value, node) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">valueForNode</span> <span class="nx">@node</span><span class="p">,</span> <span class="nx">value</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AttributeBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractAttributeBinding</span>
  <span class="nv">dataChange: </span><span class="nf">(value) -&gt;</span> <span class="nx">@node</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">@attributeName</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
  <span class="nv">nodeChange: </span><span class="nf">(node) -&gt;</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;keyContext&#39;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="nx">@key</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">.</span><span class="nx">_parseAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">@attributeName</span><span class="p">)))</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">NodeAttributeBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractAttributeBinding</span>
  <span class="nv">dataChange: </span><span class="nf">(value) -&gt;</span> <span class="nx">@node</span><span class="p">[</span><span class="nx">@attributeName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
  <span class="nv">nodeChange: </span><span class="nf">(node) -&gt;</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;keyContext&#39;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="nx">@key</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">.</span><span class="nx">_parseAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">[</span><span class="nx">@attributeName</span><span class="p">]))</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">ShowHideBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractBinding</span>
  <span class="nv">constructor: </span><span class="nf">(node, className, key, context, parentRenderer, @invert = false) -&gt;</span>
    <span class="vi">@originalDisplay = </span><span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span>
    <span class="k">super</span>

  <span class="nv">dataChange: </span><span class="nf">(value) -&gt;</span>
    <span class="k">if</span> <span class="o">!!</span><span class="nx">value</span> <span class="o">is</span> <span class="o">!</span><span class="nx">@invert</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">@node</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@node</span><span class="p">)</span>
      <span class="vi">@node.style.display = </span><span class="nx">@originalDisplay</span>
    <span class="k">else</span>
      <span class="nv">hide = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">data</span> <span class="nx">@node</span><span class="p">,</span> <span class="s1">&#39;hide&#39;</span>
      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">hide</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span>
        <span class="nx">hide</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@node</span>
      <span class="k">else</span>
        <span class="vi">@node.style.display = </span><span class="s1">&#39;none&#39;</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">CheckedBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">NodeAttributeBinding</span>
  <span class="nv">dataChange: </span><span class="nf">(value) -&gt;</span>
    <span class="nx">@node</span><span class="p">[</span><span class="nx">@attributeName</span><span class="p">]</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-193">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-193">&#182;</a>               </div>               <p>Update the parent's binding if necessary</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span><span class="p">(</span><span class="nx">@node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s1">&#39;updateBinding&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">()</span>

  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span></pre></div>             </td>           </tr>                               <tr id="section-194">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-194">&#182;</a>               </div>               <p>Attach this binding to the node under the attribute name so that parent
bindings can query this binding and modify its state. This is useful
for <options> within a select or radio buttons.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span> <span class="nx">@node</span><span class="p">,</span> <span class="nx">@attributeName</span><span class="p">,</span> <span class="err">@</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">ClassBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractCollectionBinding</span>
  <span class="nv">dataChange: </span><span class="nf">(value) -&gt;</span>
    <span class="k">if</span> <span class="nx">value</span><span class="o">?</span>
      <span class="nx">@unbindCollection</span><span class="p">()</span>
      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
        <span class="vi">@node.className = </span><span class="nx">value</span>
      <span class="k">else</span>
        <span class="nx">@bindCollection</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
        <span class="nx">@updateFromCollection</span><span class="p">()</span>

  <span class="nv">updateFromCollection: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@collection</span>
      <span class="nv">array = </span><span class="k">if</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">map</span>
        <span class="nx">@collection</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nf">(x) -&gt;</span> <span class="nx">x</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="p">(</span><span class="nx">k</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">@collection</span><span class="p">)</span>
      <span class="nv">array = </span><span class="nx">array</span><span class="p">.</span><span class="nx">toArray</span><span class="p">()</span> <span class="k">if</span> <span class="nx">array</span><span class="p">.</span><span class="nx">toArray</span><span class="o">?</span>
      <span class="vi">@node.className = </span><span class="nx">array</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39; &#39;</span>

  <span class="nv">handleArrayChanged: </span><span class="o">=&gt;</span> <span class="nx">@updateFromCollection</span><span class="p">()</span>
  <span class="nv">handleItemsWereRemoved: </span><span class="o">=&gt;</span> <span class="nx">@updateFromCollection</span><span class="p">()</span>
  <span class="nv">handleItemsWereAdded: </span><span class="o">=&gt;</span> <span class="nx">@updateFromCollection</span><span class="p">()</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AddClassBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractAttributeBinding</span>
  <span class="nv">constructor: </span><span class="nf">(node, className, keyPath, renderContext, renderer, only, @invert = false) -&gt;</span>
    <span class="vi">@className = </span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\|/g</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">super</span>
    <span class="k">delete</span> <span class="nx">@attributeName</span>

  <span class="nv">dataChange: </span><span class="nf">(value) -&gt;</span>
    <span class="nv">currentName = </span><span class="nx">@node</span><span class="p">.</span><span class="nx">className</span>
    <span class="nv">includesClassName = </span><span class="nx">currentName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">@className</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="o">!!</span><span class="nx">value</span> <span class="o">is</span> <span class="o">!</span><span class="nx">@invert</span>
      <span class="vi">@node.className = </span><span class="s2">&quot;#{currentName} #{@className}&quot;</span> <span class="k">if</span> <span class="o">!</span><span class="nx">includesClassName</span>
    <span class="k">else</span>
      <span class="vi">@node.className = </span><span class="nx">currentName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">@className</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">includesClassName</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">EventBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractAttributeBinding</span>
  <span class="nv">bindImmediately: </span><span class="kc">false</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span>
    <span class="nv">confirmText = </span><span class="nx">@node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-confirm&#39;</span><span class="p">)</span>
    <span class="nv">callback = </span><span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">confirmText</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">confirm</span><span class="p">(</span><span class="nx">confirmText</span><span class="p">)</span>
      <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;filteredValue&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;callbackContext&#39;</span><span class="p">),</span> <span class="nx">arguments</span>

    <span class="k">if</span> <span class="nv">attacher = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">@attributeName</span><span class="p">]</span>
      <span class="nx">attacher</span> <span class="nx">@node</span><span class="p">,</span> <span class="nx">callback</span>
    <span class="k">else</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">other</span> <span class="nx">@node</span><span class="p">,</span> <span class="nx">@attributeName</span><span class="p">,</span> <span class="nx">callback</span>

  <span class="nx">@accessor</span> <span class="s1">&#39;callbackContext&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nv">contextKeySegments = </span><span class="nx">@key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="nx">contextKeySegments</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="nv">context = </span><span class="k">if</span> <span class="nx">contextKeySegments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;keyContext&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">contextKeySegments</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
    <span class="k">else</span>
      <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;keyContext&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">RadioBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractBinding</span>
  <span class="nv">dataChange: </span><span class="nf">(value) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-195">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-195">&#182;</a>               </div>               <p>don't overwrite <code>checked</code> attributes in the HTML unless a bound
value is defined in the context. if no bound value is found, bind
to the key if the node is checked.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">boundValue = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;filteredValue&#39;</span><span class="p">))</span><span class="o">?</span>
      <span class="vi">@node.checked = </span><span class="nx">boundValue</span> <span class="o">==</span> <span class="nx">@node</span><span class="p">.</span><span class="nx">value</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@node</span><span class="p">.</span><span class="nx">checked</span>
      <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;keyContext&#39;</span><span class="p">).</span><span class="nx">set</span> <span class="nx">@key</span><span class="p">,</span> <span class="nx">@node</span><span class="p">.</span><span class="nx">value</span>

  <span class="nv">nodeChange: </span><span class="nf">(node) -&gt;</span>
    <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;keyContext&#39;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="nx">@key</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">.</span><span class="nx">_parseAttribute</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">value</span><span class="p">))</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">FileBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractBinding</span>
  <span class="nv">nodeChange: </span><span class="nf">(node, subContext) -&gt;</span>
    <span class="nv">segments = </span><span class="nx">@key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="nv">keyContext = </span><span class="nx">subContext</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">segments</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
    <span class="k">else</span>
      <span class="nv">keyContext = </span><span class="nx">subContext</span>

    <span class="k">if</span> <span class="nx">keyContext</span> <span class="k">instanceof</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">RenderContext</span><span class="p">.</span><span class="nx">ContextProxy</span>
      <span class="nv">actualObject = </span><span class="nx">keyContext</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;proxiedObject&#39;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">actualObject = </span><span class="nx">keyContext</span>

    <span class="k">if</span> <span class="nx">actualObject</span><span class="p">.</span><span class="nx">hasStorage</span> <span class="o">&amp;&amp;</span> <span class="nx">actualObject</span><span class="p">.</span><span class="nx">hasStorage</span><span class="p">()</span>
      <span class="k">for</span> <span class="nx">adapter</span> <span class="k">in</span> <span class="nx">actualObject</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;storage&#39;</span><span class="p">)</span> <span class="k">when</span> <span class="nx">adapter</span> <span class="k">instanceof</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">RestStorage</span>
        <span class="nv">adapter.defaultOptions.formData = </span><span class="kc">true</span>

    <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="s1">&#39;multiple&#39;</span><span class="p">)</span>
      <span class="nx">subContext</span><span class="p">.</span><span class="nx">set</span> <span class="nx">@key</span><span class="p">,</span> <span class="nb">Array</span><span class="o">::</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">files</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">subContext</span><span class="p">.</span><span class="nx">set</span> <span class="nx">@key</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">MixinBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractBinding</span>
  <span class="nv">dataChange: </span><span class="nf">(value) -&gt;</span> <span class="nx">$mixin</span> <span class="nx">@node</span><span class="p">,</span> <span class="nx">value</span> <span class="k">if</span> <span class="nx">value</span><span class="o">?</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">SelectBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractBinding</span>
  <span class="nv">bindImmediately: </span><span class="kc">false</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span></pre></div>             </td>           </tr>                               <tr id="section-196">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-196">&#182;</a>               </div>               <p>wait for the select to render before binding to it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@renderer</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;rendered&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">@node</span><span class="o">?</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span> <span class="nx">@node</span><span class="p">,</span> <span class="s1">&#39;updateBinding&#39;</span><span class="p">,</span> <span class="nx">@updateSelectBinding</span>
        <span class="nx">@bind</span><span class="p">()</span>

  <span class="nv">dataChange: </span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-197">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-197">&#182;</a>               </div>               <p>For multi-select boxes, the <code>value</code> property only holds the first
selection, so go through the child options and update as necessary.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">newValue</span> <span class="k">instanceof</span> <span class="nb">Array</span></pre></div>             </td>           </tr>                               <tr id="section-198">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-198">&#182;</a>               </div>               <p>Use a hash to map values to their nodes to avoid O(n^2).</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">valueToChild = </span><span class="p">{}</span>
      <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">@node</span><span class="p">.</span><span class="nx">children</span></pre></div>             </td>           </tr>                               <tr id="section-199">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-199">&#182;</a>               </div>               <p>Clear all options.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">child.selected = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-200">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-200">&#182;</a>               </div>               <p>Avoid collisions among options with same values.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">matches = </span><span class="nx">valueToChild</span><span class="p">[</span><span class="nx">child</span><span class="p">.</span><span class="nx">value</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">matches</span> <span class="k">then</span> <span class="nx">matches</span><span class="p">.</span><span class="nx">push</span> <span class="nx">child</span> <span class="k">else</span> <span class="nv">matches = </span><span class="p">[</span><span class="nx">child</span><span class="p">]</span>
        <span class="nx">valueToChild</span><span class="p">[</span><span class="nx">child</span><span class="p">.</span><span class="nx">value</span><span class="p">]</span> <span class="o">=</span> <span class="nx">matches</span></pre></div>             </td>           </tr>                               <tr id="section-201">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-201">&#182;</a>               </div>               <p>Select options corresponding to the new values</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">value</span> <span class="k">in</span> <span class="nx">newValue</span>
        <span class="k">for</span> <span class="nx">match</span> <span class="k">in</span> <span class="nx">valueToChild</span><span class="p">[</span><span class="nx">value</span><span class="p">]</span>
          <span class="nv">match.selected = </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-202">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-202">&#182;</a>               </div>               <p>For a regular select box, update the value.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">valueForNode</span><span class="p">(</span><span class="nx">@node</span><span class="p">,</span> <span class="nx">newValue</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-203">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-203">&#182;</a>               </div>               <p>Finally, update the options' <code>selected</code> bindings</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@updateOptionBindings</span><span class="p">()</span>

  <span class="nv">nodeChange: </span><span class="o">=&gt;</span>
    <span class="nx">@updateSelectBinding</span><span class="p">()</span>
    <span class="nx">@updateOptionBindings</span><span class="p">()</span>

  <span class="nv">updateSelectBinding: </span><span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-204">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-204">&#182;</a>               </div>               <p>Gather the selected options and update the binding</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">selections = </span><span class="k">if</span> <span class="nx">@node</span><span class="p">.</span><span class="nx">multiple</span> <span class="k">then</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">value</span> <span class="k">for</span> <span class="nx">c</span> <span class="k">in</span> <span class="nx">@node</span><span class="p">.</span><span class="nx">children</span> <span class="k">when</span> <span class="nx">c</span><span class="p">.</span><span class="nx">selected</span><span class="p">)</span> <span class="k">else</span> <span class="nx">@node</span><span class="p">.</span><span class="nx">value</span>
    <span class="nv">selections = </span><span class="nx">selections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">selections</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;keyContext&#39;</span><span class="p">).</span><span class="nx">set</span> <span class="nx">@key</span><span class="p">,</span> <span class="nx">selections</span>
    <span class="kc">true</span>

  <span class="nv">updateOptionBindings: </span><span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-205">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-205">&#182;</a>               </div>               <p>Go through the option nodes and update their bindings using the
context and key attached to the node via Batman.data</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">@node</span><span class="p">.</span><span class="nx">children</span>
      <span class="k">if</span> <span class="nv">selectedBinding = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">_data</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="s1">&#39;selected&#39;</span><span class="p">)</span>
        <span class="nx">selectedBinding</span><span class="p">.</span><span class="nx">nodeChange</span><span class="p">(</span><span class="nx">selectedBinding</span><span class="p">.</span><span class="nx">node</span><span class="p">)</span>
    <span class="kc">true</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">StyleBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractCollectionBinding</span>

  <span class="k">class</span> <span class="nx">@SingleStyleBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractAttributeBinding</span>
    <span class="nv">constructor: </span><span class="nf">(args..., @parent) -&gt;</span>
      <span class="k">super</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span>
    <span class="nv">dataChange: </span><span class="nf">(value) -&gt;</span> <span class="nx">@parent</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">(</span><span class="nx">@attributeName</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>

  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@oldStyles = </span><span class="p">{}</span>
    <span class="k">super</span>

  <span class="nv">dataChange: </span><span class="nf">(value) -&gt;</span>
    <span class="nx">unless</span> <span class="nx">value</span>
      <span class="nx">@reapplyOldStyles</span><span class="p">()</span>
      <span class="k">return</span>

    <span class="nx">@unbindCollection</span><span class="p">()</span>

    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
      <span class="nx">@reapplyOldStyles</span><span class="p">()</span>
      <span class="k">for</span> <span class="nx">style</span> <span class="k">in</span> <span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-206">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-206">&#182;</a>               </div>               <p>handle a case when css value contains colons itself (absolute URI)
split and rejoin because IE7/8 don't splice values of capturing regexes into split's return array</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">[</span><span class="nx">cssName</span><span class="p">,</span> <span class="nx">colonSplitCSSValues</span><span class="p">...]</span> <span class="o">=</span> <span class="nx">style</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="nx">@setStyle</span> <span class="nx">cssName</span><span class="p">,</span> <span class="nx">colonSplitCSSValues</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Hash</span>
      <span class="k">if</span> <span class="nx">@bindCollection</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
        <span class="nx">value</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@setStyle</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Object</span>
      <span class="nx">@reapplyOldStyles</span><span class="p">()</span>
      <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">keyValue</span> <span class="k">of</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-207">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-207">&#182;</a>               </div>               <p>Check whether the value is an existing keypath, and if so bind this attribute to it</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">[</span><span class="nx">keypathValue</span><span class="p">,</span> <span class="nx">keypathContext</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@renderContext</span><span class="p">.</span><span class="nx">findKey</span><span class="p">(</span><span class="nx">keyValue</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">keypathValue</span>
          <span class="nx">@bindSingleAttribute</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">keyValue</span>
          <span class="nx">@setStyle</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">keypathValue</span>
        <span class="k">else</span>
          <span class="nx">@setStyle</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">keyValue</span>

  <span class="nv">handleItemsWereAdded: </span><span class="p">(</span><span class="nx">newKey</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@setStyle</span> <span class="nx">newKey</span><span class="p">,</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">newKey</span><span class="p">);</span> <span class="k">return</span>
  <span class="nv">handleItemsWereRemoved: </span><span class="p">(</span><span class="nx">oldKey</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@setStyle</span> <span class="nx">oldKey</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="k">return</span>

  <span class="nv">bindSingleAttribute: </span><span class="nf">(attr, keyPath) -&gt;</span> <span class="k">new</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">SingleStyleBinding</span><span class="p">(</span><span class="nx">@node</span><span class="p">,</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">keyPath</span><span class="p">,</span> <span class="nx">@renderContext</span><span class="p">,</span> <span class="nx">@renderer</span><span class="p">,</span> <span class="nx">@only</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span>

  <span class="nv">setStyle: </span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">key</span>
    <span class="nv">key = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">camelize</span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">trim</span><span class="p">(),</span> <span class="kc">true</span><span class="p">)</span>
    <span class="nx">@oldStyles</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@node</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="nx">@node</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">value</span> <span class="k">then</span> <span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

  <span class="nv">reapplyOldStyles: </span><span class="o">-&gt;</span>
    <span class="nx">@setStyle</span><span class="p">(</span><span class="nx">cssName</span><span class="p">,</span> <span class="nx">cssValue</span><span class="p">)</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">cssName</span><span class="p">,</span> <span class="nx">cssValue</span> <span class="k">of</span> <span class="nx">@oldStyles</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">IteratorBinding</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">AbstractCollectionBinding</span>
  <span class="nv">deferEvery: </span><span class="mi">50</span>
  <span class="nv">currentActionNumber: </span><span class="mi">0</span>
  <span class="nv">queuedActionNumber: </span><span class="mi">0</span>
  <span class="nv">bindImmediately: </span><span class="kc">false</span>

  <span class="nv">constructor: </span><span class="nf">(sourceNode, @iteratorName, @key, @context, @parentRenderer) -&gt;</span>
    <span class="vi">@nodeMap = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="vi">@actionMap = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="vi">@rendererMap = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="vi">@actions = </span><span class="p">[]</span>

    <span class="vi">@prototypeNode = </span><span class="nx">sourceNode</span><span class="p">.</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="nx">@prototypeNode</span><span class="p">.</span><span class="nx">removeAttribute</span> <span class="s2">&quot;data-foreach-#{@iteratorName}&quot;</span>

    <span class="vi">@parentNode = </span><span class="nx">sourceNode</span><span class="p">.</span><span class="nx">parentNode</span>
    <span class="nv">previousSiblingNode = </span><span class="nx">sourceNode</span><span class="p">.</span><span class="nx">nextSibling</span>
    <span class="vi">@siblingNode = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createComment</span> <span class="s2">&quot;end #{@iteratorName}&quot;</span>
    <span class="nx">@siblingNode</span><span class="p">[</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">expando</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sourceNode</span><span class="p">[</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">expando</span><span class="p">]</span>
    <span class="k">delete</span> <span class="nx">sourceNode</span><span class="p">[</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">expando</span><span class="p">]</span> <span class="k">if</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">canDeleteExpando</span>
    <span class="nx">$insertBefore</span> <span class="nx">@parentNode</span><span class="p">,</span> <span class="nx">@siblingNode</span><span class="p">,</span> <span class="nx">previousSiblingNode</span></pre></div>             </td>           </tr>                               <tr id="section-208">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-208">&#182;</a>               </div>               <p>Remove the original node once the parent has moved past it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@parentRenderer</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;parsed&#39;</span><span class="p">,</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-209">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-209">&#182;</a>               </div>               <p>Move any Batman._data from the sourceNode to the sibling; we need to
retain the bindings, and we want to dispose of the node.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">$removeNode</span> <span class="nx">sourceNode</span></pre></div>             </td>           </tr>                               <tr id="section-210">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-210">&#182;</a>               </div>               <p>Attach observers.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@bind</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-211">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-211">&#182;</a>               </div>               <p>Don't let the parent emit its rendered event until all the children have.
This <code>prevent</code>'s matching allow is run once the queue is empty in <code>processActionQueue</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@parentRenderer</span><span class="p">.</span><span class="nx">prevent</span> <span class="s1">&#39;rendered&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-212">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-212">&#182;</a>               </div>               <p>Tie this binding to a node using the default behaviour in the AbstractBinding</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">super</span><span class="p">(</span><span class="nx">@siblingNode</span><span class="p">,</span> <span class="nx">@iteratorName</span><span class="p">,</span> <span class="nx">@key</span><span class="p">,</span> <span class="nx">@context</span><span class="p">,</span> <span class="nx">@parentRenderer</span><span class="p">)</span>

    <span class="vi">@fragment = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">()</span>

  <span class="nv">destroy: </span><span class="o">-&gt;</span>
    <span class="k">super</span>
    <span class="vi">@destroyed = </span><span class="kc">true</span>

  <span class="nv">unbindCollection: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@collection</span>
      <span class="nx">@nodeMap</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@cancelExistingItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
      <span class="k">super</span>

  <span class="nv">dataChange: </span><span class="nf">(newCollection) -&gt;</span>
    <span class="k">if</span> <span class="nx">@collection</span> <span class="o">!=</span> <span class="nx">newCollection</span>
      <span class="nx">@removeAll</span><span class="p">()</span>

    <span class="nx">@bindCollection</span><span class="p">(</span><span class="nx">newCollection</span><span class="p">)</span> <span class="c1"># Unbinds the old collection as well.</span>
    <span class="k">if</span> <span class="nx">@collection</span>
      <span class="k">if</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">toArray</span>
        <span class="nx">@handleArrayChanged</span><span class="p">()</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">forEach</span>
        <span class="nx">@collection</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@addOrInsertItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">@addOrInsertItem</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@collection</span>

    <span class="k">else</span>
      <span class="nx">developer</span><span class="p">.</span><span class="nx">warn</span> <span class="s2">&quot;Warning! data-foreach-#{@iteratorName} called with an undefined binding. Key was: #{@key}.&quot;</span>
    <span class="nx">@processActionQueue</span><span class="p">()</span>

  <span class="nv">handleItemsWereAdded: </span><span class="p">(</span><span class="nx">items</span><span class="p">...)</span> <span class="o">=&gt;</span> <span class="nx">@addOrInsertItem</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="p">{</span><span class="nv">fragment: </span><span class="kc">false</span><span class="p">})</span> <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span><span class="p">;</span> <span class="k">return</span>
  <span class="nv">handleItemsWereRemoved: </span><span class="p">(</span><span class="nx">items</span><span class="p">...)</span> <span class="o">=&gt;</span> <span class="nx">@removeItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span><span class="p">;</span> <span class="k">return</span>

  <span class="nv">handleArrayChanged: </span><span class="o">=&gt;</span>
    <span class="nv">newItemsInOrder = </span><span class="nx">@collection</span><span class="p">.</span><span class="nx">toArray</span><span class="p">()</span>
    <span class="nv">nodesToRemove = </span><span class="p">(</span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="p">).</span><span class="nx">merge</span><span class="p">(</span><span class="nx">@nodeMap</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">newItemsInOrder</span>
      <span class="nx">@addOrInsertItem</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="p">{</span><span class="nv">fragment: </span><span class="kc">false</span><span class="p">})</span>
      <span class="nx">nodesToRemove</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>

    <span class="nx">nodesToRemove</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@removeItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>

  <span class="nv">addOrInsertItem: </span><span class="nf">(item, options = {}) -&gt;</span>
    <span class="nv">existingNode = </span><span class="nx">@nodeMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">existingNode</span>
      <span class="nx">@insertItem</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">existingNode</span><span class="p">,</span> <span class="nx">$mixin</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span><span class="nv">actionNumber: </span><span class="nx">@queuedActionNumber</span><span class="o">++</span><span class="p">}))</span>
    <span class="k">else</span>
      <span class="nx">@addItem</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>

  <span class="nv">addItem: </span><span class="nf">(item, options = {fragment: true}) -&gt;</span>
    <span class="nx">@parentRenderer</span><span class="p">.</span><span class="nx">prevent</span> <span class="s1">&#39;rendered&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-213">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-213">&#182;</a>               </div>               <p>Remove any renderers in progress or actions lined up for an item, since we now know
this item belongs at the end of the queue.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@cancelExistingItemActions</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@actionMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span><span class="o">?</span>

    <span class="nv">self = </span><span class="err">@</span>
    <span class="nv">options.actionNumber = </span><span class="nx">@queuedActionNumber</span><span class="o">++</span></pre></div>             </td>           </tr>                               <tr id="section-214">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-214">&#182;</a>               </div>               <p>Render out the child in the custom context, and insert it once the render has completed the parse.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">childRenderer = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Renderer</span> <span class="nx">@_nodeForItem</span><span class="p">(</span><span class="nx">item</span><span class="p">),</span> <span class="p">(</span><span class="o">-&gt;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">rendererMap</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">insertItem</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">@node</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="p">),</span> <span class="nx">@renderContext</span><span class="p">.</span><span class="nx">descend</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">@iteratorName</span><span class="p">)</span>

    <span class="nx">@rendererMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">childRenderer</span><span class="p">)</span>

    <span class="nv">finish = </span><span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@destroyed</span>
      <span class="nx">@parentRenderer</span><span class="p">.</span><span class="nx">allowAndFire</span> <span class="s1">&#39;rendered&#39;</span>

    <span class="nx">childRenderer</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;rendered&#39;</span><span class="p">,</span> <span class="nx">finish</span>
    <span class="nx">childRenderer</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;stopped&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@destroyed</span>
      <span class="nx">@actions</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">actionNumber</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span>
      <span class="nx">finish</span><span class="p">()</span>
      <span class="nx">@processActionQueue</span><span class="p">()</span>
    <span class="nx">item</span>

  <span class="nv">removeItem: </span><span class="nf">(item) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@destroyed</span> <span class="o">||</span> <span class="o">!</span><span class="nx">item</span><span class="o">?</span>
    <span class="nv">oldNode = </span><span class="nx">@nodeMap</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
    <span class="nx">@cancelExistingItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">oldNode</span>
      <span class="k">if</span> <span class="nv">hideFunction = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">data</span> <span class="nx">oldNode</span><span class="p">,</span> <span class="s1">&#39;hide&#39;</span>
        <span class="nx">hideFunction</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">oldNode</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">$removeNode</span><span class="p">(</span><span class="nx">oldNode</span><span class="p">)</span>

  <span class="nv">removeAll: </span><span class="o">-&gt;</span> <span class="nx">@nodeMap</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@removeItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>

  <span class="nv">insertItem: </span><span class="nf">(item, node, options = {}) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@destroyed</span>
    <span class="nv">existingActionNumber = </span><span class="nx">@actionMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">existingActionNumber</span> <span class="o">&gt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">actionNumber</span></pre></div>             </td>           </tr>                               <tr id="section-215">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-215">&#182;</a>               </div>               <p>Another action for this item is scheduled for the future, do it then instead of now. Actions
added later enforce order, so we make this one a noop and let the later one have its proper effects.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@actions</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">actionNumber</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-216">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-216">&#182;</a>               </div>               <p>Another action has been scheduled for this item. It hasn't been done yet because
its in the actionmap, but this insert is scheduled to happen after it. Skip it since its now defunct.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">existingActionNumber</span>
        <span class="nx">@cancelExistingItemActions</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-217">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-217">&#182;</a>               </div>               <p>Update the action number map to now reflect this new action which will go on the end of the queue.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@actionMap</span><span class="p">.</span><span class="nx">set</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">actionNumber</span>
      <span class="nx">@actions</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">actionNumber</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span>
        <span class="nv">show = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">data</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span>
        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">show</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
          <span class="nx">show</span><span class="p">.</span><span class="nx">call</span> <span class="nx">node</span><span class="p">,</span> <span class="nv">before: </span><span class="nx">@siblingNode</span>
        <span class="k">else</span>
          <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">fragment</span>
            <span class="nx">@fragment</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">node</span>
          <span class="k">else</span>
            <span class="nx">$insertBefore</span> <span class="nx">@parentNode</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">@siblingNode</span>

      <span class="nx">@actions</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">actionNumber</span><span class="p">].</span><span class="nv">item = </span><span class="nx">item</span>
    <span class="nx">@processActionQueue</span><span class="p">()</span>

  <span class="nv">cancelExistingItem: </span><span class="nf">(item) -&gt;</span>
    <span class="nx">@cancelExistingItemActions</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
    <span class="nx">@cancelExistingItemRender</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>

  <span class="nv">cancelExistingItemActions: </span><span class="nf">(item) -&gt;</span>
    <span class="nv">oldActionNumber = </span><span class="nx">@actionMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-218">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-218">&#182;</a>               </div>               <p>Only remove actions which haven't been completed yet.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">oldActionNumber</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="nx">oldActionNumber</span> <span class="o">&gt;=</span> <span class="nx">@currentActionNumber</span>
      <span class="nx">@actionMap</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
      <span class="nx">@actions</span><span class="p">[</span><span class="nx">oldActionNumber</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span>

    <span class="nx">@actionMap</span><span class="p">.</span><span class="nx">unset</span> <span class="nx">item</span>

  <span class="nv">cancelExistingItemRender: </span><span class="nf">(item) -&gt;</span>
    <span class="nv">oldRenderer = </span><span class="nx">@rendererMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">oldRenderer</span>
      <span class="nx">oldRenderer</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
      <span class="nx">$removeNode</span><span class="p">(</span><span class="nx">oldRenderer</span><span class="p">.</span><span class="nx">node</span><span class="p">)</span>

    <span class="nx">@rendererMap</span><span class="p">.</span><span class="nx">unset</span> <span class="nx">item</span>

  <span class="nv">processActionQueue: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@destroyed</span>
    <span class="nx">unless</span> <span class="nx">@actionQueueTimeout</span></pre></div>             </td>           </tr>                               <tr id="section-219">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-219">&#182;</a>               </div>               <p>Prevent the parent which will then be allowed when the timeout actually runs</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@actionQueueTimeout = </span><span class="nx">$setImmediate</span> <span class="o">=&gt;</span>
        <span class="k">return</span> <span class="k">if</span> <span class="nx">@destroyed</span>
        <span class="k">delete</span> <span class="nx">@actionQueueTimeout</span>
        <span class="nv">startTime = </span><span class="k">new</span> <span class="nb">Date</span>

        <span class="k">while</span> <span class="p">(</span><span class="nv">f = </span><span class="nx">@actions</span><span class="p">[</span><span class="nx">@currentActionNumber</span><span class="p">])</span><span class="o">?</span>
          <span class="k">delete</span> <span class="nx">@actions</span><span class="p">[</span><span class="nx">@currentActionNumber</span><span class="p">]</span>
          <span class="nx">@actionMap</span><span class="p">.</span><span class="nx">unset</span> <span class="nx">f</span><span class="p">.</span><span class="nx">item</span>
          <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">)</span> <span class="k">if</span> <span class="nx">f</span>
          <span class="nx">@currentActionNumber</span><span class="o">++</span>

          <span class="k">if</span> <span class="nx">@deferEvery</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span> <span class="o">-</span> <span class="nx">startTime</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">@deferEvery</span>
            <span class="k">return</span> <span class="nx">@processActionQueue</span><span class="p">()</span>

        <span class="k">if</span> <span class="nx">@fragment</span> <span class="o">&amp;&amp;</span> <span class="nx">@rendererMap</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">@fragment</span><span class="p">.</span><span class="nx">hasChildNodes</span><span class="p">()</span>
          <span class="nx">$insertBefore</span> <span class="nx">@parentNode</span><span class="p">,</span> <span class="nx">@fragment</span><span class="p">,</span> <span class="nx">@siblingNode</span>
          <span class="vi">@fragment = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">()</span>

        <span class="k">if</span> <span class="nx">@currentActionNumber</span> <span class="o">==</span> <span class="nx">@queuedActionNumber</span>
          <span class="nx">@parentRenderer</span><span class="p">.</span><span class="nx">allowAndFire</span> <span class="s1">&#39;rendered&#39;</span>

  <span class="nv">_nodeForItem: </span><span class="nf">(item) -&gt;</span>
    <span class="nv">newNode = </span><span class="nx">@prototypeNode</span><span class="p">.</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="nx">@nodeMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">newNode</span><span class="p">)</span>
    <span class="nx">newNode</span></pre></div>             </td>           </tr>                               <tr id="section-220">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-220">&#182;</a>               </div>               <h2>Filters</h2>

<p><code>Batman.Filters</code> contains the simple, determininistic tranforms used in view bindings to
make life a little easier.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">buntUndefined = </span><span class="nf">(f) -&gt;</span>
  <span class="nf">(value) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
      <span class="kc">undefined</span>
    <span class="k">else</span>
      <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>

<span class="nv">filters = Batman.Filters =</span>
  <span class="nv">get: </span><span class="nx">buntUndefined</span> <span class="nf">(value, key) -&gt;</span>
    <span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">get</span><span class="o">?</span>
      <span class="nx">value</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">value</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>

  <span class="nv">equals: </span><span class="nx">buntUndefined</span> <span class="nf">(lhs, rhs) -&gt;</span>
    <span class="nx">lhs</span> <span class="o">is</span> <span class="nx">rhs</span>

  <span class="o">not:</span> <span class="nf">(value) -&gt;</span>
    <span class="o">!</span> <span class="o">!!</span><span class="nx">value</span>

  <span class="nv">truncate: </span><span class="nx">buntUndefined</span> <span class="nf">(value, length, end = &quot;...&quot;) -&gt;</span>
    <span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">length</span>
      <span class="nv">value = </span><span class="nx">value</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">length</span><span class="o">-</span><span class="nx">end</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">+</span> <span class="nx">end</span>
    <span class="nx">value</span>

  <span class="nv">default: </span><span class="nf">(value, string) -&gt;</span>
    <span class="nx">value</span> <span class="o">||</span> <span class="nx">string</span>

  <span class="nv">prepend: </span><span class="nf">(value, string) -&gt;</span>
    <span class="nx">string</span> <span class="o">+</span> <span class="nx">value</span>

  <span class="nv">append: </span><span class="nf">(value, string) -&gt;</span>
    <span class="nx">value</span> <span class="o">+</span> <span class="nx">string</span>

  <span class="nv">downcase: </span><span class="nx">buntUndefined</span> <span class="nf">(value) -&gt;</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>

  <span class="nv">upcase: </span><span class="nx">buntUndefined</span> <span class="nf">(value) -&gt;</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>

  <span class="nv">pluralize: </span><span class="nx">buntUndefined</span> <span class="nf">(string, count) -&gt;</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">string</span><span class="p">)</span>

  <span class="nv">join: </span><span class="nx">buntUndefined</span> <span class="nf">(value, byWhat = &#39;&#39;) -&gt;</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">byWhat</span><span class="p">)</span>

  <span class="nv">sort: </span><span class="nx">buntUndefined</span> <span class="nf">(value) -&gt;</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">sort</span><span class="p">()</span>

  <span class="nv">map: </span><span class="nx">buntUndefined</span> <span class="nf">(value, key) -&gt;</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nf">(x) -&gt;</span> <span class="nx">x</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>

  <span class="nv">first: </span><span class="nx">buntUndefined</span> <span class="nf">(value) -&gt;</span>
    <span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="nv">meta: </span><span class="nx">buntUndefined</span> <span class="nf">(value, keypath) -&gt;</span>
    <span class="nx">developer</span><span class="p">.</span><span class="nx">assert</span> <span class="nx">value</span><span class="p">.</span><span class="nx">meta</span><span class="p">,</span> <span class="s2">&quot;Error, value doesn&#39;t have a meta to filter on!&quot;</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">keypath</span><span class="p">)</span>

  <span class="nv">interpolate: </span><span class="nf">(string, interpolationKeypaths) -&gt;</span>
    <span class="k">return</span> <span class="kc">undefined</span> <span class="nx">unless</span> <span class="nx">string</span><span class="o">?</span>
    <span class="nv">values = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">interpolationKeypaths</span>
      <span class="nx">values</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@findKey</span><span class="p">(</span><span class="nx">v</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="o">!</span><span class="nx">values</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span><span class="o">?</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">developer</span><span class="p">.</span><span class="nx">warn</span> <span class="s2">&quot;Warning! Undefined interpolation key #{k} for interpolation&quot;</span><span class="p">,</span> <span class="nx">string</span>
        <span class="nx">values</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="nx">Batman</span><span class="p">.</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="nx">string</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span>

<span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;capitalize&#39;</span><span class="p">,</span> <span class="s1">&#39;singularize&#39;</span><span class="p">,</span> <span class="s1">&#39;underscore&#39;</span><span class="p">,</span> <span class="s1">&#39;camelize&#39;</span><span class="p">]</span>
  <span class="nx">filters</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">buntUndefined</span> <span class="nx">helpers</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>

<span class="nx">developer</span><span class="p">.</span><span class="nx">addFilters</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-221">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-221">&#182;</a>               </div>               <h2>Data</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$mixin</span> <span class="nx">Batman</span><span class="p">,</span>
  <span class="nv">cache: </span><span class="p">{}</span>
  <span class="nv">uuid: </span><span class="mi">0</span>
  <span class="nv">expando: </span><span class="s2">&quot;batman&quot;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">().</span><span class="nx">toString</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\D/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-222">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-222">&#182;</a>               </div>               <p>Test to see if it's possible to delete an expando from an element
Fails in Internet Explorer</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">canDeleteExpando: </span><span class="k">try</span>
      <span class="nv">div = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s1">&#39;div&#39;</span>
      <span class="k">delete</span> <span class="nx">div</span><span class="p">.</span><span class="nx">test</span>
    <span class="k">catch</span> <span class="nx">e</span>
      <span class="nv">Batman.canDeleteExpando = </span><span class="kc">false</span>
  <span class="nv">noData: </span><span class="c1"># these throw exceptions if you attempt to add expandos to them</span>
    <span class="s2">&quot;embed&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-223">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-223">&#182;</a>               </div>               <p>Ban all objects except for Flash (which handle expandos)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;object&quot;</span><span class="o">:</span> <span class="s2">&quot;clsid:D27CDB6E-AE6D-11cf-96B8-444553540000&quot;</span><span class="p">,</span>
    <span class="s2">&quot;applet&quot;</span><span class="o">:</span> <span class="kc">true</span>

  <span class="nv">hasData: </span><span class="nf">(elem) -&gt;</span>
    <span class="nv">elem = </span><span class="p">(</span><span class="k">if</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeType</span> <span class="k">then</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">elem</span><span class="p">[</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">expando</span><span class="p">]]</span> <span class="k">else</span> <span class="nx">elem</span><span class="p">[</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">expando</span><span class="p">])</span>
    <span class="o">!!</span><span class="nx">elem</span> <span class="o">and</span> <span class="o">!</span><span class="nx">isEmptyDataObject</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>

  <span class="nv">data: </span><span class="nf">(elem, name, data, pvt) -&gt;</span> <span class="c1"># pvt is for internal use only</span>
    <span class="k">return</span>  <span class="nx">unless</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">acceptData</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
    <span class="nv">internalKey = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">expando</span>
    <span class="nv">getByName = </span><span class="k">typeof</span> <span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span>
    <span class="nv">cache = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">cache</span></pre></div>             </td>           </tr>                               <tr id="section-224">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-224">&#182;</a>               </div>               <p>Only defining an ID for JS objects if its cache already exists allows
the code to shortcut on the same path as a DOM node with no cache</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">id = </span><span class="nx">elem</span><span class="p">[</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">expando</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-225">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-225">&#182;</a>               </div>               <p>Avoid doing any more work than we need to when trying to get data on an
object that has no data at all</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">not</span> <span class="nx">id</span> <span class="o">or</span> <span class="p">(</span><span class="nx">pvt</span> <span class="o">and</span> <span class="nx">id</span> <span class="o">and</span> <span class="p">(</span><span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">][</span><span class="nx">internalKey</span><span class="p">])))</span> <span class="o">and</span> <span class="nx">getByName</span> <span class="o">and</span> <span class="nx">data</span> <span class="o">==</span> <span class="kc">undefined</span>
      <span class="k">return</span>

    <span class="nx">unless</span> <span class="nx">id</span></pre></div>             </td>           </tr>                               <tr id="section-226">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-226">&#182;</a>               </div>               <p>Also check that it's not a text node; IE can't set expandos on them</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">isnt</span> <span class="mi">3</span>
        <span class="nx">elem</span><span class="p">[</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">expando</span><span class="p">]</span> <span class="o">=</span> <span class="nv">id = </span><span class="o">++</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">uuid</span>
      <span class="k">else</span>
        <span class="nv">id = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">expando</span>

    <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="nx">unless</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-227">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-227">&#182;</a>               </div>               <p>An object can be passed to Batman._data instead of a key/value pair; this gets
shallow copied over onto the existing cache</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="o">or</span> <span class="k">typeof</span> <span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span>
      <span class="k">if</span> <span class="nx">pvt</span>
        <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">][</span><span class="nx">internalKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$mixin</span><span class="p">(</span><span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">][</span><span class="nx">internalKey</span><span class="p">],</span> <span class="nx">name</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$mixin</span><span class="p">(</span><span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">],</span> <span class="nx">name</span><span class="p">)</span>

    <span class="nv">thisCache = </span><span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-228">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-228">&#182;</a>               </div>               <p>Internal Batman data is stored in a separate object inside the object's data
cache in order to avoid key collisions between internal data and user-defined
data</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">pvt</span>
      <span class="nx">thisCache</span><span class="p">[</span><span class="nx">internalKey</span><span class="p">]</span> <span class="o">||=</span> <span class="p">{}</span>
      <span class="nv">thisCache = </span><span class="nx">thisCache</span><span class="p">[</span><span class="nx">internalKey</span><span class="p">]</span>

    <span class="k">if</span> <span class="nx">data</span> <span class="o">!=</span> <span class="kc">undefined</span>
      <span class="nx">thisCache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-229">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-229">&#182;</a>               </div>               <p>Check for both converted-to-camel and non-converted data property names
If a data property was specified</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">getByName</span></pre></div>             </td>           </tr>                               <tr id="section-230">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-230">&#182;</a>               </div>               <p>First try to find as-is property data</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">ret = </span><span class="nx">thisCache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="nv">ret = </span><span class="nx">thisCache</span>

    <span class="k">return</span> <span class="nx">ret</span>

  <span class="nv">removeData: </span><span class="nf">(elem, name, pvt) -&gt;</span> <span class="c1"># pvt is for internal use only</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">acceptData</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
    <span class="nv">internalKey = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">expando</span>
    <span class="nv">isNode = </span><span class="nx">elem</span><span class="p">.</span><span class="nx">nodeType</span></pre></div>             </td>           </tr>                               <tr id="section-231">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-231">&#182;</a>               </div>               <p>non DOM-nodes have their data attached directly</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">cache = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">cache</span>
    <span class="nv">id = </span><span class="nx">elem</span><span class="p">[</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">expando</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-232">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-232">&#182;</a>               </div>               <p>If there is already no cache entry for this object, there is no
purpose in continuing</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>

    <span class="k">if</span> <span class="nx">name</span>
      <span class="nv">thisCache = </span><span class="k">if</span> <span class="nx">pvt</span> <span class="k">then</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">][</span><span class="nx">internalKey</span><span class="p">]</span> <span class="k">else</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">thisCache</span></pre></div>             </td>           </tr>                               <tr id="section-233">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-233">&#182;</a>               </div>               <p>Support interoperable removal of hyphenated or camelcased keys</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">delete</span> <span class="nx">thisCache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-234">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-234">&#182;</a>               </div>               <p>If there is no data left in the cache, we want to continue
and let the cache object itself get destroyed</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">unless</span> <span class="nx">isEmptyDataObject</span><span class="p">(</span><span class="nx">thisCache</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">pvt</span>
      <span class="k">delete</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">][</span><span class="nx">internalKey</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-235">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-235">&#182;</a>               </div>               <p>Don't destroy the parent cache unless the internal data object
had been the only thing left in it</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">isEmptyDataObject</span><span class="p">(</span><span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span>

    <span class="nv">internalCache = </span><span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">][</span><span class="nx">internalKey</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-236">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-236">&#182;</a>               </div>               <p>Browsers that fail expando deletion also refuse to delete expandos on
the window, but it will allow it on all other JS objects; other browsers
don't care
Ensure that <code>cache</code> is not a window object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">canDeleteExpando</span> <span class="o">or</span> <span class="o">!</span><span class="nx">cache</span><span class="p">.</span><span class="nx">setInterval</span>
      <span class="k">delete</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-237">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-237">&#182;</a>               </div>               <p>We destroyed the entire user cache at once because it's faster than
iterating through each key, but we need to continue to persist internal
data if it existed</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">internalCache</span>
      <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">][</span><span class="nx">internalKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">internalCache</span></pre></div>             </td>           </tr>                               <tr id="section-238">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-238">&#182;</a>               </div>               <p>Otherwise, we need to eliminate the expando on the node to avoid
false lookups in the cache for entries that no longer exist</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">canDeleteExpando</span>
        <span class="k">delete</span> <span class="nx">elem</span><span class="p">[</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">expando</span><span class="p">]</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">removeAttribute</span>
        <span class="nx">elem</span><span class="p">.</span><span class="nx">removeAttribute</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">expando</span>
      <span class="k">else</span>
        <span class="nx">elem</span><span class="p">[</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">expando</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-239">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-239">&#182;</a>               </div>               <p>For internal use only</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_data: </span><span class="nf">(elem, name, data) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">data</span> <span class="nx">elem</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-240">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-240">&#182;</a>               </div>               <p>A method for determining if a DOM node can handle the data expando</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">acceptData: </span><span class="nf">(elem) -&gt;</span>
    <span class="k">if</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">nodeName</span>
      <span class="nv">match = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">noData</span><span class="p">[</span><span class="nx">elem</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()]</span>
      <span class="k">if</span> <span class="nx">match</span>
        <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="nx">match</span> <span class="o">==</span> <span class="kc">true</span> <span class="o">or</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;classid&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">match</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">true</span>

<span class="nv">isEmptyDataObject = </span><span class="nf">(obj) -&gt;</span>
  <span class="k">for</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">obj</span>
    <span class="k">return</span> <span class="kc">false</span>
  <span class="k">return</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-241">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-241">&#182;</a>               </div>               <h2>Mixins</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">mixins = Batman.mixins = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-242">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-242">&#182;</a>               </div>               <h2>Encoders</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.Encoders = </span><span class="p">{}</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Paginator</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="k">class</span> <span class="nx">@Cache</span>
    <span class="nv">constructor: </span><span class="nf">(@offset, @limit, @items) -&gt;</span>
      <span class="vi">@length = </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span>
      <span class="vi">@reach = </span><span class="nx">offset</span> <span class="o">+</span> <span class="nx">limit</span>
    <span class="nv">containsItemsForOffsetAndLimit: </span><span class="nf">(offset, limit) -&gt;</span>
      <span class="nx">offset</span> <span class="o">&gt;=</span> <span class="nx">@offset</span> <span class="o">and</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">+</span> <span class="nx">limit</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nx">@reach</span>
    <span class="nv">itemsForOffsetAndLimit: </span><span class="nf">(offset, limit) -&gt;</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@containsItemsForOffsetAndLimit</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">limit</span><span class="p">)</span>
      <span class="nv">begin = </span><span class="nx">offset</span><span class="o">-</span><span class="nx">@offset</span>
      <span class="nv">end = </span><span class="nx">begin</span> <span class="o">+</span> <span class="nx">limit</span>
      <span class="nx">@items</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">begin</span><span class="p">,</span> <span class="nx">end</span><span class="p">)</span>

  <span class="nv">offset: </span><span class="mi">0</span>
  <span class="nv">limit: </span><span class="mi">10</span>
  <span class="nv">totalCount: </span><span class="mi">0</span>

  <span class="nv">offsetFromPageAndLimit: </span><span class="nf">(page, limit) -&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">((</span><span class="o">+</span><span class="nx">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">limit</span><span class="p">)</span>
  <span class="nv">pageFromOffsetAndLimit: </span><span class="nf">(offset, limit) -&gt;</span> <span class="nx">offset</span> <span class="err">/ limit + 1</span>

  <span class="nv">toArray: </span><span class="o">-&gt;</span>
    <span class="nv">cache = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;cache&#39;</span><span class="p">)</span>
    <span class="nv">offset = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">)</span>
    <span class="nv">limit = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">)</span>
    <span class="nv">items = </span><span class="nx">cache</span><span class="o">?</span><span class="p">.</span><span class="nx">itemsForOffsetAndLimit</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">limit</span><span class="p">)</span>
    <span class="nx">@loadItemsForOffsetAndLimit</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">limit</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">items</span>
    <span class="nx">items</span> <span class="o">or</span> <span class="p">[]</span>
  <span class="nv">page: </span><span class="o">-&gt;</span>
    <span class="nx">@pageFromOffsetAndLimit</span><span class="p">(</span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">),</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">))</span>
  <span class="nv">pageCount: </span><span class="o">-&gt;</span>
    <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;totalCount&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">))</span>

  <span class="nv">previousPage: </span><span class="o">-&gt;</span> <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="nv">nextPage: </span><span class="o">-&gt;</span> <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

  <span class="nv">loadItemsForOffsetAndLimit: </span><span class="nf">(offset, limit) -&gt;</span> <span class="c1"># override on subclasses or instances</span>
  <span class="nv">updateCache: </span><span class="nf">(offset, limit, items) -&gt;</span>
    <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;cache&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Paginator</span><span class="p">.</span><span class="nx">Cache</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">limit</span><span class="p">,</span> <span class="nx">items</span><span class="p">))</span>
  <span class="nx">@accessor</span> <span class="s1">&#39;toArray&#39;</span><span class="p">,</span> <span class="err">@</span><span class="o">::</span><span class="nx">toArray</span>
  <span class="nx">@accessor</span> <span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="s1">&#39;totalCount&#39;</span>
    <span class="nv">get: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">defaultAccessor</span><span class="p">.</span><span class="nx">get</span>
    <span class="nv">set: </span><span class="nf">(key, value) -&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">defaultAccessor</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="o">+</span><span class="nx">value</span><span class="p">)</span>
  <span class="nx">@accessor</span> <span class="s1">&#39;page&#39;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="err">@</span><span class="o">::</span><span class="nx">page</span>
    <span class="nv">set: </span><span class="nf">(_,value) -&gt;</span>
      <span class="nv">value = </span><span class="o">+</span><span class="nx">value</span>
      <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="nx">@offsetFromPageAndLimit</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">)))</span>
      <span class="nx">value</span>
  <span class="nx">@accessor</span> <span class="s1">&#39;pageCount&#39;</span><span class="p">,</span> <span class="err">@</span><span class="o">::</span><span class="nx">pageCount</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ModelPaginator</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Paginator</span>
  <span class="nv">cachePadding: </span><span class="mi">0</span>
  <span class="nv">paddedOffset: </span><span class="nf">(offset) -&gt;</span>
    <span class="nx">offset</span> <span class="o">-=</span> <span class="nx">@cachePadding</span>
    <span class="k">if</span> <span class="nx">offset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="nx">offset</span>
  <span class="nv">paddedLimit: </span><span class="nf">(limit) -&gt;</span>
    <span class="nx">limit</span> <span class="o">+</span> <span class="nx">@cachePadding</span> <span class="o">*</span> <span class="mi">2</span>

  <span class="nv">loadItemsForOffsetAndLimit: </span><span class="nf">(offset, limit) -&gt;</span>
    <span class="nv">params = </span><span class="nx">@paramsForOffsetAndLimit</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">limit</span><span class="p">)</span>
    <span class="nx">params</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">@params</span>
    <span class="nx">@model</span><span class="p">.</span><span class="nx">load</span> <span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">records</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">unless</span> <span class="nx">err</span><span class="o">?</span>
        <span class="nx">@updateCache</span><span class="p">(</span><span class="nx">@offsetFromParams</span><span class="p">(</span><span class="nx">params</span><span class="p">),</span> <span class="nx">@limitFromParams</span><span class="p">(</span><span class="nx">params</span><span class="p">),</span> <span class="nx">records</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-243">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-243">&#182;</a>               </div>               <p>override these to fetch records however you like:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">paramsForOffsetAndLimit: </span><span class="nf">(offset, limit) -&gt;</span>
    <span class="nv">offset: </span><span class="nx">@paddedOffset</span><span class="p">(</span><span class="nx">offset</span><span class="p">),</span> <span class="nv">limit: </span><span class="nx">@paddedLimit</span><span class="p">(</span><span class="nx">limit</span><span class="p">)</span>
  <span class="nv">offsetFromParams: </span><span class="nf">(params) -&gt;</span> <span class="nx">params</span><span class="p">.</span><span class="nx">offset</span>
  <span class="nv">limitFromParams: </span><span class="nf">(params) -&gt;</span> <span class="nx">params</span><span class="p">.</span><span class="nx">limit</span></pre></div>             </td>           </tr>                               <tr id="section-244">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-244">&#182;</a>               </div>               <p>Export a few globals, and grab a reference to an object accessible from all contexts for use elsewhere.
In node, the container is the <code>global</code> object, and in the browser, the container is the window object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">container = </span><span class="k">if</span> <span class="nx">exports</span><span class="o">?</span>
  <span class="nv">module.exports = </span><span class="nx">Batman</span>
  <span class="nx">global</span>
<span class="k">else</span>
  <span class="nb">window</span><span class="p">.</span><span class="nv">Batman = </span><span class="nx">Batman</span>
  <span class="nb">window</span>

<span class="nx">$mixin</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span></pre></div>             </td>           </tr>                               <tr id="section-245">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-245">&#182;</a>               </div>               <p>Optionally export global sugar. Not sure what to do with this.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.exportHelpers = </span><span class="nf">(onto) -&gt;</span>
  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;mixin&#39;</span><span class="p">,</span> <span class="s1">&#39;unmixin&#39;</span><span class="p">,</span> <span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="s1">&#39;redirect&#39;</span><span class="p">,</span> <span class="s1">&#39;typeOf&#39;</span><span class="p">,</span> <span class="s1">&#39;redirect&#39;</span><span class="p">,</span> <span class="s1">&#39;setImmediate&#39;</span><span class="p">]</span>
    <span class="nx">onto</span><span class="p">[</span><span class="s2">&quot;$#{k}&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Batman</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
  <span class="nx">onto</span>

<span class="nv">Batman.exportGlobals = </span><span class="nf">() -&gt;</span>
  <span class="nx">Batman</span><span class="p">.</span><span class="nx">exportHelpers</span><span class="p">(</span><span class="nx">container</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>          <div id="projectname"><a href="../readme.html">batman.js</a></div>        </div> </body> </html>  